<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦 – 虚拟化管理</title><link>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/</link><description>Recent content in 虚拟化管理 on 断念梦</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Libvirt</title><link>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/libvirt/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/libvirt/</guid><description>
&lt;h1 id="概述">概述&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/libvirt">GitHub 组织，libvirt&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://libvirt.org/">官网&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Libvirt 是用于管理虚拟化平台的开源的 API，后台程序和管理工具。它可以用于管理 KVM、Xen、VMware ESX，QEMU 和其他虚拟化技术。
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gglb2f/1616123800173-58542239-2205-4586-bcc0-4edde6579a3f.png" alt="">
Libvirt 提供了管理虚拟机和其它虚拟化功能（如：存储和网络接口等）的便利途径。这些软件包括：一个长期稳定的 C 语言 API、一个守护进程（libvirtd）和一个命令行工具（virsh）。Libvirt 的主要目标是提供一个单一途径以管理不同类型的虚拟化环境(也称为 drivers 或者 hypervisors )，包括：KVM/QEMU，Xen，VMware， VirtualBox hypervisors，LXC，OpenVZ&lt;/p>
&lt;p>Libvirt 包含 3 个东西：libvirtd、API、virsh&lt;/p>
&lt;ul>
&lt;li>libvirtd # 是守护进程，服务程序，接收和处理 API 请求&lt;/li>
&lt;li>API # 库使得其他人可以开发基于 Libvirt 的高级工具，比如 virt-manager、virt-install、virt-viewer 等。&lt;/li>
&lt;li>virsh # 是我们经常要用的命令行工具&lt;/li>
&lt;/ul>
&lt;p>Note：其实 libvirtd 在绝大部分情况下是与 qemu/kvm 相搭配来使用，都是开源的，并且 redhat 官方推荐的也是使用 libvirt 管理 kvm 虚拟机&lt;/p>
&lt;h2 id="libvirt-原理">Libvirt 原理&lt;/h2>
&lt;p>libvirt 支持不同的虚拟化类型，所以需要一种方法来指定所要连接的虚拟化驱动。&lt;/p>
&lt;p>libvirt 使用 URI 来与各种类型的虚拟化程序连接。官方文档：&lt;a href="https://libvirt.org/uri.html">https://libvirt.org/uri.html&lt;/a>&lt;/p>
&lt;p>libvirt 将使用以下逻辑来确定要使用的 URI。&lt;/p>
&lt;ul>
&lt;li>环境变量 LIBVIRT_DEFAULT_URI&lt;/li>
&lt;li>客户端配置文件 uri_default 参数&lt;/li>
&lt;li>依次探查每个虚拟机监控程序，直到找到有效的虚拟机监控程序&lt;/li>
&lt;/ul>
&lt;h1 id="libvirt-关联文件与配置">Libvirt 关联文件与配置&lt;/h1>
&lt;p>&lt;strong>/etc/libvirt/*&lt;/strong> #&lt;/p>
&lt;ul>
&lt;li>&lt;strong>./libvirt.conf&lt;/strong> #用于配置用于与虚拟化程序连接的 URI 别名，以及默认 URI&lt;/li>
&lt;li>.&lt;strong>/libvirtd.conf&lt;/strong> #libvirtd 守护进程的配置文件&lt;/li>
&lt;li>.&lt;strong>/qemu/*&lt;/strong> # xml 格式的配置文件存放路径，配置文件包括该 VM 的元数据(名字，uuid，内存，cpu 等)，设备配置(包括使用的硬盘文件的路径，网络类型等)，配置文件为 xml 格式。创建完一台 VM 后，会在该目录下生成对应 VM 名字的 xml 文件&lt;/li>
&lt;li>&lt;strong>./network/*&lt;/strong> #&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/etc/sysconfig/*&lt;/strong> #&lt;/p>
&lt;ul>
&lt;li>&lt;strong>./libvirtd&lt;/strong> #&lt;/li>
&lt;/ul>
&lt;p>**/var/lib/libvirt/* **#&lt;/p>
&lt;ul>
&lt;li>**./images/* **# 所有通过 libvirt 创建的虚拟机所生成的 images 都保存在该目录下&lt;/li>
&lt;li>**./qemu/snapshot/* **# 创建快照 xml 文件都保存在该目录下&lt;/li>
&lt;/ul>
&lt;h1 id="heading">&lt;/h1></description></item><item><title>Docs: Libvirt</title><link>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/libvirt/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/libvirt/</guid><description/></item><item><title>Docs: 克隆与批量创建虚拟机</title><link>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E5%85%8B%E9%9A%86%E4%B8%8E%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E5%85%8B%E9%9A%86%E4%B8%8E%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA/</guid><description>
&lt;h1 id="概述">概述&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/cloning-a-vm">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/cloning-a-vm&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>注意：CentOS7 想要挂载 Ubuntu 20.04 虚拟机内的文件是不行的，内核不支持，报错如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#f92672">]&lt;/span>&lt;span style="color:#75715e"># guestmount --rw -a /var/lib/libvirt/images/common-ubuntu-test.bj-test.qcow2 -m /dev/ubuntu-vg/lv-0 /mnt/test&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>libguestfs: error: mount_options: mount exited with status 32: mount: wrong fs type, bad option, bad superblock on /dev/mapper/ubuntu--vg-lv--0,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> missing codepage or helper program, or other error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> In some cases useful info is found in syslog - try
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dmesg | tail or so.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>guestmount: ‘/dev/ubuntu-vg/lv-0’ could not be mounted.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>guestmount: Did you mean to mount one of these filesystems?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>guestmount: /dev/sda1 &lt;span style="color:#f92672">(&lt;/span>unknown&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>guestmount: /dev/sda2 &lt;span style="color:#f92672">(&lt;/span>xfs&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>guestmount: /dev/ubuntu-vg/lv-0 &lt;span style="color:#f92672">(&lt;/span>xfs&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其他依赖挂载的命令都是这种报错，比如 virt-sysprep、virt-edit 等等&lt;/p>
&lt;p>通过 virt-sysprep 传送网络设备的配置文件？&lt;/p>
&lt;h1 id="修改-vm-的-ip">修改 VM 的 IP&lt;/h1></description></item><item><title>Docs: 虚拟化调试和优化指南</title><link>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E8%99%9A%E6%8B%9F%E5%8C%96%E8%B0%83%E8%AF%95%E5%92%8C%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/it%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E4%BA%91%E5%8E%9F%E7%94%9F/1.2.%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E8%99%9A%E6%8B%9F%E5%8C%96%E8%B0%83%E8%AF%95%E5%92%8C%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/</guid><description>
&lt;h1 id="虚拟化调试和优化指南">虚拟化调试和优化指南&lt;/h1>
&lt;p>红帽官方的推荐方案，中文：&lt;a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index&lt;/a>&lt;/p>
&lt;h2 id="配置网卡多队列">配置网卡多队列&lt;/h2>
&lt;p>&lt;a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-Networking-Multi-queue_virtio-net">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-Networking-Multi-queue_virtio-net&lt;/a>
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/un2vm8/1616123000773-caaef550-ee28-43b8-94eb-417936b2e088.jpeg" alt="">&lt;/p>
&lt;h2 id="配置磁盘缓存">配置磁盘缓存&lt;/h2>
&lt;p>&lt;a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-BlockIO-Caching">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-BlockIO-Caching&lt;/a>..
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/un2vm8/1616123000746-e6a1ffde-9736-4cd9-a115-0449b16ef631.jpeg" alt="">
经测试
node 类型 dd 命令速度为 不到 500MB/s
writeback 类型 de 命令速度为 不到 300MB/s&lt;/p>
&lt;h1 id="网卡软中断过高问题">网卡软中断过高问题&lt;/h1>
&lt;p>原文连接：&lt;a href="http://www.simlinux.com/archives/1798.html">http://www.simlinux.com/archives/1798.html&lt;/a>&lt;/p>
&lt;h2 id="问题背景">问题背景&lt;/h2>
&lt;p>游戏网关高峰期时出网络丢包,CPU0 软中断%sys 高达 90%。
这意思就是说多个 CPU 中，只有 1 个来处理软中断信号&lt;/p>
&lt;h2 id="解决思路">解决思路：&lt;/h2>
&lt;p>让多个 CPU 平均处理中断的信号&lt;/p>
&lt;p>在虚拟机中，默认一个网卡收到的消息，只由 1 个 CPU 来处理，所以需要修改配置来让该网卡可以把数据交给多个 CPU 进行处理&lt;/p>
&lt;h2 id="解决方式">解决方式：&lt;/h2>
&lt;p>virsh edit &amp;lt;虚拟机名称&amp;gt; #修改磁盘缓存策略&lt;/p>
&lt;pre>&lt;code> &amp;lt;disk type='file' device='disk'&amp;gt;
&amp;lt;driver name='qemu' type='qcow2' cache='none'/&amp;gt; # 添加cache='none'
&amp;lt;source file='/var/lib/libvirt/images/iptv-unc-haproxy-1.qcow2'/&amp;gt;
&amp;lt;target dev='vda' bus='virtio'/&amp;gt;
&amp;lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&amp;gt;
&amp;lt;/disk&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>virsh edit &amp;lt;虚拟机名称&amp;gt; #修改网卡队列&lt;/p>
&lt;pre>&lt;code> &amp;lt;interface type='bridge'&amp;gt;
&amp;lt;mac address='52:54:00:c9:f1:82'/&amp;gt;
&amp;lt;source bridge='br1.20'/&amp;gt;
&amp;lt;model type='virtio'/&amp;gt;
&amp;lt;driver name='vhost' queues='8'/&amp;gt; # 添加该行
&amp;lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&amp;gt;
&amp;lt;/interface&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>ethtool -L eth0 combined 8 #修改实际队列&lt;/p>
&lt;p>可以使用 ethtool -l eth0 来查看 eth0 网卡的队列数，收到的数据是由几个 cpu 进行处理的&lt;/p></description></item></channel></rss>