<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – Rsyslog</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/</link><description>Recent content in Rsyslog on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: RsysLog 配置</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/RsysLog-%E9%85%8D%E7%BD%AE/</link><pubDate>Fri, 06 Nov 2020 17:32:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/RsysLog-%E9%85%8D%E7%BD%AE/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man5/rsyslog.conf.5.html">Manual(手册), rsyslog.conf(5)&lt;/a>&lt;/li>
&lt;li>本笔记中的 Facility 概念见 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.md#Facility(%E8%AE%BE%E6%96%BD)">日志系统&lt;/a> 中 Facility(设施) 的介绍&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Rsyslog 已经发展了几十年。因此有多种不同格式进行配置&lt;/p>
&lt;ul>
&lt;li>&lt;strong>basic&lt;/strong> # 以前称为 sysklogd 格式。这种格式最适合在单独一行上表达基本配置，源于原始的 syslog.conf 格式。最常见的用例是匹配设施/严重性并将匹配消息写入日志文件。&lt;/li>
&lt;li>&lt;strong>advanced&lt;/strong> # 以前称为 RainerScript 格式。这种格式首先在 rsyslog v6 中提供，对于需要多行的重要用例来说是最好、最精确的格式。此格式专为高级用例而设计，例如转发到可能部分离线的远程主机。&lt;/li>
&lt;li>&lt;strong>obsolete legacy&lt;/strong> # 过失的遗留格式。在编写新配置时不应该使用。&lt;/li>
&lt;/ul>
&lt;h2 id="rainerscript">RainerScript&lt;a class="td-heading-self-link" href="#rainerscript" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;a href="https://www.rsyslog.com/doc/rainerscript/index.html">https://www.rsyslog.com/doc/rainerscript/index.html&lt;/a>&lt;/p>
&lt;p>RainerScript 是一种专门设计的脚本语言，非常适合处理网络事件和配置事件处理器。它是 rsyslog 使用的主要配置语言。请注意，RainerScript 可能不会缩写为 rscript，因为那是别人的商标。&lt;/p>
&lt;p>自 rsyslog 3.12.0 起提供了一些有限的 RainerScript 支持（用于表达式支持）。在 v5 中，支持“if .. then”语句。自 rsyslog v6 以来，第一个完整的实现可用。&lt;/p>
&lt;h3 id="data-types">Data Types&lt;a class="td-heading-self-link" href="#data-types" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="expressions">Expressions&lt;a class="td-heading-self-link" href="#expressions" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="functions">Functions&lt;a class="td-heading-self-link" href="#functions" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="control-structures">Control Structures&lt;a class="td-heading-self-link" href="#control-structures" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="objects">Objects&lt;a class="td-heading-self-link" href="#objects" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h1 id="modules-模块配置">MODULES 模块配置&lt;a class="td-heading-self-link" href="#modules-%e6%a8%a1%e5%9d%97%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/index.html">https://www.rsyslog.com/doc/configuration/modules/index.html&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>配置文件新老版本有两种格式，下面这两种写法，都可以表示让 Rsyslog 加载 imuxsock 模块&lt;/p>
&lt;ul>
&lt;li>&lt;strong>$ModLoad imuxsock&lt;/strong> # 老版本语法&lt;/li>
&lt;li>&lt;strong>module(load=&amp;ldquo;imuxsock&amp;rdquo;)&lt;/strong> # 新版本语法&lt;/li>
&lt;/ul>
&lt;p>更多模块配置详情见 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/Module.md">Module&lt;/a>&lt;/p>
&lt;h1 id="global-directives-全局指令配置">GLOBAL DIRECTIVES 全局指令配置&lt;a class="td-heading-self-link" href="#global-directives-%e5%85%a8%e5%b1%80%e6%8c%87%e4%bb%a4%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>配置 rsyslogd 的全局属性，比如主信息队列大小等&lt;/p>
&lt;h1 id="template-模板配置">TEMPLATE 模板配置&lt;a class="td-heading-self-link" href="#template-%e6%a8%a1%e6%9d%bf%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>该配置用于自定义日志的保存路径，日志格式，可以动态生成文件名等信息。定义后，可以在 RULE 中进行引用，该指令用法详见&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 定义一个Location字段的模板，第一个是老版本的定义方法，第二个是新版的定义方法&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$template&lt;/span> RemoteLogs,&lt;span style="color:#4e9a06">&amp;#34;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&amp;#34;&lt;/span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>template &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;RemoteLogs&amp;#34;&lt;/span> &lt;span style="color:#000">type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;string&amp;#34;&lt;/span> &lt;span style="color:#000">string&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="template-模板介绍">TEMPLATE 模板介绍&lt;a class="td-heading-self-link" href="#template-%e6%a8%a1%e6%9d%bf%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>template 是 rsyslog 的一个关键功能，可以允许用户指定想要的任何日志格式。e.g.自定义日志的保存路径，日志格式。还可以动态生成文件名等信息&lt;/p>
&lt;p>template 有两种表示方式：&lt;/p>
&lt;ul>
&lt;li>7.0 之前的版本使用 $template&lt;/li>
&lt;li>7.0 之后的版本使用 template()&lt;/li>
&lt;/ul>
&lt;h3 id="语法结构templateparameters">语法结构：template(Parameters)&lt;a class="td-heading-self-link" href="#%e8%af%ad%e6%b3%95%e7%bb%93%e6%9e%84templateparameters" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>Parameters 必须包含 name 字段且 name 唯一，并指明类型，以及该类型的具体内容&lt;/p>
&lt;p>template(NAME TYPE Descriptions)&lt;/p>
&lt;ol>
&lt;li>TYPE
&lt;ol>
&lt;li>list&lt;/li>
&lt;li>subtree&lt;/li>
&lt;li>string&lt;/li>
&lt;li>plugin&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>EXAMPLE
&lt;ol>
&lt;li>template (name=&amp;ldquo;RemoteLogs&amp;rdquo; type=&amp;ldquo;string&amp;rdquo; string=&amp;quot;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&amp;quot;)&lt;/li>
&lt;li>:programname, regex, &amp;ldquo;Keepalived.*&amp;rdquo; -/var/log/keepalived/keepalived.log # 根据程序名字，使用正则表达式，开头是 Keepalived 的日志，写入到/var/log/keepalived/keepalived.log 文件中&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>可用的属性详见：&lt;a href="https://www.rsyslog.com/doc/v8-stable/configuration/properties.html">https://www.rsyslog.com/doc/v8-stable/configuration/properties.html&lt;/a>&lt;/p>
&lt;p>$template NAME,&amp;ldquo;PATH&amp;rdquo; # 定义一个名为 NAME 的模板来作为 RULE 配置段中 Location 字段使用，在 Location 字段中通过?NAME 来引用该对应模板&lt;/p>
&lt;ul>
&lt;li>PATH 的可用变量
&lt;ul>
&lt;li>&lt;code>%HOSTNAME%&lt;/code> # 用来区分是哪台远程主机的。&lt;/li>
&lt;li>&lt;code>%PROGRAMNAME%&lt;/code> # 通过日志标准格式中的 ProgramName 字段来进行分类保存日志。i.e.每个程序名是单独的一个文件&lt;/li>
&lt;li>&lt;code>%$year%%$month%%$day%&lt;/code> # 用来以时间格式命名文件&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="rules-规则配置">RULES 规则配置&lt;a class="td-heading-self-link" href="#rules-%e8%a7%84%e5%88%99%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Rules 配置段是 rsyslog 程序得以正常运行的最基础配置。规则的内容是告诉 rsyslog 处理日志的方式。i.e.每条规则用于定义以下几个内容：1.什么设施的。2.什么优先级。3.需要被记录在哪里&lt;/p>
&lt;p>每条规则占用一行，规则的内容分为两个字段：Selector(选择器)和 Action(动作 i.e.即对选择器选择出来的设施和优先级进行什么操作)。这两个字段由一个或多个空格或者制表符分割。而 Selector 则是通过 Facility(设施)、分隔符、Priority(优先级，也可以用 Level(级别)来表示)来对整个系统的所有设施日志进行筛选&lt;/p>
&lt;h3 id="syntax语法">Syntax(语法)&lt;a class="td-heading-self-link" href="#syntax%e8%af%ad%e6%b3%95" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>Selector Action&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Selector(选择器)&lt;/strong># 根据匹配规则，选择要处理的日志。选择器由 Facility 和 Priority 组成，以 &lt;code>.&lt;/code> 分隔
&lt;ul>
&lt;li>&lt;strong>Facility.Priority&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Action(动作)&lt;/strong> # 描述了如何处理选择器选择出来的日志信息&lt;/li>
&lt;/ul>
&lt;h4 id="selectors选择器">Selectors(选择器)&lt;a class="td-heading-self-link" href="#selectors%e9%80%89%e6%8b%a9%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h4>
&lt;p>多个选择器以 &lt;code>;&lt;/code> 符号分隔&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Facility(设施)&lt;/strong> # Facility 定义了 rsyslog 可以选择的设施都有哪些(注：该字段用 * 表示则表示所有支持的 Facility)。多个 Facility 以 &lt;code>,&lt;/code> 分隔&lt;/li>
&lt;li>&lt;strong>匹配符号&lt;/strong> # 除了 &lt;code>.&lt;/code> 还可以使用另外两个符号来进行更细致的匹配。
&lt;ul>
&lt;li>&lt;code>.&lt;/code> # 选择包含且比 Prority 还要严重的优先级&lt;/li>
&lt;li>&lt;code>.=&lt;/code> # 仅选择包含 Prority 所定义的优先级&lt;/li>
&lt;li>&lt;code>.!&lt;/code> # 选择不包含 Prority 中所定义的优先级的其余优先级&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Priority(日志的优先级，也可以叫日志的 Level 级别)&lt;/strong> # Priority 定义了每条信息的严重程度，下面以严重程度从高到低进行排序。括号中的数字指级别(注：该字段用 &lt;code>*&lt;/code> 表示所有级别)
&lt;ul>
&lt;li>emerg(0)：错误信息。最严重日志等级，意味着系统将要宕机&lt;/li>
&lt;li>alert(1)：错误信息。比 emerg 等级轻&lt;/li>
&lt;li>crit(2)：错误信息。&lt;/li>
&lt;li>err(3)：错误信息。err 就是 error&lt;/li>
&lt;li>warn(4)：警告信息。可能有问题，但是还不至于影响到程序的运行。warn 就是 warnning&lt;/li>
&lt;li>notice(5)：基本信息。&lt;/li>
&lt;li>info(6)：基本信息。&lt;/li>
&lt;li>debug(7)：特殊的等级，用来 troubleshooting 时产生的日志&lt;/li>
&lt;li>none：特殊的等级。表示某个 Facility 不需要执行 Action。i.e.即不记录的级别&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="action动作">Action(动作)&lt;a class="td-heading-self-link" href="#action%e5%8a%a8%e4%bd%9c" aria-label="Heading self-link">&lt;/a>&lt;/h4>
&lt;p>匹配到的日志将要执行的动作。是保存本地文件、打印、保存到远程主机、转存到数据库中等等行为&lt;/p>
&lt;ul>
&lt;li>&lt;strong>RegularFile(常规文件)&lt;/strong> # 把日志写入到某个文件，文件路径可以引用模板。
&lt;ul>
&lt;li>如果在该字段前面记上 &lt;code>-&lt;/code>，则表示先将日志保存在内存的 buffer 中，等数据量足够大时再一次性将数据写入磁盘文件中。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>RemoteMachine(远程主机)&lt;/strong> # &lt;code>@HOST&lt;/code> 或者 &lt;code>@@HOST&lt;/code>。用于把日志发送给远程主机。@使用 UDP 协议，@@使用 TCP 协议，默认使用 514 端口&lt;/li>
&lt;li>*，表示把日志发送给目前在线的所有人，类似于 wall 命令&lt;/li>
&lt;li>| COMMAND：用于把日志信息通过管道符送给后面定义的 COMMAND 来进行处理&lt;/li>
&lt;li>打印机或其他。&lt;/li>
&lt;li>使用者名称(显示给用户)。&lt;/li>
&lt;li>&lt;strong>stop&lt;/strong> # Discard(丢弃)，老版本使用 &lt;code>~&lt;/code> 表示&lt;/li>
&lt;/ul>
&lt;h3 id="centos-系统中的默认配置示例">CentOS 系统中的默认配置示例&lt;a class="td-heading-self-link" href="#centos-%e7%b3%bb%e7%bb%9f%e4%b8%ad%e7%9a%84%e9%bb%98%e8%ae%a4%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 内核产生的日志全部送入到终端设施中，用于在系统出现严重问题，无法使用默认屏幕观察，可以使用笔记本连接到封闭服务器的RS232端口后，查看日志&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># kern.* /dev/console&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 除了mail、authpriv、cron以外的优先级为info且以上的所有设施的信息写入/var/log/messages文件中，Action字段以绝对的路径表示&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.info&lt;span style="color:#000;font-weight:bold">;&lt;/span>mail.none&lt;span style="color:#000;font-weight:bold">;&lt;/span>authpriv.none&lt;span style="color:#000;font-weight:bold">;&lt;/span>cron.none /var/log/messages
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 认证方面的日志写入/var/log/secure文件中&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>authpriv.* /var/log/secure
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 同上，用于邮件相关日志。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mail.* -/var/log/maillog
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8f5902;font-style:italic"># 同上，用于定时任务相关日志&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cron.* /var/log/cron
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 任何优先级为emerg的设施日志以wall广播的方式给所有在系统登录的账号&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.emerg :omusrmsg:*
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 将uucp和news的等级为crit且以上的日志写入spooler文件中&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>uucp,news.crit /var/log/spooler
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># local7这个设施的所有优先级的日志写到/var/log/boot.log文件中&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>local7.* /var/log/boot.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 下面是对Rule的应用实例：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 除了sshd、keepalived、haproxy程序的日志以外，其余所有程序的所有等级的日志保存在/var/log/messages文件中&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.*&lt;span style="color:#000;font-weight:bold">;&lt;/span>sshd,keepalived,haproxy.none /var/log/messages
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 将local2设施的所有级别的日志写入名为RemoteLogs模板定义的文件中，Action字段引用模板RemoteLogs的路径&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>local2.* ?RemoteLogs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 以下符号用来告知 rsyslog 停止对日志消息的进一步处理，即只把日志写入指定的路径中，而不再重复写到默认的 /var/log/* 目录下&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span> stop &lt;span style="color:#8f5902;font-style:italic"># 注意，该指令仅对其上面一行的规则起作用，想让哪一条的规则生效，则在哪一行下面加上该组符号&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 把所有程序的所有级别的日志发送给192.168.10.10这台机器上，Action字段为远程主机&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.* @@192.168.10.10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 丢弃所有日志,Action字段为丢弃&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.* stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 来自于远程主机的日志，不包括本机的日志全部写入到RemoteLogs模板定义的路径中&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>:FROMHOST-IP, !isequal, &lt;span style="color:#4e9a06">&amp;#34;127.0.0.1&amp;#34;&lt;/span> -?RemoteLogs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="outputs---输出">outputs - 输出&lt;a class="td-heading-self-link" href="#outputs---%e8%be%93%e5%87%ba" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h1 id="配置实例">配置实例&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e5%ae%9e%e4%be%8b" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="利用-logger-程序验证配置效果">利用 logger 程序验证配置效果&lt;a class="td-heading-self-link" href="#%e5%88%a9%e7%94%a8-logger-%e7%a8%8b%e5%ba%8f%e9%aa%8c%e8%af%81%e9%85%8d%e7%bd%ae%e6%95%88%e6%9e%9c" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>ping 10.10.11.49 &lt;span style="color:#000;font-weight:bold">|&lt;/span> logger -it logger_test -p local4.notice
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将 ping 10.10.11.49 命令的输出写入到 local4.notice，只要 Rsyslog 设置了 local4 的接收方式，就可以通过查看对应的文件验证 Rsyslog 是否可以正常处理日志&lt;/p>
&lt;h2 id="实例一设置一台主机为日志服务器可以收集其余网络上的主机的日志信息">实例一：设置一台主机为日志服务器，可以收集其余网络上的主机的日志信息&lt;a class="td-heading-self-link" href="#%e5%ae%9e%e4%be%8b%e4%b8%80%e8%ae%be%e7%bd%ae%e4%b8%80%e5%8f%b0%e4%b8%bb%e6%9c%ba%e4%b8%ba%e6%97%a5%e5%bf%97%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%8f%af%e4%bb%a5%e6%94%b6%e9%9b%86%e5%85%b6%e4%bd%99%e7%bd%91%e7%bb%9c%e4%b8%8a%e7%9a%84%e4%b8%bb%e6%9c%ba%e7%9a%84%e6%97%a5%e5%bf%97%e4%bf%a1%e6%81%af" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>日志服务器与其余服务器形成服务端与客户端的关系，服务端的日志服务监听某个端口，来收集其余机器发送过来的日志信息&lt;/p>
&lt;p>Server 端：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$ModLoad&lt;/span> imtcp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$InputTCPServerRun&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">514&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$template&lt;/span> RemoteLogs,&lt;span style="color:#4e9a06">&amp;#34;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&amp;#34;&lt;/span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.* ?RemoteLogs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span> stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>:FROMHOST-IP, !isequal, &amp;ldquo;127.0.0.1&amp;rdquo; -?DynaFile&lt;/p>
&lt;p>client 端：&lt;/p>
&lt;p>在日志规则的 Location 配置段使用远程主机配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>*.* @@192.168.10.10 &lt;span style="color:#8f5902;font-style:italic">#把所有程序的所有级别的日志发送给192.168.10.10这台机器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>注意：如果使用UDP进行传输，则使用1个@
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="实例二配置-keepalived-程序的日志到指定的目录">实例二：配置 keepalived 程序的日志到指定的目录&lt;a class="td-heading-self-link" href="#%e5%ae%9e%e4%be%8b%e4%ba%8c%e9%85%8d%e7%bd%ae-keepalived-%e7%a8%8b%e5%ba%8f%e7%9a%84%e6%97%a5%e5%bf%97%e5%88%b0%e6%8c%87%e5%ae%9a%e7%9a%84%e7%9b%ae%e5%bd%95" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>直接使用实例一 Server 端的后三条配置即可&lt;/p>
&lt;h2 id="实例三根据正则匹配忽略某些日志信息写入到文件中">实例三：根据正则匹配忽略某些日志信息写入到文件中&lt;a class="td-heading-self-link" href="#%e5%ae%9e%e4%be%8b%e4%b8%89%e6%a0%b9%e6%8d%ae%e6%ad%a3%e5%88%99%e5%8c%b9%e9%85%8d%e5%bf%bd%e7%95%a5%e6%9f%90%e4%ba%9b%e6%97%a5%e5%bf%97%e4%bf%a1%e6%81%af%e5%86%99%e5%85%a5%e5%88%b0%e6%96%87%e4%bb%b6%e4%b8%ad" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>下面的配置表示：如果输出日志的程序为 kubelet，并且日志信息中包含 Setting volume ownership 这种内容，那么所有匹配到的日志全部丢弃，不写入到文件中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/rsyslog.d/ignore-kubelet-volume.conf &lt;span style="color:#4e9a06">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">if (\$programname == &amp;#34;kubelet&amp;#34;) and (\$msg contains &amp;#34;Setting volume ownership&amp;#34;) then {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> stop
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: Module</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/Module/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/Module/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/index.html">官方文档，模块&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>在配置模块时，可以会利用各种 Rsyslog &lt;a href="https://www.rsyslog.com/doc/rainerscript/configuration_objects.html#objects">objects&lt;/a>(对象) 对模块进行更多配置，比如 input、&lt;a href="https://www.rsyslog.com/doc/configuration/actions.html">action&lt;/a>、etc. 这些对象。&lt;/p>
&lt;blockquote>
&lt;p>objects 的概念是 Rsyslog 设计的 RainerScript 脚本语言中的。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;strong>module&lt;/strong> 对象 # 用于加载模块&lt;/li>
&lt;li>&lt;strong>input&lt;/strong> 对象 # 用于描述 Input 行为的主要手段，用于收集 rsyslog 处理的消息。&lt;/li>
&lt;li>&lt;strong>action&lt;/strong> 对象 # TODO&lt;/li>
&lt;li>TODO&lt;/li>
&lt;/ul>
&lt;p>在阅读各种模块文档时，通常能看到这种标题，这部分内容就是在说利用 input 对象对该模块进行配置。&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/observability/rsyslog/202411072158977.png" alt="">&lt;/p>
&lt;p>比如我 &lt;code>module(load=&amp;quot;imuxsock&amp;quot;)&lt;/code> 这样加载了 imuxsock 模块，然后可以这样 &lt;code>input(type=&amp;quot;imuxsock&amp;quot; Socket=&amp;quot;/root/tmp/log&amp;quot;)&lt;/code> 利用 input 对象控制 imuxsock 模块的行为。Socket 参数是告诉 imuxsock 模块要在 /root/tmp/log 文件处监听 Unix Socket。&lt;/p>
&lt;p>还有类似这样的标题: &lt;code>Action Parameters&lt;/code>，这就是在说可以利用 action 对象对该模块进行配置。&lt;/p>
&lt;h1 id="output-模块">Output 模块&lt;a class="td-heading-self-link" href="#output-%e6%a8%a1%e5%9d%97" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/idx_output.html">https://www.rsyslog.com/doc/configuration/modules/idx_output.html&lt;/a>&lt;/p>
&lt;h1 id="input-模块">Input 模块&lt;a class="td-heading-self-link" href="#input-%e6%a8%a1%e5%9d%97" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/idx_input.html">https://www.rsyslog.com/doc/configuration/modules/idx_input.html&lt;/a>&lt;/p>
&lt;p>Input 模块用于从各种来源收集消息。它们与消息生成器交互。它们通常是通过输入配置对象定义的。如果要配置具体的输入参数，通常是利用 input 对象实现的。&lt;/p>
&lt;h2 id="imuxsock">imuxsock&lt;a class="td-heading-self-link" href="#imuxsock" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/imuxsock.html">https://www.rsyslog.com/doc/configuration/modules/imuxsock.html&lt;/a>&lt;/p>
&lt;p>配置示例： &lt;a href="https://www.rsyslog.com/doc/configuration/modules/imuxsock.html#examples">https://www.rsyslog.com/doc/configuration/modules/imuxsock.html#examples&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 加载 imuxsock 模块，以便让 Rsyslog 可以监听 /dev/log 这个 Unix Socket 以接收日志消息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>module&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000">load&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;imuxsock&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 为 imuxsock 模块添加 input 参数，多监听一个 /root/tmp/log 这个 Unix Socket。发送到这里的消息也会被 Rsyslog 处理&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>input&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000">type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;imuxsock&amp;#34;&lt;/span> &lt;span style="color:#000">Socket&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;/root/tmp/log&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="imjournal">imjournal&lt;a class="td-heading-self-link" href="#imjournal" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;a href="https://www.rsyslog.com/doc/configuration/modules/imjournal.html">https://www.rsyslog.com/doc/configuration/modules/imjournal.html&lt;/a>&lt;/p>
&lt;h2 id="远程输入相关模块">远程输入相关模块&lt;a class="td-heading-self-link" href="#%e8%bf%9c%e7%a8%8b%e8%be%93%e5%85%a5%e7%9b%b8%e5%85%b3%e6%a8%a1%e5%9d%97" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="imtcp">imtcp&lt;a class="td-heading-self-link" href="#imtcp" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>配置 TCP 协议的 syslog 接收，用于在日志服务器的时候配置&lt;/p>
&lt;ul>
&lt;li>&lt;strong>$ModLoad imtcp&lt;/strong> # 使用 tcp 进行传输&lt;/li>
&lt;li>&lt;strong>$InputTCPServerRun 514&lt;/strong> # 监听在 514 端口上&lt;/li>
&lt;/ul></description></item><item><title>Docs: Rsyslog</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/Rsyslog/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Rsyslog/Rsyslog/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.rsyslog.com/">官网&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.rsyslog.com/doc/v8-stable/configuration/modules/index.html">官方文档，配置 - 模块&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/rsyslog/rsyslog">GitHub 项目，rsyslog/rsyslog&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Rsyslog">Wiki, Rsyslog&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man3/syslog.3.html">Manual(手册), syslog(3)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man8/rsyslogd.8.html">Manual(手册), rsyslogd(8)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wiki.archlinux.org/title/Systemd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Journal_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Arch 文档，Systemd-Journal-配合 syslog 使用&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;strong>Rocket-fast system for log processing(像火箭一样快的日志处理系统，简称 rsyslog)&lt;/strong> 是一款开源应用程序，用于 &lt;a href="https://desistdaydream.github.io/docs/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Operating%20system/Unix-like%20OS/Unix-like%20OS.md">Unix-like OS&lt;/a>，可以在 IP 网络中转发日志消息。Rsyslog 实现了基本的 Syslog 协议，并扩展了丰富的功能，比如基于内容的过滤、排队处理离线输出、支持模块、灵活的配置、使用 TCP 传输 等等.&lt;/p>
&lt;p>RsysLog 是一个日志统一管理的程序。通过 rsyslogd 这个守护进程提供服务，rsyslogd 程序是对 syslogd 的扩展，提供了更多的功能和可靠性。&lt;/p>
&lt;p>Rsyslog 提供了一个符合 &lt;a href="https://datatracker.ietf.org/doc/html/rfc5424">RFC 5424&lt;/a> 标准的日志消息系统。&lt;/p>
&lt;p>RsysLog 的特点：&lt;/p>
&lt;ul>
&lt;li>可以监听在某个端口上作为日志服务器，来收集多个主机的日志&lt;/li>
&lt;li>RsysLog 自带多个模块，可以通过模块来实现更多的功能。以 im 开头的是在收集日志时候所用到的，以 om 开头的是在输出日志时用到的(比如把收集到的日志保存在某一文件中)。&lt;/li>
&lt;/ul>
&lt;p>Rsyslog 项目始于 2004 年，当时 rsyslog 的主要作者 Rainer Gerhards 决定编写一个新的强大的 syslog 守护进程来与 syslog-ng 竞争，因为根据作者的说法，“一个新的主要参与者将防止单一文化并提供丰富的选择自由。”&lt;/p>
&lt;h1 id="moules模块">Moules(模块)&lt;a class="td-heading-self-link" href="#moules%e6%a8%a1%e5%9d%97" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Rsyslog 采用模块化设计，可以通过加载模块来动态加载功能，模块也可以由任何第三方编写，只要符合 Rsyslog 规范即可。&lt;/p>
&lt;p>每个模块都有参数可以配置。&lt;/p>
&lt;h1 id="rsyslog-日志处理">Rsyslog 日志处理&lt;a class="td-heading-self-link" href="#rsyslog-%e6%97%a5%e5%bf%97%e5%a4%84%e7%90%86" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.rsyslog.com/doc/configuration/input.html">https://www.rsyslog.com/doc/configuration/input.html&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Rsyslog 要想处理日志，需要先收到日志才可以对吧？一般情况下，Rsyslog 会监听本地 Unix Socket，凡是将日志推送到该 Unix Socket 的数据都会被 Rsyslog 进行处理，这称之为 &lt;strong>&lt;a href="https://www.rsyslog.com/doc/configuration/input.html">Input&lt;/a>(输入)&lt;/strong>。Rsyslog 使用 &lt;a href="https://www.rsyslog.com/doc/configuration/modules/idx_input.html">input 模块&lt;/a> 实现 Input 能力（Tip: 有一个 &lt;strong>input 对象&lt;/strong> 可以对各种各样的 Input 模块进行配置。没有 input 则 Rsyslog 也不会进行任何处理，因为没有消息进入 Rsyslog 系统中。在配置时，input 关键字的参数根据其所关联的某个具体 Input 模块决定，只有一个 type 参数来指定要为哪个模块配置 input 行为）。&lt;/p>
&lt;p>默认情况下，Rsyslog 使用 input 模块中的 &lt;a href="https://www.rsyslog.com/doc/v8-stable/configuration/modules/imuxsock.html">&lt;strong>imuxscok&lt;/strong>&lt;/a> 模块监听本地 Unix Socket(&lt;code>默认为 /dev/log&lt;/code>) 以接收本地系统上运行的应用程序产生的 syslog 格式的日志消息。当该 Socket 收到消息时，会通过 syslog(3) 这里面所描述的系统调用将日志消息传递给 Rsyslogd。&lt;/p>
&lt;blockquote>
&lt;p>[!Attention]
在经过 &lt;a href="https://desistdaydream.github.io/docs/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Kernel/Process/Chroot.md">Chroot&lt;/a> 的目录中，需要创建用于 Rsyslog 监听的本地 Unix Socket，否则 Rsyslog 无法获取 Choot 后目录中的各种日志。e.g. &lt;a href="https://desistdaydream.github.io/docs/4.%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1/Utility/OpenSSH/SFTP%20Subsystem.md">SFTP Subsystem&lt;/a> 最佳实践部分的配置&lt;/p>
&lt;/blockquote>
&lt;p>这个模块在 Rsyslog 的配置文件中必须进行配置，因为没有它，本地日志记录将无法进行，因为没有监听任何 Unix Socket，任何程序发往 /dev/log 的消息，也就无法接收了。&lt;/p>
&lt;p>实际上，由于 syslog 协议是标准的，绝大部分编程语言，都可以通过自身或第三方实现的 syslog 库，将日志数据直接写到 syslog 的 Socket 中。下面用 go 举例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">package&lt;/span> &lt;span style="color:#000">main&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">import&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#4e9a06">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#4e9a06">&amp;#34;log/syslog&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">sysLog&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">syslog&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Dial&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>&lt;span style="color:#000">syslog&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">LOG_ERR&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;desistdaydream&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">log&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Fatal&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">sysLog&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Emerg&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>运行一下，查看日志，可以看到，进程名 desistdaydream，输出了一条日志消息&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tail -n 1 /var/log/syslog&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 23:46:03 hw-cloud-xngy-jump-server-linux-2 desistdaydream&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>3283&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>: Hello world!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此时如果同时在查看 /dev/log 文件，也可以看到同样的内容&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># socat - /dev/log&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Broadcast message from systemd-journald@hw-cloud-xngy-jump-server-linux-2 &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Tue 2021-10-19 23:49:24 HKT&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>desistdaydream&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>3820&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>: Hello world!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="验证-rsyslog-接收日志">验证 Rsyslog 接收日志&lt;a class="td-heading-self-link" href="#%e9%aa%8c%e8%af%81-rsyslog-%e6%8e%a5%e6%94%b6%e6%97%a5%e5%bf%97" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>看一下 rsyslog 进程打开的文件描述符&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># ll /proc/$(pgrep rsyslog)/fd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>total &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dr-x------ &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 ./
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dr-xr-xr-x &lt;span style="color:#0000cf;font-weight:bold">9&lt;/span> syslog syslog &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 ../
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lr-x------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> -&amp;gt; /dev/null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>l-wx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> -&amp;gt; /dev/null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>l-wx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> -&amp;gt; /dev/null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lrwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span> -&amp;gt; &lt;span style="color:#4e9a06">&amp;#39;socket:[15881]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lr-x------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> -&amp;gt; /dev/urandom
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lr-x------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">5&lt;/span> -&amp;gt; /proc/kmsg
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lrwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">6&lt;/span> -&amp;gt; &lt;span style="color:#4e9a06">&amp;#39;socket:[21398]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>l-wx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> -&amp;gt; /var/log/syslog
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>l-wx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">8&lt;/span> -&amp;gt; /var/log/kern.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>l-wx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 &lt;span style="color:#0000cf;font-weight:bold">9&lt;/span> -&amp;gt; /var/log/auth.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>追踪一下进程的系统调用(这里是执行了一下 &lt;code>su - root&lt;/code> 命令产生的日志)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># strace -p 595 -f -e recvmsg -s 1000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>strace: Process &lt;span style="color:#0000cf;font-weight:bold">595&lt;/span> attached with &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> threads
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>pid 626&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> recvmsg&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>3, &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">msg_name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>NULL, &lt;span style="color:#000">msg_namelen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0, &lt;span style="color:#000">msg_iov&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=[{&lt;/span>&lt;span style="color:#000">iov_base&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&amp;lt;37&amp;gt;Oct 19 22:01:40 su: (to root) desistdaydream on pts/1&amp;#34;&lt;/span>, &lt;span style="color:#000">iov_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>8096&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span>, &lt;span style="color:#000">msg_iovlen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1, &lt;span style="color:#000">msg_control&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=[{&lt;/span>&lt;span style="color:#000">cmsg_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>32, &lt;span style="color:#000">cmsg_level&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SOL_SOCKET, &lt;span style="color:#000">cmsg_type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SO_TIMESTAMP_OLD, &lt;span style="color:#000">cmsg_data&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">={&lt;/span>&lt;span style="color:#000">tv_sec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1634652100, &lt;span style="color:#000">tv_usec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>471671&lt;span style="color:#ce5c00;font-weight:bold">}}&lt;/span>, &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">cmsg_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>28, &lt;span style="color:#000">cmsg_level&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SOL_SOCKET, &lt;span style="color:#000">cmsg_type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SCM_CREDENTIALS, &lt;span style="color:#000">cmsg_data&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">={&lt;/span>&lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>2549, &lt;span style="color:#000">uid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0, &lt;span style="color:#000">gid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0&lt;span style="color:#ce5c00;font-weight:bold">}}]&lt;/span>, &lt;span style="color:#000">msg_controllen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>64, &lt;span style="color:#000">msg_flags&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>, MSG_DONTWAIT&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">52&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>pid 626&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> recvmsg&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>3, &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">msg_name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>NULL, &lt;span style="color:#000">msg_namelen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0, &lt;span style="color:#000">msg_iov&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=[{&lt;/span>&lt;span style="color:#000">iov_base&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&amp;lt;86&amp;gt;Oct 19 22:01:40 su: pam_unix(su-l:session): session opened for user root by desistdaydream(uid=0)&amp;#34;&lt;/span>, &lt;span style="color:#000">iov_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>8096&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span>, &lt;span style="color:#000">msg_iovlen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1, &lt;span style="color:#000">msg_control&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=[{&lt;/span>&lt;span style="color:#000">cmsg_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>32, &lt;span style="color:#000">cmsg_level&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SOL_SOCKET, &lt;span style="color:#000">cmsg_type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SO_TIMESTAMP_OLD, &lt;span style="color:#000">cmsg_data&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">={&lt;/span>&lt;span style="color:#000">tv_sec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1634652100, &lt;span style="color:#000">tv_usec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>471786&lt;span style="color:#ce5c00;font-weight:bold">}}&lt;/span>, &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">cmsg_len&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>28, &lt;span style="color:#000">cmsg_level&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SOL_SOCKET, &lt;span style="color:#000">cmsg_type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SCM_CREDENTIALS, &lt;span style="color:#000">cmsg_data&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">={&lt;/span>&lt;span style="color:#000">pid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>2549, &lt;span style="color:#000">uid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0, &lt;span style="color:#000">gid&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0&lt;span style="color:#ce5c00;font-weight:bold">}}]&lt;/span>, &lt;span style="color:#000">msg_controllen&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>64, &lt;span style="color:#000">msg_flags&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>, MSG_DONTWAIT&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">96&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以发现，从 fd 为 3 的 &lt;code>socket:[15881]&lt;/code> 这个文件接收到了日志信息&lt;/p>
&lt;p>看看这个文件是个啥&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># lsof -p 595 -a -d 3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rsyslogd &lt;span style="color:#0000cf;font-weight:bold">595&lt;/span> syslog 3u unix 0xffff99c534a7d800 0t0 &lt;span style="color:#0000cf;font-weight:bold">15881&lt;/span> /run/systemd/journal/syslog &lt;span style="color:#000">type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>DGRAM
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># cat /proc/net/unix | grep 15881&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ffff99c534a7d800: &lt;span style="color:#0000cf;font-weight:bold">00000002&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">00000000&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">00000000&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0002&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">01&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">15881&lt;/span> /run/systemd/journal/syslog
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>两种方式都指向了同一个文件 /run/systemd/journal/syslog&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># ll /run/systemd/journal/syslog&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>srw-rw-rw- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 /run/systemd/journal/syslog&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这是一个 socket 文件，从 lsof 命令中可以看到是是一个用于实现 本地数据报通信的 &lt;a href="https://desistdaydream.github.io/docs/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Kernel/Process/Inter%20Process%20Communication(%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1)/Inter%20Process%20Communication(%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1).md">Inter Process Communication(进程间通信)&lt;/a>(DGRAM 类型的 Unix Socket)&lt;/p>
&lt;p>这个文件替代了传统的 /dev/log 文件，/dev/log 变成了指向 /run/systemd/journal/dev-log 的软链接&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># ll /dev/log&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lrwxrwxrwx &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">28&lt;/span> Oct &lt;span style="color:#0000cf;font-weight:bold">19&lt;/span> 21:16 /dev/log -&amp;gt; /run/systemd/journal/dev-log&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是在 CentOS 7 中，Rsyslog 依然直接使用的 /dev/log 这个 Socket。&lt;/p>
&lt;h1 id="rsyslog-的的规范">RsysLog 的的规范&lt;a class="td-heading-self-link" href="#rsyslog-%e7%9a%84%e7%9a%84%e8%a7%84%e8%8c%83" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>RsysLog 使用 &lt;strong>Facility(设施)&lt;/strong> 来对各个程序产生的日志进行分类好便于管理，每个 Facility 包含 1 个或多个程序，Facility 用于约束多个程序所产生的日志数据流到同一个管道内，默认有以下几个，括号中的数字与名称相对应&lt;/p>
&lt;ul>
&lt;li>&lt;strong>kern(0)&lt;/strong> # 内核的日志。&lt;/li>
&lt;li>&lt;strong>user(1)&lt;/strong> # 用户层日志，比如用户使用 logger 命令来记录日志功能。&lt;/li>
&lt;li>&lt;strong>mail(2)&lt;/strong> # 邮件相关的日志。&lt;/li>
&lt;li>&lt;strong>daemon(3)&lt;/strong> # 系统服务产生的信息，比如 systemd 管理的服务的信息。&lt;/li>
&lt;li>&lt;strong>authpriv(4)&lt;/strong> # 认证相关的日志，比如 login、ssh、su 等需要账号密码的。&lt;/li>
&lt;li>&lt;strong>syslog(5)&lt;/strong> # 由 syslog 相关协议产生的信息，就是 rsyslog 程序本身的日志信息。&lt;/li>
&lt;li>&lt;strong>lpr(6)&lt;/strong> # 打印相关的日志。&lt;/li>
&lt;li>&lt;strong>news(7)&lt;/strong> # 新闻组服务器有关的日志。&lt;/li>
&lt;li>&lt;strong>uucp(8)&lt;/strong>：&lt;/li>
&lt;li>&lt;strong>cron(9)&lt;/strong> # 定时任务产生的日志。&lt;/li>
&lt;li>&lt;strong>authpriv(10)&lt;/strong> # 与 auth 类似，更多的是记录账号私人的日志，包括 pam 模块运作的日志。&lt;/li>
&lt;li>&lt;strong>ftp(11)&lt;/strong> # 与 ftp 相关的信息。&lt;/li>
&lt;li>&lt;strong>16 到 23.local0 到 local7&lt;/strong> # 保留给本机用户自定义设施。比如可以把某些设施设置成 local0，然后供 RsysLog 收集日志&lt;/li>
&lt;/ul>
&lt;p>日志的级别：&lt;/p>
&lt;ul>
&lt;li>emerg(0)：错误信息。最严重日志等级，意味着系统将要宕机&lt;/li>
&lt;li>alert(1)：错误信息。比 emerg 等级轻&lt;/li>
&lt;li>crit(2)：错误信息。&lt;/li>
&lt;li>err(3)：错误信息。err 就是 error&lt;/li>
&lt;li>warn(4)：警告信息。可能有问题，但是还不至于影响到程序的运行。warn 就是 warnning&lt;/li>
&lt;li>notice(5)：基本信息。&lt;/li>
&lt;li>info(6)：基本信息。&lt;/li>
&lt;li>debug(7)：特殊的等级，用来 troubleshooting 时产生的日志&lt;/li>
&lt;li>none：特殊的等级。表示某个 Facility 不需要执行 Action。i.e.即不记录的级别&lt;/li>
&lt;/ul>
&lt;p>RsysLog 默认把日志保存在 /var/log/ 目录下的文件中，该目录下常见的日志文件有：&lt;/p>
&lt;ul>
&lt;li>messages # 几乎所有系统发生的信息都会记录在这个文件中
&lt;ul>
&lt;li>Ubuntu 发型版中是 syslog 文件&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>boot.log #&lt;/li>
&lt;li>cron # 记录 crontab 执行的信息&lt;/li>
&lt;li>dmesg # 系统开机时内核检查过程所产生的各项信息&lt;/li>
&lt;li>maillog 与 mail/* # 记录邮件的往来日志主要是 postfix(SMTP)与 dovecot(POP3)所产生的信息&lt;/li>
&lt;li>secure # 只要涉及到需要输入账号密码的软件，那么当登录时，会被记录在这个文件中。包括系统的 login 程序、su 和 sudo、ssh 等
&lt;ul>
&lt;li>Ubuntu 发型版中是 auth.og 文件&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>lastlog # 记录系统上所有账号最近一次登录系统时的相关信息。lastlog 命令就是利用这个文件记录的信息来展示的&lt;/li>
&lt;li>wtmp 与 faillog # 记录正确登录系统的账号信息与错误登录时所使用的账号信息。last 命令时读取的 wtmp 中的内容&lt;/li>
&lt;/ul>
&lt;h1 id="日志的格式">日志的格式&lt;a class="td-heading-self-link" href="#%e6%97%a5%e5%bf%97%e7%9a%84%e6%a0%bc%e5%bc%8f" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Linux 相关的日志格式一般为：&lt;/p>
&lt;p>月 日 时:分:秒 主机名 程序名:事件内容&lt;/p>
&lt;h1 id="总结">总结&lt;a class="td-heading-self-link" href="#%e6%80%bb%e7%bb%93" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>随着时代的发展，各个应用程序大部分都通过各自的日志库，将日志直接写到磁盘上了~~ 很少会有程序再去直接利用 Rsyslog 记录日志。部分系统级的程序，e.g. &lt;a href="https://desistdaydream.github.io/docs/4.%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1/Utility/OpenSSH/OpenSSH.md">OpenSSH&lt;/a>、etc. 还会使用 Rsyslog。&lt;/p>
&lt;h1 id="rsyslog-关联文件与配置">Rsyslog 关联文件与配置&lt;a class="td-heading-self-link" href="#rsyslog-%e5%85%b3%e8%81%94%e6%96%87%e4%bb%b6%e4%b8%8e%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;strong>/etc/rsyslog.conf&lt;/strong> # rsyslog 程序的基础配置文件&lt;/p>
&lt;ul>
&lt;li>&lt;strong>/etc/rsyslog.d/*.conf&lt;/strong> # rsyslog.conf 可以包含该目录下的配置文件。常用于定义单独程序的日志配置，以便日后方便管理&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/etc/sysconfig/rsyslog&lt;/strong> # rsyslogd 运行时参数配置&lt;/p>
&lt;p>&lt;strong>/dev/log&lt;/strong> # 一个 Unix Domain Socket，rsyslogd 从这个 Socket 中读取日志消息。这是传统的日志服务 Socket。在 CentOS 8 及以后的版本中，该文件是一个指向 /run/systemd/journal/syslog 文件的软链接&lt;/p>
&lt;ul>
&lt;li>&lt;strong>/run/systemd/journal/syslog&lt;/strong> # rsyslogd 会持续监听该 Socket，当有数据传入时，使用 recvmsg() 调用获取日志数据。
&lt;ul>
&lt;li>这个文件是由 &lt;a href="https://desistdaydream.github.io/docs/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Systemd/Systemd.md">Systemd&lt;/a> 提供的 Socket 文件，用以兼容传统 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Journal.md">Journal&lt;/a> 日志服务，在 /etc/systemd/journald.conf 配置文件中，可以看到默认 ForwardToSyslog=yes 设置，即表示将自己的日志转发到 syslog 中。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/var/log/&lt;/strong> # 日志记录的位置。根据 rsyslog 程序的基础配置文件，各个 Linux 发行版的文件名也许不同，但是大体都差不多&lt;/p>
&lt;ul>
&lt;li>./message # CentOS 发行版的绝大部分日志文件
&lt;ul>
&lt;li>./syslog # Ubuntu 发型版的绝大部分日志文件&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>./secure # 所有 authpriv 设施的日志，比如 su、sudo、sshd 的登录信息等等。&lt;/li>
&lt;li>/var/log/maillog mail 记录&lt;/li>
&lt;li>/var/log/utmp&lt;/li>
&lt;li>/var/log/wtmp 登陆记录信息（last 命令即读取此日志）&lt;/li>
&lt;/ul></description></item></channel></rss>