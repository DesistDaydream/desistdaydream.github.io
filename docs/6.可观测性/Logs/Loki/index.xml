<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – Loki</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/</link><description>Recent content in Loki on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Loki</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki/</link><pubDate>Sun, 12 Jun 2022 12:01:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/grafana/loki">GitHub 项目，grafana/loki&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/fundamentals/overview/">官方文档，基础-概述&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.qikqiak.com/post/grafana-loki-usage/">阳明博客&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.zhihu.com/people/quchenyuan/posts">知乎文章&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wsgzao.github.io/post/loki/">https://wsgzao.github.io/post/loki/&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 是受 Prometheus 启发的水平可扩展，高度可用的多租户日志聚合系统。它的设计具有很高的成本效益，并且易于操作。它不索引日志的内容，而是为每个日志流设置一组标签。
与其他日志聚合系统相比，Loki 有以下特点：&lt;/p>
&lt;ul>
&lt;li>不对日志进行全文本索引。通过存储压缩的，非结构化的日志以及仅索引元数据，Loki 更加易于操作且运行成本更低。&lt;/li>
&lt;li>使用与 Prometheus 相同的标签对日志流进行索引和分组，从而使您能够使用与 Prometheus 相同的标签在指标和日志之间无缝切换。&lt;/li>
&lt;li>特别适合存储 Kubernetes Pod 日志。诸如 Pod 标签之类的元数据会自动被抓取并建立索引。&lt;/li>
&lt;li>在 Grafana 中具有本机支持（需要 Grafana v6.0）。&lt;/li>
&lt;/ul>
&lt;p>基于 Loki 的日志包含 3 个程序：&lt;/p>
&lt;ul>
&lt;li>Loki 是主服务器，负责存储日志和处理查询。&lt;/li>
&lt;li>Client Agent 客户端代理，负责收集日志并将其发送给 Loki。promtail 是其中一种 agent，是 loki 原配。&lt;/li>
&lt;li>Grafana 用于查询和显示日志。&lt;/li>
&lt;/ul>
&lt;p>Loki 像 Prometheus 一样，但是是用于处理日志的：我们更喜欢基于多维标签的索引方法，并且希望使用没有依赖关系的单一二进制，易于操作的系统。Loki 与 Prometheus 的不同之处在于，它侧重于日志而不是指标，并通过推送而不是拉取交付日志。&lt;/p>
&lt;blockquote>
&lt;p>Loki 与 Promtail 加一起才相当于 Prometheus，因为 Promtail 是发现目标，采集日志的程序。然后主动 Push 给 Loki，由 Loki 存储日志数据。
而 Promtheus，可以自己发现目标，采集指标，存储指标。&lt;/p>
&lt;/blockquote>
&lt;h2 id="loki-observability可观察性">Loki Observability(可观察性)&lt;a class="td-heading-self-link" href="#loki-observability%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/observability/">官方文档，运维-可观测性&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 和 Promtail 都在 &lt;code>/metrics&lt;/code> 端点上公开了指标，该端点暴露了 &lt;a href="docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Metrics/%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/OpenMetrics.md">OpenMetrics&lt;/a> 格式的指标。&lt;/p>
&lt;p>Loki 存储库具有一个&lt;a href="https://github.com/grafana/loki/tree/main/production/loki-mixin">混合包&lt;/a>，其中包括一组仪表板，记录规则和警报。总之，mixin 为您提供了一个全面的软件包，用于监视生产中的 Loki。&lt;/p>
&lt;p>有关 mixin 的更多信息，请参阅 &lt;a href="https://github.com/monitoring-mixins/docs">monitoring-mixins 项目&lt;/a> 的文档 。&lt;/p>
&lt;h2 id="multi-tenancy多租户">Multi Tenancy(多租户)&lt;a class="td-heading-self-link" href="#multi-tenancy%e5%a4%9a%e7%a7%9f%e6%88%b7" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Loki 支持多租户，以使租户之间的数据完全分离。当 Loki 在多租户模式下运行时，所有数据（包括内存和长期存储中的数据）都由租户 ID 分区，该租户 ID 是从请求中的 &lt;code>X-Scope-OrgID&lt;/code> HTTP 头中提取的。当 Loki 不在多租户模式下时，将忽略 Header 头，并将租户 ID 设置为 &lt;code>fake&lt;/code>，这将显示在索引和存储的块中。&lt;/p>
&lt;h1 id="loki-架构概述">Loki 架构概述&lt;a class="td-heading-self-link" href="#loki-%e6%9e%b6%e6%9e%84%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/">官方文档，基础 - 架构&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 由多个组件组成，每个组件都可以实现特定的功能：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>写入日志数据&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>Distributor(分配器)&lt;/strong> # 对应 distributor 组件。负责处理客户端写入的日志，它是日志数据写入路径中的&lt;strong>第一站&lt;/strong>，一旦 Distributor 收到日志数据，会将其拆分为多个批次，然后并行发送给一个或多个 Ingester&lt;/li>
&lt;li>&lt;strong>Ingester(摄取器)&lt;/strong> # 对应 ingester 组件。负责将日志数据写入 本地文件系统 或 指定的存储后端(DynamoDB、S3、Cassandra 等)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>读取日志数据&lt;/strong>，处理 LogQL 请求
&lt;ul>
&lt;li>&lt;strong>Querier(查询器)&lt;/strong> # 对应 querier 组件。接收客户端发送的 LogQL 请求并从定的存储中查询日志数据并返回给客户端&lt;/li>
&lt;li>&lt;strong>Query Frontend(查询前端)&lt;/strong> # 对应 query-frontend 组件。为 Querier 组件提供负载均衡功能。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>其他&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>Table Manager 表管理器)&lt;/strong> # 对应 table-manager 组件。负责所有数据中，Table 的维护工作。根据配置文件中 schema_config.configs 字段中的相关配置，在指定时间开始之前创建周期表，并在根据 table_manager 字段中的相关配置，将数据时间范围超过保留期的数据删除。&lt;/li>
&lt;li>&lt;strong>Compactor(压缩器)&lt;/strong> # 2.6 版本时，Compactor 组件被设置为默认的用来实现数据保留功能的组件，暂时只支持 boltdb-shipper。准备要代替 table-manager 组件。&lt;/li>
&lt;li>&lt;strong>Ruler(规则管理器)&lt;/strong> # 对应 ruler 组件。从存储中读取数据，根据规则发送给告警处理程序。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>loki 二进制文件的设计方式与 thanos 非常类似，都是在单一二进制文件中，可以运行指定的一个或多个组件。&lt;/p>
&lt;p>Loki 内部将组件称为 &lt;strong>Modules(模块)&lt;/strong>。如果想要运行指定的模块，有两种方式：&lt;/p>
&lt;ul>
&lt;li>命令行标志 # loki 二进制文件的 &lt;code>-target&lt;/code> 命令行标志&lt;/li>
&lt;li>配置文件 # 配置文件中的 &lt;code>target&lt;/code> 字段。&lt;/li>
&lt;/ul>
&lt;p>target 可用的值有：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>all&lt;/strong> # 表示 Loki 将以 Monolithic 架构运行，这也是默认的运行方式。Monolithic 模式非常适合测试或运行一个小规模的 Loki；而 Microservices 架构则提供了 Loki 的水平扩展性。&lt;/li>
&lt;li>&lt;strong>read&lt;/strong> # 运行 Ingestor 和 Distributor 组件&lt;/li>
&lt;li>&lt;strong>write&lt;/strong> # 运行 Querier、Query frontend、Ruler 组件&lt;/li>
&lt;li>&lt;strong>ingester&lt;/strong> # 只运行 Ingester 组件&lt;/li>
&lt;li>&lt;strong>distributor&lt;/strong> # 只运行 Distributor 组件&lt;/li>
&lt;li>&lt;strong>query-frontend&lt;/strong> # 只运行 Query Frontend 组件&lt;/li>
&lt;li>&lt;strong>query-scheduler&lt;/strong> # 只运行&lt;/li>
&lt;li>&lt;strong>querier&lt;/strong> # 只运行 Querier 组件&lt;/li>
&lt;li>&lt;strong>index-gateway&lt;/strong> # 只运行&lt;/li>
&lt;li>&lt;strong>ruler&lt;/strong> # 只运行 Ruler 组件&lt;/li>
&lt;li>&lt;strong>compactor&lt;/strong> # 只运行 Compactor 组件&lt;/li>
&lt;/ul>
&lt;h2 id="最基本的运行条件">最基本的运行条件&lt;a class="td-heading-self-link" href="#%e6%9c%80%e5%9f%ba%e6%9c%ac%e7%9a%84%e8%bf%90%e8%a1%8c%e6%9d%a1%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>这些组件中，可以和存储直接交互的有 Ingester、Querier、Ruler。&lt;strong>最重要的组件是 Distributor、Ingester、Querier&lt;/strong>这三个，这是 Loki 基本运行的最低要求。&lt;/p>
&lt;p>Distributor 接收客户端(比如 Promtail) 推送的日志，处理后交给 Ingester 转存到本地或对象存储中，Querier 接收 LogQL 查询请求。&lt;/p>
&lt;h2 id="架构分类">架构分类&lt;a class="td-heading-self-link" href="#%e6%9e%b6%e6%9e%84%e5%88%86%e7%b1%bb" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/deployment-modes/">官方文档，基础 - 架构 - 部署模式&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>作为一个应用程序，Loki 由许多组件微服务构建而成，旨在作为一个可水平扩展的分布式系统运行。Loki 的独特设计将整个分布式系统的代码编译成单个二进制或 Docker 映像。该单个二进制文件的行为由-target 命令行标志控制，并定义了三种操作模式之一。&lt;/p>
&lt;p>Loki 旨在根据需求变化轻松地在不同架构下重新部署集群，无需更改配置或进行最少的配置更改。&lt;/p>
&lt;ul>
&lt;li>Monolithic 架构对于快速开始试验 Loki 以及每天高达约 100GB 的小读/写量非常有用。&lt;/li>
&lt;li>Loki 的简单可扩展部署可以扩展到每天数 TB 甚至更多的日志。&lt;/li>
&lt;li>对于非常大的 Loki 集群或需要对扩展和集群操作进行更多控制的集群，建议使用微服务模式。&lt;/li>
&lt;/ul>
&lt;h3 id="monolithic统一-架构">Monolithic(统一) 架构&lt;a class="td-heading-self-link" href="#monolithic%e7%bb%9f%e4%b8%80-%e6%9e%b6%e6%9e%84" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>这种架构需要通过 loki 二进制文件只启动 1 个进程，使该进程用 &lt;code>-target=all&lt;/code> 以便在一个进程中运行所有组件。&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1660115619129-e6fa2017-8e05-46d7-ab56-207ee3cfc90b.png" alt="image.png">&lt;/p>
&lt;p>这是最经典的模式，早期 Loki 通常都是以这种模式被大家部署。这种模式是 loki 以单个二进制文件运行 Loki 的所有组件，如上图，instance 可以看作一个单独的二进制文件。
Monolithic 模式非常适合于本地开发、小规模等场景，Monolithic 模式可以通过多个进程进行扩展，但有以下限制：&lt;/p>
&lt;ul>
&lt;li>当运行带有多个副本的单体模式时，当前无法使用本地索引和本地存储，因为每个副本必须能够访问相同的存储后端，但是本地存储对于并发访问并不安全。主要是因为 BoltDB 仅允许一个进程在同一时间锁定数据库。如果使用远程存储不受影响。&lt;/li>
&lt;li>各个组件无法独立缩放，因此读取组件的数量不能超过写入组件的数量。&lt;/li>
&lt;/ul>
&lt;p>这个进程产生一个 gRPC 监听(默认 9095 端口)和一个 HTTP 监听(默认 3100 端口)。各个组件内部在同一个进程的共享内存中进行数据交互。&lt;/p>
&lt;h3 id="simple-scalable简单可扩展-架构">Simple scalable(简单可扩展) 架构&lt;a class="td-heading-self-link" href="#simple-scalable%e7%ae%80%e5%8d%95%e5%8f%af%e6%89%a9%e5%b1%95-%e6%9e%b6%e6%9e%84" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>这种架构需要通过 loki 二进制文件至少启动 2 个进程，保证两个进程分别具有 读 和 写 的功能&lt;/p>
&lt;ul>
&lt;li>其中一个进程使用 &lt;code>-target=write&lt;/code> 运行具有写功能的组件，包括 Ingestor 和 Distributor&lt;/li>
&lt;li>另一个进程使用 &lt;code>-target=read&lt;/code> 运行具有读功能的组件，包括 Querier、Query frontend、Ruler&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1660120707493-6efe2870-f1a3-446f-b760-6f520236c358.png" alt="image.png">&lt;/p>
&lt;p>这种架构将 Loki 的读/写分离。这个图里少了一点，通常来说，5 个 Loki 实例前面还有一个负载均衡设备，用来接收客户端的 读/写请求，以便将请求转发给对应的 Loki 实例。&lt;/p>
&lt;h3 id="microservices微服务-架构">Microservices(微服务)  架构&lt;a class="td-heading-self-link" href="#microservices%e5%be%ae%e6%9c%8d%e5%8a%a1-%e6%9e%b6%e6%9e%84" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>这种架构需要通过 loki 二进制文件至少启动 4 个进程，整套架构由多个单一功能的进程组成&lt;/p>
&lt;ul>
&lt;li>&lt;code>-target=distributor&lt;/code> # 运行分配器&lt;/li>
&lt;li>&lt;code>-target=ingester&lt;/code># 运行摄取器&lt;/li>
&lt;li>&lt;code>-target=querier&lt;/code># 运行查询器&lt;/li>
&lt;li>&lt;code>-target=query-frontend&lt;/code># 运行查询前端&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1660115629058-db37e36d-3ed5-4bd9-86bc-3fbb05df38d0.png" alt="image.png">&lt;/p>
&lt;p>这种微服务架构与 Thanos 类似，可以通过一个 Loki 的二进制文件，使用子命令来启动不同的功能。&lt;/p>
&lt;ul>
&lt;li>每个组件都产生一个 gRPC 监听(默认 9095 端口)和一个 HTTP 监听(默认 3100 端口)。
&lt;ul>
&lt;li>通常情况下，gRPC 端口用于组件间通信；HTTP 端口用于暴露一些管理 API(比如 指标、运行状态、就绪性)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>各个组件可以暴露的 HTTP API 详见 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki%20API.md">Loki API&lt;/a> 笔记。通过 API，我们可以更清晰得了解到，每个组件可以实现的具体功能&lt;/li>
&lt;li>各个组件通过 memberlist 统一到一个哈希环上，以互相发现。当我们部署在 K8S 中时，将会配置 &lt;code>memberlist.join_members&lt;/code> 字段，并且需要创建对应的 service 资源，service 的 endpoint 将会关联到所有 Distributor、Ingester、Querier 组件。&lt;/li>
&lt;/ul>
&lt;h3 id="gateway网关">Gateway(网关)&lt;a class="td-heading-self-link" href="#gateway%e7%bd%91%e5%85%b3" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>在我们使用 Simple scalable 和 Microservices 这两种架构时，通常会使用一个 &lt;code>loki-gateway&lt;/code> ，这是一个 Nginx，配置很简单：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">http&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">server&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">listen&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">8080&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">location&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">/&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">200&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;OK&amp;#39;&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">auth_basic&lt;/span> &lt;span style="color:#000">off&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">......略&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#4e9a06">location&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">/loki/api/v1/push&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">set&lt;/span> &lt;span style="color:#000">$loki_api_v1_push_backend&lt;/span> &lt;span style="color:#4e9a06">http://loki-loki-distributed-distributor.logging.svc.cluster.local&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">proxy_pass&lt;/span> &lt;span style="color:#000">$loki_api_v1_push_backend:3100$request_uri&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">location&lt;/span> &lt;span style="color:#000;font-weight:bold">~&lt;/span> &lt;span style="color:#4e9a06">/loki/api/.*&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">set&lt;/span> &lt;span style="color:#000">$loki_api_backend&lt;/span> &lt;span style="color:#4e9a06">http://loki-loki-distributed-query-frontend.logging.svc.cluster.local&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">proxy_pass&lt;/span> &lt;span style="color:#000">$loki_api_backend:3100$request_uri&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到，这个 &lt;code>loki-gateway&lt;/code> 用来为 Loki 进行读/写分离的。loki-gateway 会根据客户端发起请求的 URL 判断这个请求应该由哪个组件进行处理。&lt;/p>
&lt;p>Nginx 的配置依据两种架构的不同而有细微区别，但是总归是需要一个 Gateway 的。不管是 Promtail 推送数据，还是客户端查询数据，都可以先经过 loki-gateway&lt;/p>
&lt;h2 id="数据写入路径">数据写入路径&lt;a class="td-heading-self-link" href="#%e6%95%b0%e6%8d%ae%e5%86%99%e5%85%a5%e8%b7%af%e5%be%84" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1660123438275-02b6febb-0f26-431b-9450-9b5f6f125305.png" alt="image.png">&lt;/p>
&lt;p>整体的日志写入路径如下所示：&lt;/p>
&lt;ul>
&lt;li>&lt;code>Distributor&lt;/code> 收到一个 HTTP 请求，以存储流的数据。&lt;/li>
&lt;li>每个流都使用哈希环进行哈希操作。&lt;/li>
&lt;li>&lt;code>Distributor&lt;/code> 将每个流发送到合适的 &lt;code>Ingester&lt;/code> 和他们的副本（基于配置的复制因子）。&lt;/li>
&lt;li>每个 &lt;code>Ingester&lt;/code> 将为日志流数据创建一个块或附加到一个现有的块上。每个租户和每个标签集的块是唯一的。&lt;/li>
&lt;li>&lt;code>Distributor&lt;/code> 通过 HTTP 连接响应一个成功代码。&lt;/li>
&lt;/ul>
&lt;h2 id="数据读取路径">数据读取路径&lt;a class="td-heading-self-link" href="#%e6%95%b0%e6%8d%ae%e8%af%bb%e5%8f%96%e8%b7%af%e5%be%84" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1660118903925-bca6ba6b-f991-4a28-a407-9c6febb38a36.png" alt="image.png">&lt;/p>
&lt;p>日志读取路径的流程如下所示：&lt;/p>
&lt;ul>
&lt;li>&lt;code>Querier&lt;/code> 收到一个对数据的 HTTP 请求。&lt;/li>
&lt;li>&lt;code>Querier&lt;/code> 将查询传递给所有 &lt;code>Ingesters&lt;/code> 以获取内存数据。&lt;/li>
&lt;li>&lt;code>Ingesters&lt;/code> 收到读取请求，并返回与查询相匹配的数据（如果有的话）。&lt;/li>
&lt;li>如果没有 &lt;code>Ingesters&lt;/code> 返回数据，查询器会从后端存储(比如 S3)加载数据，并对其运行查询。&lt;/li>
&lt;li>查询器对所有收到的数据进行迭代和重复计算，通过 HTTP 连接返回最后一组数据。&lt;/li>
&lt;/ul>
&lt;h1 id="loki-主要组件概述">Loki 主要组件概述&lt;a class="td-heading-self-link" href="#loki-%e4%b8%bb%e8%a6%81%e7%bb%84%e4%bb%b6%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gcp6zx/1621238613211-cedcd7da-602a-4c15-9b27-dbcb797317d8.png" alt="">&lt;/p>
&lt;h2 id="distributor分配器">Distributor(分配器)&lt;a class="td-heading-self-link" href="#distributor%e5%88%86%e9%85%8d%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Distributor 服务负责处理客户端写入的日志，它本质上是日志数据写入路径中的&lt;strong>第一站&lt;/strong>，一旦 Distributor 收到日志数据，会将其拆分为多个批次，然后并行发送给多个 Ingester。&lt;/p>
&lt;p>Distributor 通过 gRPC 与 Ingester 通信，它们都是无状态的，可以根据需要扩大或缩小规模。&lt;/p>
&lt;h2 id="ingester摄取器">Ingester(摄取器)&lt;a class="td-heading-self-link" href="#ingester%e6%91%84%e5%8f%96%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Ingester 服务负责将日志数据写入长期存储后端（DynamoDB、S3、Cassandra 等）。此外 Ingester 会验证摄取的日志行是按照时间戳递增的顺序接收的（即每条日志的时间戳都比前面的日志晚一些），当 Ingester 收到不符合这个顺序的日志时，该日志行会被拒绝并返回一个错误。&lt;/p>
&lt;p>注意：虽然 Ingester 支持 BoltDB 写入本地文件系统，但是这仅适用于[单进程模式](/docs/6.可观测性/日志系统/Loki/Loki%20 部署.md 部署.md)，因为 Querier 也需要访问相同的存储，而 BoltDB 仅允许一个进程在同一时间锁定数据库。&lt;/p>
&lt;h2 id="querier查询器">Querier(查询器)&lt;a class="td-heading-self-link" href="#querier%e6%9f%a5%e8%af%a2%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Querier(查询器) 使用 LogQL 处理查询，从 Ingesters 和长期存储中获取日志。&lt;/p>
&lt;h2 id="query-frontend查询前端">Query Frontend(查询前端)&lt;a class="td-heading-self-link" href="#query-frontend%e6%9f%a5%e8%af%a2%e5%89%8d%e7%ab%af" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Query Frontend(查询前端) 是一个可选的组件。当 Loki 以微服务架构运行时，且存在多个 Querier(查询器)，则查询前端可以平均得调度 LogQL 请求到查询器上，说白了就是实现负载均衡的效果。并且查询前端还可以并行处理请求、并缓存这些数据。&lt;/p>
&lt;h1 id="loki-关联文件与配置">Loki 关联文件与配置&lt;a class="td-heading-self-link" href="#loki-%e5%85%b3%e8%81%94%e6%96%87%e4%bb%b6%e4%b8%8e%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;strong>/etc/loki/local-config.yaml&lt;/strong> # loki 程序运行时默认配置文件&lt;/p>
&lt;p>&lt;strong>${StorageConfig}/index&lt;/strong> # loki 的 BoltDB 中存储索引数据保存路径，无默认值，根据配置文件中 &lt;code>.strorage_confg.boltdb.directory&lt;/code> 字段指定。&lt;/p>
&lt;p>&lt;strong>${StorageConfig}/chunks&lt;/strong> # loki 的 chunks(块) 存储数据保存路径，无默认值，根据配置文件中 &lt;code>.strorage_confg.filesystem.directory&lt;/code> 字段指定。&lt;/p>
&lt;h1 id="loki-与其他日志系统相比">Loki 与其他日志系统相比&lt;a class="td-heading-self-link" href="#loki-%e4%b8%8e%e5%85%b6%e4%bb%96%e6%97%a5%e5%bf%97%e7%b3%bb%e7%bb%9f%e7%9b%b8%e6%af%94" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>官方文档：&lt;a href="https://grafana.com/docs/loki/latest/fundamentals/overview/comparisons/">https://grafana.com/docs/loki/latest/fundamentals/overview/comparisons/&lt;/a>&lt;/p>
&lt;p>Loki / Promtail / Grafana vs EFK&lt;/p>
&lt;p>EFK（Elasticsearch，Fluentd，Kibana）堆栈用于从各种来源提取，可视化和查询日志。&lt;/p>
&lt;p>Elasticsearch 中的数据作为非结构化 JSON 对象存储在磁盘上。每个对象的键和每个键的内容都被索引。然后可以使用 JSON 对象或定义为 Lucene 的查询语言来查询数据以定义查询（称为查询 DSL）。&lt;/p>
&lt;p>相比之下，Loki 在单二进制模式下可以将数据存储在磁盘上，但是在水平可伸缩模式下，数据存储在诸如 S3，GCS 或 Cassandra 之类的云存储系统中。日志以纯文本格式存储，并带有一组标签名称和值，其中仅对标签对进行索引。这种折衷使得它比全索引更便宜，并且允许开发人员从其应用程序积极地进行日志记录。使用 LogQL 查询 Loki 中的日志。但是，由于这种设计上的折衷，基于内容（即日志行中的文本）进行过滤的 LogQL 查询需要加载搜索窗口中与查询中定义的标签匹配的所有块。&lt;/p>
&lt;p>Fluentd 通常用于收集日志并将其转发到 Elasticsearch。Fluentd 被称为数据收集器，它可以从许多来源提取日志，对其进行处理，然后将其转发到一个或多个目标。&lt;/p>
&lt;p>相比之下，Promtail 的用例专门针对 Loki 量身定制。它的主要操作模式是发现存储在磁盘上的日志文件，并将与一组标签关联的日志文件转发给 Loki。Promtail 可以为与 Promtail 在同一节点上运行的 Kubernetes Pod 进行服务发现，充当容器边车或 Docker 日志记录驱动程序，从指定的文件夹中读取日志并尾随系统日志。&lt;/p>
&lt;p>Loki 用一组标签对表示日志的方式类似于 Prometheus 表示度量的方式。当与 Prometheus 一起部署在环境中时，由于使用相同的服务发现机制，Promtail 的日志通常具有与应用程序指标相同的标签。具有相同级别的日志和指标使用户可以在指标和日志之间无缝地进行上下文切换，从而有助于根本原因分析。&lt;/p>
&lt;p>Kibana 用于可视化和搜索 Elasticsearch 数据，并且在对该数据进行分析时非常强大。Kibana 提供了许多可视化工具来进行数据分析，例如位置图，用于异常检测的机器学习以及用于发现数据关系的图形。可以将警报配置为在发生意外情况时通知用户。&lt;/p>
&lt;p>相比之下，Grafana 专门针对来自 Prometheus 和 Loki 等来源的时间序列数据量身定制。可以设置仪表板以可视化指标（即将提供日志支持），并且可以使用浏览视图对数据进行临时查询。与 Kibana 一样，Grafana 支持根据您的指标进行警报。&lt;/p>
&lt;ul>
&lt;li>kibana 启动速度比 grafana 慢了 10 倍&lt;/li>
&lt;li>es 启动时，内存使用达到 1.5G，后续存储同样内容的情况下，es 内存使用率 1G 多，loki 内存使用率 200 多 M&lt;/li>
&lt;li>promtail 使用 yaml 作为 配置文件格式，与 prom 配置逻辑一致。fluentd 配置文件格式类似 html&lt;/li>
&lt;li>grafana 页面可以直接通过标签用鼠标点击过滤。kibana 则需要输入内容。&lt;/li>
&lt;/ul></description></item><item><title>Docs: Loki 部署</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E9%83%A8%E7%BD%B2/</link><pubDate>Sun, 23 Oct 2022 13:44:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E9%83%A8%E7%BD%B2/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/installation/">官方文档，安装&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/deployment-modes">官方文档，基础知识 - 架构 - 部署模式&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h1 id="使用-docker-运行-loki">使用 docker 运行 Loki&lt;a class="td-heading-self-link" href="#%e4%bd%bf%e7%94%a8-docker-%e8%bf%90%e8%a1%8c-loki" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>docker run -d --rm --name loki &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --network host &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> -v /opt/loki/config:/etc/loki &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> -v /opt/loki/data:/loki &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> -v /etc/localtime:/etc/localtime:ro &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> grafana/loki
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意：与 Prometheus 类似，需要修改 /opt/loki 目录权限为 777，否则 pod 内进程对该目录无操作权限&lt;/p>
&lt;h1 id="在-kubernets-集群中部署">在 Kubernets 集群中部署&lt;a class="td-heading-self-link" href="#%e5%9c%a8-kubernets-%e9%9b%86%e7%be%a4%e4%b8%ad%e9%83%a8%e7%bd%b2" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>添加 loki 的 helm chart 仓库&lt;/p>
&lt;ul>
&lt;li>&lt;strong>helm repo add grafana &lt;a href="https://grafana.github.io/helm-charts">https://grafana.github.io/helm-charts&lt;/a>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>helm repo update&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h2 id="helm-部署-loki-套件">Helm 部署 Loki 套件&lt;a class="td-heading-self-link" href="#helm-%e9%83%a8%e7%bd%b2-loki-%e5%a5%97%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/v2.4.x/installation/helm/">官方文档 2.4.x，安装 - helm&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>部署 Loki 栈&lt;/p>
&lt;ul>
&lt;li>kubectl create ns loki # 创建名称空间&lt;/li>
&lt;li>helm pull grafana/loki-stack # 获取 loki-stack 的 charts 压缩包&lt;/li>
&lt;li>tar -zxvf loki-stack-X.XX.X.tgz # 解压 charts&lt;/li>
&lt;li>cd loki-stack # 进入目录，根据需求修改模板或 values.yaml 文件&lt;/li>
&lt;li>helm upgrade &amp;ndash;install loki &amp;ndash;namespace=loki . # 使用默认配置在 loki 名称空间中部署 loki 栈 。该方式会部署 loki 与 promtail&lt;/li>
&lt;/ul>
&lt;p>在 grafana 中添加 loki 数据源，如图所示&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/vg0v2e/1616129749320-bb4bc4c9-2acb-460f-a655-5ff76766eb24.jpeg" alt="">&lt;/p>
&lt;h2 id="helm-部署-simple-scalable-架构-loki">Helm 部署 Simple scalable 架构 Loki&lt;a class="td-heading-self-link" href="#helm-%e9%83%a8%e7%bd%b2-simple-scalable-%e6%9e%b6%e6%9e%84-loki" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>部署 Loki&lt;/p>
&lt;ul>
&lt;li>&lt;strong>helm install -n logging loki &amp;ndash;create-namespace grafana/loki-simple-scalable&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>注意：可扩展模式会部署 &lt;code>loki-gateway&lt;/code> 用以接收请求，并分离 读/写 请求，所有 Promtail 用来向 Loki 发起写请求的采集客户端和 Grafana 这种用来向 Loki 发起读请求的展示客户端，指定 Loki 端点时，都要指定 &lt;code>loki-gateway&lt;/code>。&lt;/p>
&lt;p>这里为什么要自带 grafana-agent？这个 grafana-agent 是通过 grafana/agent-operator 拉起来的。&lt;/p>
&lt;h2 id="helm-部署-microservices-架构-loki">Helm 部署 Microservices 架构 Loki&lt;a class="td-heading-self-link" href="#helm-%e9%83%a8%e7%bd%b2-microservices-%e6%9e%b6%e6%9e%84-loki" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>部署 Loki&lt;/p>
&lt;ul>
&lt;li>&lt;strong>helm install -n logging loki &amp;ndash;create-namespace grafana/loki-distributed&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h1 id="日志测试容器">日志测试容器&lt;a class="td-heading-self-link" href="#%e6%97%a5%e5%bf%97%e6%b5%8b%e8%af%95%e5%ae%b9%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>这俩容器会频繁刷新各种类型日志&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">apiVersion&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">apps/v1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kind&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Deployment&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">replicas&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">selector&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">matchLabels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">app&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">template&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">app&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">logging&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 要采集日志需要加上该标签&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">containers&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummy&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">image&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">cnych/dummylogs:latest&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">args&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">msg-processor&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#000">---&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">apiVersion&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">apps/v1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kind&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Deployment&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs2&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">replicas&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">selector&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">matchLabels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">app&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs2&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">template&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">app&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummylogs2&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">logging&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 要采集日志需要加上该标签&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">containers&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dummy&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">image&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">cnych/dummylogs:latest&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">args&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">msg-receiver-api&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="其他">其他&lt;a class="td-heading-self-link" href="#%e5%85%b6%e4%bb%96" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考；&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/grafana/loki/tree/main/production">GitHub 项目，grafana/loki - production&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/qnt7JUzHLUU6Qs_tv5V0Hw">公众号，Loki 生产环境集群方案&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote></description></item><item><title>Docs: Loki 配置</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E9%85%8D%E7%BD%AE/</link><pubDate>Sun, 23 Oct 2022 13:43:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E9%85%8D%E7%BD%AE/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/configuration/">官方文档，配置&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/rules/">官方文档，告警规则和记录规则&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 可以通过两种方式配置 Loki 的运行时行为&lt;/p>
&lt;ul>
&lt;li>命令行标志&lt;/li>
&lt;li>配置文件&lt;/li>
&lt;/ul>
&lt;p>配置文件的一部分字段的值，可以通过命令行标志设置。在官方文档中，我们可以查看到配置文件中，所有与命令行标志对应的字段，效果如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># HTTP server listen host&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># CLI flag: -server.http-listen-address&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">http_listen_address(string)]&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>凡是注释中，有 &lt;code>CLI flag&lt;/code> 的字段，都可以通过命令行标签设置其值。&lt;/p>
&lt;h1 id="loki-命令行标志详解">Loki 命令行标志详解&lt;a class="td-heading-self-link" href="#loki-%e5%91%bd%e4%bb%a4%e8%a1%8c%e6%a0%87%e5%bf%97%e8%af%a6%e8%a7%a3" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;strong>-target &amp;lt;STRING&amp;gt;&lt;/strong> # 指定要启用的模块&lt;/p>
&lt;ul>
&lt;li>可用的模块有 distributor、ingester、querier、query-frontend、table-manager。&lt;/li>
&lt;li>可以使用 read、write 来让 loki 运行在只读或只写的模式&lt;/li>
&lt;li>可以使用 all 表示启用所有模块&lt;/li>
&lt;/ul>
&lt;h1 id="lokiyaml-配置文件详解">loki.yaml 配置文件详解&lt;a class="td-heading-self-link" href="#lokiyaml-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%a6%e8%a7%a3" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>文档中包含配置文件关键字与命令行 flag 的对应值，配置文件中的很多配置，都可以通过命令行 flag 来实现。&lt;/p>
&lt;h2 id="顶层字段">顶层字段&lt;a class="td-heading-self-link" href="#%e9%a1%b6%e5%b1%82%e5%ad%97%e6%ae%b5" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;strong>target&lt;/strong>(STRING) # 指定 loki 二进制文件要运行的组件列表。&lt;code>默认值：all&lt;/code>，即运行所有组件&lt;/p>
&lt;ul>
&lt;li>可用的值有：all、read、write、ingester、distributor、query-frontend、query-scheduler、querier、index-gateway、ruler、compactor。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>auth_enabled&lt;/strong>(BOOLEAN) # 通过 X-Scope-OrgID 标头启用身份验证，如果为 true，则必须存在。 如果为 false，则 OrgID 将始终设置为“ fake”。默认值：true&lt;/p>
&lt;p>&lt;strong>server&lt;/strong>(&lt;a href="#server">server&lt;/a>) # 用于配置 loki 提供 http 和 gRPC 这两种服务的行为&lt;/p>
&lt;p>&lt;strong>common&lt;/strong>(&lt;a href="#common">common&lt;/a>) # 通用配置。用于配置一些其他配置部分可以共享的配置，比如存储。优先级低，若其他部分指定了相同的配置，则该配置在对应的其他部分的配置将被忽略。&lt;/p>
&lt;ul>
&lt;li>从 2.4 版本开始，common 字段将会逐步代替其他描述不清晰的字段，比如 common.storage 将会代替 storage_cofig 字段&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>######## 存储架构配置 ########&lt;/strong>&lt;/p>
&lt;p>&lt;strong>schema_config&lt;/strong>(&lt;a href="#schema_config">schema_config&lt;/a>) # 配置储存 Chunk 与 Index 类型数据的模式，以及指定储存这些数据所用的存储类型。&lt;/p>
&lt;p>&lt;strong>storage_config&lt;/strong>(&lt;a href="#storage_config">storage_config&lt;/a>) # 为 schema_config 字段指定的存储类型配置详细信息。比如 数据存储位置、连接存储的方式 等等。&lt;/p>
&lt;ul>
&lt;li>注意：该字段的配置会根据 schema_config 字段中指定的信息来选择可用的字段。&lt;/li>
&lt;li>未来将会逐步被 common.storage 字段代替&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>######## 组件配置 ########&lt;/strong>&lt;/p>
&lt;p>&lt;strong>distributor&lt;/strong>(&lt;a href="#distributor">distributor&lt;/a>) # Distributor(分配器) 组件的配置&lt;/p>
&lt;p>&lt;strong>querier&lt;/strong>(&lt;a href="#querier">querier&lt;/a>) # Querier(查询器) 组件的配置.&lt;/p>
&lt;p>&lt;strong>ingester_client&lt;/strong>(&lt;a href="#ingester_client">ingester_client&lt;/a>) # 配置 distributor 如何连接到 ingesters&lt;/p>
&lt;p>&lt;strong>ingester&lt;/strong>(&lt;a href="#ingester">ingester&lt;/a>) # Ingester(摄取器) 组件的配置。还可以配置摄取器如何将自己注册到哈希环上&lt;/p>
&lt;p>&lt;strong>frontend&lt;/strong>(&lt;a href="#frontend">frontend&lt;/a>) # Query Frontend(查询前端) 组件的配置&lt;/p>
&lt;p>&lt;strong>ruler&lt;/strong>(&lt;a href="#ruler">ruler&lt;/a>) # Ruler(规则器) 组件的配置&lt;/p>
&lt;p>&lt;strong>compactor&lt;/strong>(&lt;a href="#compactor">compactor&lt;/a>) # Compactor(压缩器) 组件的配置&lt;/p>
&lt;p>&lt;strong>table_manager&lt;/strong>(&lt;a href="#table_manager">table_manager&lt;/a>) # Table Manager(表管理器) 组件的配置，以规定数据保留的行为&lt;/p>
&lt;p>&lt;strong>######## 其他配置 ########&lt;/strong>&lt;/p>
&lt;p>&lt;strong>query_range&lt;/strong>(queryrange_config) # The queryrange_config configures the query splitting and caching in the Loki query-frontend.&lt;/p>
&lt;p>&lt;strong>chunk_store_config&lt;/strong>(&lt;a href="#chunk_store_config">chunk_store_config&lt;/a>) # 配置 Loki 如何将数据存放在指定的存储中&lt;/p>
&lt;p>&lt;strong>limits_config&lt;/strong>(&lt;a href="#limits_config">limits_config&lt;/a>) # 配置各个组件处理数据的最大值。也可以说配置每个租户的限制或全局的限制。&lt;/p>
&lt;p>&lt;strong>frontend_worker&lt;/strong>: &amp;lt;frontend_worker_config&amp;gt; # The frontend_worker_config configures the worker - running within the Loki querier - picking up and executing queries enqueued by the query-frontend.&lt;/p>
&lt;p>&lt;strong>runtime_config&lt;/strong>: &amp;lt;runtime_config&amp;gt; # Configuration for &amp;ldquo;runtime config&amp;rdquo; module, responsible for reloading runtime configuration file.&lt;/p>
&lt;p>&lt;strong>tracing&lt;/strong>: &amp;lt;tracing_config&amp;gt; # Configuration for tracing&lt;/p>
&lt;h2 id="server">server&lt;a class="td-heading-self-link" href="#server" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>用于配置 loki 提供 http 和 gRPC 这两种服务的行为&lt;/p>
&lt;p>&lt;strong>http_listen_address&lt;/strong>(STRING) # 指定 http 服务监听的端口&lt;/p>
&lt;h2 id="common">common&lt;a class="td-heading-self-link" href="#common" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>Notes: 2.4 版本之前并没有这个字段，早期 Loki 的配置文件解读起来非常混乱。但是 2.4 版本之后，可以通过 common 字段统一定义一些之前带有歧义的字段，&lt;code>common.storage&lt;/code> 可以代替 &lt;code>storage_config&lt;/code> 以配置后端存储的信息。&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://grafana.com/docs/loki/next/configuration/#common">https://grafana.com/docs/loki/next/configuration/#common&lt;/a>&lt;/p>
&lt;p>通用配置。&lt;strong>在配置 Loki 组件所使用的 哈希环、存储、等等 时，可以不在每个组件单独配置，而是直接使用这里定义的通用配置。&lt;/strong>&lt;/p>
&lt;p>&lt;strong>path_prefix&lt;/strong>(STRING) # When defined, the given prefix will be present in front of the endpoint paths.&lt;/p>
&lt;p>&lt;strong>replication_factor&lt;/strong>(INT) # How many times incoming data should be replicated to the ingester component。&lt;code>默认值: 3&lt;/code>&lt;/p>
&lt;p>&lt;strong>ring&lt;/strong>(OBJECT) # 所有使用哈希环的组件的通用哈希环配置。&lt;code>heartbeat_period&lt;/code>?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>kvstore&lt;/strong>(OBJECT) #
&lt;ul>
&lt;li>&lt;strong>store&lt;/strong>(STRING) # 用于保存哈希环的存储。&lt;code>默认值：memberlist&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="存储配置相关字段">存储配置相关字段&lt;a class="td-heading-self-link" href="#%e5%ad%98%e5%82%a8%e9%85%8d%e7%bd%ae%e7%9b%b8%e5%85%b3%e5%ad%97%e6%ae%b5" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>Loki 不同组件共享使用的存储配置。该字段配置存储信息，用以告诉 Loki 如何使用各种类型的存储。&lt;/p>
&lt;p>&lt;strong>storage&lt;/strong>(OBJECT) # 该字段可以代替 &lt;code>storage_config&lt;/code> 字段。比如 ruler.storage.type 的值为 s3 的话，就会使用这里的 s3 字段的配置；若值为 local，则会使用这里的 filesystem 字段的配置。但是有些配置暂时还没有，比如 tsdb。尽量先使用下面的 &lt;a href="#storage_config">storage_config&lt;/a>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>s3&lt;/strong>(&lt;a href="#s3">s3&lt;/a>) # S3 类型存储的信息。包括 连接方式、数据要保存的桶 等信息&lt;/li>
&lt;li>&lt;strong>azure&lt;/strong>(Azure_Store_Config)&lt;/li>
&lt;li>&lt;strong>gcs&lt;/strong>(GCS_Store_Config)&lt;/li>
&lt;li>&lt;strong>swift&lt;/strong>(Swift_Store_config)&lt;/li>
&lt;li>&lt;strong>filesystem&lt;/strong>(&lt;a href="https://grafana.com/docs/loki/next/configuration/#filesystem">OBJECT&lt;/a>) # 将本地文件系统作为 Loki 组件存储数据的地方
&lt;ul>
&lt;li>&lt;strong>chunks_directory&lt;/strong>(STRING) # 存储 chunks 数据的目录&lt;/li>
&lt;li>&lt;strong>rules_directory&lt;/strong>(STRING) # 存储 Loki Rules 文件的目录&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>bos&lt;/strong>(BOS_Storage_config) # Baidu Object Storage(百度对象存储) 的信息。&lt;/li>
&lt;li>&lt;strong>hedging&lt;/strong>(&lt;a href="https://grafana.com/docs/loki/next/configuration/#hedging">OBJECT&lt;/a>) #&lt;/li>
&lt;/ul>
&lt;h3 id="配置示例">配置示例&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>通用的 S3 存储配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">common&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">access_key_id&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">bucketnames&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">172.19.42.215&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">9000&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">insecure&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3forcepathstyle&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">secret_access_key&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置存储-chunk-与-index-数据的方式">配置存储 chunk 与 index 数据的方式&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e5%ad%98%e5%82%a8-chunk-%e4%b8%8e-index-%e6%95%b0%e6%8d%ae%e7%9a%84%e6%96%b9%e5%bc%8f" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>影响 chunk 与 index 两类数据如何存储的最重要配置只有两个字段：&lt;code>schema_config&lt;/code> 和 &lt;code>storage_config&lt;/code>。其他字段都是对存储方式的补充。&lt;/p>
&lt;p>&lt;strong>schema_config&lt;/strong>(&lt;a href="#schema_config">schema_config&lt;/a>) # 定义储存数据的模式，及使用的存储类型&lt;/p>
&lt;p>&lt;strong>storage_config&lt;/strong>(&lt;a href="#storage_config">storage_config&lt;/a>) # 定义各类存储的信息。e.g. 如何连接存储、存储储存数据的路径、etc.&lt;/p>
&lt;blockquote>
&lt;p>不过随着版本的更迭，从 2.4 版本开始，&lt;code>storage_config&lt;/code> 字段会逐渐被 &lt;code>common.storage&lt;/code> 字段顶替。&lt;/p>
&lt;/blockquote>
&lt;h3 id="schema_config">schema_config&lt;a class="td-heading-self-link" href="#schema_config" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>配置存储 chunk 与 index 两类数据的 schema(模式)。该字段用途详见 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage(%E5%AD%98%E5%82%A8)/Storage(%E5%AD%98%E5%82%A8).md">Loki 存储&lt;/a>&lt;/p>
&lt;p>&lt;strong>configs&lt;/strong>([]&lt;a href="#configs">configs&lt;/a>) # schema_config 下只有一个单独的 &lt;code>configs&lt;/code> 字段，其实用 period_config 更准确。。。&lt;code>configs&lt;/code> 字段下这是一个数组，每个数组都可以用来定义&amp;quot;某一时间段 loki 存储所使用的 schema&amp;quot;。所以，&lt;code>configs&lt;/code> 字段用来定义从 哪个时间段开始使用哪种模式将 index 与 chunk 类型的数据存储到哪里去。&lt;/p>
&lt;h4 id="configs">configs&lt;a class="td-heading-self-link" href="#configs" aria-label="Heading self-link">&lt;/a>&lt;/h4>
&lt;p>&lt;strong>from&lt;/strong>(STRING) # 该模式的起始时间。时间格式: YYYY-MM-DD&lt;/p>
&lt;p>注意：store 与 object_store 字段的配置将会决定 Loki 使用 storage_config 中的哪个字段作为存储数据的地方&lt;/p>
&lt;p>&lt;strong>schema&lt;/strong>(STRING) # 模式的版本，当前推荐为 v13（截至 2024-10-22）。&lt;/p>
&lt;p>&lt;strong>store&lt;/strong>(STRING) # 存放 Index 数据的存储类型。可用的值有：tsdb, boltdb-shipper&lt;/p>
&lt;p>&lt;strong>object_store&lt;/strong>(STRING) # 存放 Chunks 数据的存储类型。可用的值有：aws (alias s3), azure, gcs, alibabacloud, bos, cos, swift, filesystem, named_store(refer to named_stores_config)&lt;/p>
&lt;p>&lt;strong>index&lt;/strong>(Object) # 指定储存 Index 数据的行为。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>prefix&lt;/strong>(STRING) # 表的前缀，也就是 index 文件的前缀。&lt;/li>
&lt;li>&lt;strong>period&lt;/strong>(DURATION) # 表的周期(在当前期间中，每隔 DURATION 的时间创建一张表)。该值必须为 24h 的倍数。&lt;code>默认值：168h&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>chunks&lt;/strong>(Ojbect) # 指定储存 Chunks 数据的行为。&lt;code>默认值: 复制 index 字段的配置&lt;/code>。其内字段含义与 index 字段下的子字段功能一样。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>prefix&lt;/strong>(STRING) #&lt;/li>
&lt;li>&lt;strong>period&lt;/strong>(DURATION) #&lt;/li>
&lt;/ul>
&lt;p>注意: &lt;code>store&lt;/code> 与 &lt;code>object_store&lt;/code> 字段的值，将会影响 &lt;code>storage_config&lt;/code> 字段下可以使用的字段。比如 store 为 boltdb-shipper，则 storage_config 中只有 boltdb-shipper 字段可以配置，其他无法配置，配置了就会报错。Loki 2.4 版本之后，推荐使用 &lt;code>common.storage&lt;/code> 字段。&lt;/p>
&lt;h3 id="storage_config">storage_config&lt;a class="td-heading-self-link" href="#storage_config" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;blockquote>
&lt;p>Loki 2.4 版本之后，推荐使用 &lt;code>common.storage&lt;/code> 字段。&lt;/p>
&lt;/blockquote>
&lt;p>对 &lt;code>schema_config&lt;/code> 字段配置的扩充。主要用来定义储存 index 和 chunks 类型数据的存储的行为。比如 连接存储的方式、存储储存数据的位置、etc. 信息。&lt;/p>
&lt;p>有多种存储类型可用，该字段中的配置需要根据 &lt;code>schema_config.configs.store&lt;/code> 与 &lt;code>schema_config.configs.object_store&lt;/code> 字段的值来编写。&lt;/p>
&lt;p>e.g. 在 schema_config.configs.store 中使用 aws，那么 storage_config 中就要设置 aws 的字段&lt;/p>
&lt;p>&lt;strong>aws&lt;/strong>(&lt;a href="#s3">s3&lt;/a>) # 仅当 schema_config.configs.object_store 为 aws 时，才配置该字段。&lt;/p>
&lt;p>&lt;strong>boltdb_shipper&lt;/strong>(Ojbect) # 仅当 schema_config.configs.store 为 boltdb_shipper 时，才配置该字段&lt;/p>
&lt;ul>
&lt;li>&lt;strong>active_index_directory&lt;/strong>(STRING) #&lt;/li>
&lt;li>&lt;strong>cache_location&lt;/strong>(STRING) #&lt;/li>
&lt;li>&lt;strong>cache_ttl&lt;/strong>(DURATION) # &lt;code>默认值：24h&lt;/code>&lt;/li>
&lt;li>&lt;strong>shared_store&lt;/strong>(STRING) # 用于保存 BoltDB 文件的存储。
&lt;ul>
&lt;li>在 2.4 版本之后，若 &lt;code>common.storage&lt;/code> 定义了 s3，且 &lt;code>schema_config.object_storage&lt;/code> 定义为 s3，则这个字段的值也为 s3。也就是说，Index 数据也会存到 S3。这个说法待验证。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>tsdb_shipper&lt;/strong>(OBJECT) # 仅当 schema_config.configs.object_store 为 tsdb 时，才配置该字段&lt;/p>
&lt;ul>
&lt;li>&lt;strong>active_index_directory&lt;/strong>(STRING) # Ingester 组件写入索引文件的目录，然后由 shipper 将其上传到配置的存储。目录名通常为: tsdb-shipper-active&lt;/li>
&lt;li>&lt;strong>cache_location&lt;/strong>(STRING) # 用于从存储恢复索引文件以进行查询的缓存位置。目录名通常为: tsdb-shipper-cache&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>filesystem&lt;/strong>(OBJECT) # 仅当 schema_config.configs.object_store 为 filesystem 时，才配置该字段&lt;/p>
&lt;ul>
&lt;li>&lt;strong>directory&lt;/strong>(STRING) # 存放 chunks 数据的绝对路径。&lt;code>默认值: &amp;quot;&amp;quot;&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="distributor">distributor&lt;a class="td-heading-self-link" href="#distributor" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Distributor 组件配置&lt;/p>
&lt;p>Loki 的 distributor(分配器) 组件配置。&lt;/p>
&lt;h2 id="ingester-组件配置">Ingester 组件配置&lt;a class="td-heading-self-link" href="#ingester-%e7%bb%84%e4%bb%b6%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="ingester_client">ingester_client&lt;a class="td-heading-self-link" href="#ingester_client" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="ingester">ingester&lt;a class="td-heading-self-link" href="#ingester" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>Loki 的 Ingester(摄取器) 配置，以及配置采集器如何将自己注册到键值存储&lt;/p>
&lt;p>&lt;strong>lifecycler&lt;/strong> #&lt;/p>
&lt;ul>
&lt;li>&lt;strong>address&lt;/strong>(STRING) # 127.0.0.1&lt;/li>
&lt;li>&lt;strong>ring:&lt;/strong> #
&lt;ul>
&lt;li>&lt;strong>kvstore:&lt;/strong> #
&lt;ul>
&lt;li>&lt;strong>store&lt;/strong>(STRING) # 用于 ring 的后端存储类型。值为 consul, etcd,inmemory, memberlist&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>replication_factor: 1&lt;/strong> #&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>final_sleep: 0s&lt;/strong> #&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>chunk_idle_period: 5m&lt;/strong> #&lt;/p>
&lt;p>&lt;strong>chunk_retain_period: 30s&lt;/strong> #&lt;/p>
&lt;p>&lt;strong>max_transfer_retries: 0&lt;/strong> #&lt;/p>
&lt;p>&lt;strong>wal(Object)&lt;/strong> # Ingester 的 WAL 配置。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>enabled(BOOLEAN)&lt;/strong>&lt;/li>
&lt;li>&lt;strong>dir(/PATH/TO/DIR)&lt;/strong> # WAL 存放目录。&lt;code>默认值: wal&lt;/code>，即默认数据存储目录下的 /wal 目录。&lt;/li>
&lt;/ul>
&lt;h2 id="querier">querier&lt;a class="td-heading-self-link" href="#querier" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Querier 组件配置&lt;/p>
&lt;p>&lt;a href="https://grafana.com/docs/loki/latest/configuration/#querier">https://grafana.com/docs/loki/latest/configuration/#querier&lt;/a>&lt;/p>
&lt;h2 id="frontend">frontend&lt;a class="td-heading-self-link" href="#frontend" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Query frontend 组件配置&lt;/p>
&lt;p>&lt;a href="https://grafana.com/docs/loki/latest/configuration/#frontend">https://grafana.com/docs/loki/latest/configuration/#frontend&lt;/a>&lt;/p>
&lt;h2 id="ruler">ruler&lt;a class="td-heading-self-link" href="#ruler" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Ruler 组件配置。&lt;/p>
&lt;p>&lt;strong>storage(Ojbect)&lt;/strong> # 根据 type 的值，则会优先默认选择&lt;a href="#SJMUR">通用存储&lt;/a>。可用的值有：azure, gcs, s3, swift, local, bos。若没有通用存储，则使用 storage 字段下对应的字段。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>type(STRING)&lt;/strong>#&lt;/li>
&lt;li>&lt;strong>s3(OBJECT)&lt;/strong> # 配置用于存储规则文件的存储信息
&lt;ul>
&lt;li>详见下文通用配置字段 &lt;a href="#s3">s3&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>rule_path&lt;/strong>(STRING) # /loki/tmprules&lt;/p>
&lt;p>&lt;strong>alertmanager_url&lt;/strong>(STRING) # http://localhost&lt;/p>
&lt;p>&lt;strong>ring:&lt;/strong> #&lt;/p>
&lt;ul>
&lt;li>&lt;strong>kvstore:&lt;/strong> #
&lt;ul>
&lt;li>&lt;strong>store: inmemory&lt;/strong> #&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="配置示例-1">配置示例&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b-1" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>将规则文件保存在本地文件系统&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">ruler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">alertmanager_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">http://monitor-hw-cloud-k8s-alertmanager.monitoring.svc.cluster.local.:9093&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enable_alertmanager_v2&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">external_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">https://alertmanager.xx&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">rule_path&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/tmp/loki/scratch&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">local&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/etc/loki/rules&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">local&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="compactor">compactor&lt;a class="td-heading-self-link" href="#compactor" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Compactor 组件配置&lt;/p>
&lt;h2 id="table_manager">table_manager&lt;a class="td-heading-self-link" href="#table_manager" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Table Manager(表管理器) 组件配置，以规定数据保留的行为。该配置环境用途详见《&lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage(%E5%AD%98%E5%82%A8)/Storage(%E5%AD%98%E5%82%A8).md">Loki 存储&lt;/a>》&lt;/p>
&lt;blockquote>
&lt;p>注意：&lt;/p>
&lt;ul>
&lt;li>Table Manager 无法管理存放在对象存储(比如 S3)中的数据，如果要使用对象存储来储存 Index 与 Chunks 数据，则应该自行设置 Bucket 的策略，以删除旧数据。&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;strong>retention_deletes_enabled(BOOLEAN)&lt;/strong> # 是否开启删除保留数据的行为。&lt;code>默认值：false&lt;/code>。&lt;/p>
&lt;p>&lt;strong>retention_period(DURATION)&lt;/strong> # 指定要保留多长时间的表。&lt;/p>
&lt;ul>
&lt;li>DURATION 的值必须是 schema_config.configs.index(或 chunks).period 字段值的倍数。&lt;code>默认值：0s&lt;/code>，即保留所有时间的表，不删除&lt;/li>
&lt;li>注意，为了避免查询超出保留期限的数据，&lt;code>chunk_store_config.max_look_back_period&lt;/code> 字段的值必须小于或等于 retention_period 的值&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>creation_grace_period(DURATION)&lt;/strong> # 提前 DURATION 时间创建新表。&lt;code>默认值：10m&lt;/code>&lt;/p>
&lt;h2 id="limits_config">limits_config&lt;a class="td-heading-self-link" href="#limits_config" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;a href="https://grafana.com/docs/loki/latest/configure/#limits_config">https://grafana.com/docs/loki/latest/configure/#limits_config&lt;/a>&lt;/p>
&lt;p>&lt;strong>ingestion_rate_mb&lt;/strong>(FLOAT) # 每秒可以摄取日志量的大小，单位 MiB。&lt;code>默认值：4&lt;/code>&lt;/p>
&lt;p>&lt;strong>max_query_series&lt;/strong> # 当利用 &lt;a href="docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/LogQL/Metric%20Queries.md">Metric Queries&lt;/a> 时，限制查询结果返回时序数据数量（Label 不同的时序数据）。&lt;code>默认值: 500&lt;/code>&lt;/p>
&lt;ul>
&lt;li>e.g. 当一条日志流通过 LogQL 的一些解析器添加了很多标签时（e.g. 响应时长 标签），这种标签的值有无限多，每个 Label 不同的值都相当于一条新的时间序列数据，所以要通过 max_query_series 限制不同时序数据的最大数量。&lt;/li>
&lt;li>若某条 LogQL 查询结果的时序数据超过了限额，将会产生 &lt;code>maximum of series (XXX) reached for a single query&lt;/code> 报错，XXX 是 max_query_series 配置的值。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>enforce_metric_name&lt;/strong>(BOOLEAN) # 强制每个样本都有一个 metric 名称。&lt;code>默认值：true&lt;/code>&lt;/p>
&lt;ul>
&lt;li>通常设为 false&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>reject_old_samples&lt;/strong>(BOOLEAN) # 旧样本是否会被拒绝。&lt;code>默认值：true&lt;/code>&lt;/p>
&lt;p>&lt;strong>reject_old_samples_max_age&lt;/strong>(DURATION) # 拒绝前可以接收的最大样本年龄。&lt;code>默认值：168h&lt;/code>&lt;/p>
&lt;ul>
&lt;li>如果拒绝旧样本，那么旧样本不能早于 reject_old_samples_max_age 时间&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>shard_streams&lt;/strong> # 配置 Loki &lt;a href="https://grafana.com/docs/loki/latest/operations/automatic-stream-sharding/">Automatic stream sharding&lt;/a> 机制的具体行为。&lt;/p>
&lt;h2 id="其他">其他&lt;a class="td-heading-self-link" href="#%e5%85%b6%e4%bb%96" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="chunk_store_configobject">chunk_store_config(Object)&lt;a class="td-heading-self-link" href="#chunk_store_configobject" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>配置 Loki 如何将数据存放在指定存储中。该配置环境用途详见《&lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage(%E5%AD%98%E5%82%A8)/Storage(%E5%AD%98%E5%82%A8).md">Loki 存储&lt;/a>》&lt;/p>
&lt;p>&lt;strong>max_look_back_period&lt;/strong>(DURATION) # 限制可以查询多长时间的数据。&lt;code>默认值：0s&lt;/code>，即不做限制。DURATION 必须小于或等于 table_manager.retention_period 字段的值&lt;/p>
&lt;h1 id="通用字段">通用字段&lt;a class="td-heading-self-link" href="#%e9%80%9a%e7%94%a8%e5%ad%97%e6%ae%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>这里面说明的通用字段会被配置文件中的某些字段共同使用。与 common 字段不同，这里指的字段是需要在配置文件中真实书写的；而 common 中定义的配置类似于默认值。&lt;/p>
&lt;h2 id="后端存储信息">后端存储信息&lt;a class="td-heading-self-link" href="#%e5%90%8e%e7%ab%af%e5%ad%98%e5%82%a8%e4%bf%a1%e6%81%af" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>用来定义 如何连接存储、数据在存储中的路径、etc.&lt;/p>
&lt;h3 id="s3">S3&lt;a class="td-heading-self-link" href="#s3" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;a href="https://grafana.com/docs/loki/next/configuration/#s3_storage_config">https://grafana.com/docs/loki/next/configuration/#s3_storage_config&lt;/a>&lt;/p>
&lt;p>&lt;strong>endpoint&lt;/strong>(STRING) # 连接 S3 的 endpoint。&lt;code>默认值：空&lt;/code>&lt;/p>
&lt;p>&lt;strong>access_key_id&lt;/strong>(STRING) # 连接 S3 的 AK。&lt;code>默认值：空&lt;/code>&lt;/p>
&lt;p>&lt;strong>secret_access_key&lt;/strong>(STRING) # 连接 S3 的 SK。&lt;code>默认值：空&lt;/code>&lt;/p>
&lt;p>&lt;strong>bucketnames&lt;/strong>(STRING) # 以逗号分割的桶名称列表。&lt;code>默认值：空&lt;/code>。多个桶可以均匀得分布 chunks&lt;/p>
&lt;p>&lt;strong>insecure&lt;/strong>(BOOLEAN) # 是否使用不安全的连接去连接 S3，i.e.是否使用 HTTP 连接 S3。&lt;code>默认值：false&lt;/code>&lt;/p>
&lt;p>&lt;strong>s3forcepathstyle&lt;/strong>(BOOLEAN) #&lt;/p>
&lt;p>&lt;strong>http_config&lt;/strong>(OBJECT)&lt;/p>
&lt;ul>
&lt;li>&lt;strong>insecure_skip_verify&lt;/strong>(BOOLEAN) # 是否跳过证书验证。&lt;code>默认值：false&lt;/code>&lt;/li>
&lt;/ul>
&lt;h1 id="配置文件示例">配置文件示例&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%a4%ba%e4%be%8b" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="loki-启动时的最小配置">loki 启动时的最小配置&lt;a class="td-heading-self-link" href="#loki-%e5%90%af%e5%8a%a8%e6%97%b6%e7%9a%84%e6%9c%80%e5%b0%8f%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="使用本地文件系统">使用本地文件系统&lt;a class="td-heading-self-link" href="#%e4%bd%bf%e7%94%a8%e6%9c%ac%e5%9c%b0%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">auth_enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">false&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">server&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">http_listen_port&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3100&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">common&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">path_prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">filesystem&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunks_directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki/chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">rules_directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki/rules&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">replication_factor&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">instance_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">127.0.0.1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">inmemory&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2020-10-24&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">filesystem&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">ruler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">alertmanager_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">http://localhost:9093&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="使用-s3">使用 S3&lt;a class="td-heading-self-link" href="#%e4%bd%bf%e7%94%a8-s3" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">auth_enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">false&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">server&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">http_listen_port&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3100&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">common&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">path_prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3forcepathstyle&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">bucketnames&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">loki-lch-test&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">localhost:9000&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">access_key_id&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">secret_access_key&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">insecure&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">replication_factor&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">instance_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">127.0.0.1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">inmemory&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2020-10-24&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">s3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">ruler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">alertmanager_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">http://localhost:9093&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="index-与-chunk-都使用-s3">Index 与 Chunk 都使用 S3&lt;a class="td-heading-self-link" href="#index-%e4%b8%8e-chunk-%e9%83%bd%e4%bd%bf%e7%94%a8-s3" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>这里的 S3 使用 Minio&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2020-07-01&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">aws&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">common&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">access_key_id&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">bucketnames&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">172.19.42.215&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">9000&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">insecure&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3forcepathstyle&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">secret_access_key&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="简单完整配置">简单完整配置&lt;a class="td-heading-self-link" href="#%e7%ae%80%e5%8d%95%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">auth_enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">false&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_store_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_look_back_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">0s&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">common&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">access_key_id&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">bucketnames&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">172.19.42.215&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">9000&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">insecure&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">s3forcepathstyle&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">secret_access_key&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">minioadmin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">compactor&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">shared_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">filesystem&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">distributor&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">frontend&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">compress_responses&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">log_queries_longer_than&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">5s&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">tail_proxy_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">http://loki-loki-distributed-querier:3100&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">frontend_worker&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">frontend_address&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">loki-loki-distributed-query-frontend:9095&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">ingester&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_block_size&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">262144&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_encoding&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">snappy&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_idle_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">1h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_retain_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">1m&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_target_size&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1536000&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">lifecycler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">replication_factor&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_chunk_age&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">1h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_transfer_retries&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">wal&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">dir&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/loki/wal&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">limits_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enforce_metric_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">false&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_cache_freshness_per_query&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">10m&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">reject_old_samples&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">reject_old_samples_max_age&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">168h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">split_queries_by_interval&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">15m&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">memberlist&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">join_members&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">loki-loki-distributed-memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">query_range&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">align_queries_with_step&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">cache_results&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_retries&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">5&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">results_cache&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">cache&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enable_fifocache&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">fifocache&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_size_items&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1024&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">validity&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">ruler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">alertmanager_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">https://alertmanager.xx:9093&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enable_alertmanager_v2&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">external_url&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">https://alertmanager.xx&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ring&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">kvstore&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">memberlist&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">rule_path&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/tmp/loki/scratch&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">local&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/etc/loki/rules&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">local&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;2022-06-21&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">loki_index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">s3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v12&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">server&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">http_listen_port&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3100&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">boltdb_shipper&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">active_index_directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/loki/index&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">cache_location&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/loki/cache&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">cache_ttl&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">168h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">shared_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">s3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">filesystem&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/loki/chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">table_manager&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">retention_deletes_enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">false&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">retention_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">0s&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: Loki Rules 配置</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-Rules-%E9%85%8D%E7%BD%AE/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-Rules-%E9%85%8D%E7%BD%AE/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/rules/">官方文档，告警规则和记录规则&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki Rules 文件的结构与 Promethues 的 Rules 文件结构一模一样。&lt;/p>
&lt;h1 id="loki-rules-配置详解">Loki Rules 配置详解&lt;a class="td-heading-self-link" href="#loki-rules-%e9%85%8d%e7%bd%ae%e8%af%a6%e8%a7%a3" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="alerting-rules告警规则">Alerting Rules(告警规则)&lt;a class="td-heading-self-link" href="#alerting-rules%e5%91%8a%e8%ad%a6%e8%a7%84%e5%88%99" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h2 id="recording-rules记录规则">Recording Rules(记录规则)&lt;a class="td-heading-self-link" href="#recording-rules%e8%ae%b0%e5%bd%95%e8%a7%84%e5%88%99" aria-label="Heading self-link">&lt;/a>&lt;/h2></description></item><item><title>Docs: LogQL</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/LogQL/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/LogQL/</guid><description/></item><item><title>Docs: Loki API</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-API/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-API/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/">官方文档, HTTP API&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>每个组件都会暴露一些基本的 API&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#identify-ready-loki-instance">GET /ready&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#return-exposed-prometheus-metrics">GET /metrics&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-current-configuration">GET /config&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-running-services">GET /services&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-build-information">GET /loki/api/v1/status/buildinfo&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>除了这几个基本的 API 以外，每个组件都会暴露一些专用的 API，若是以 Monolithic 架构启动 Loki，则下面的所有 API 都会在这个进程暴露。&lt;/p>
&lt;h1 id="querier-api-与-query-frontend-api">Querier API 与 Query Frontend API&lt;a class="td-heading-self-link" href="#querier-api-%e4%b8%8e-query-frontend-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>查询器与查询前端暴露的 API 是我们最常用的 API，用来处理客户端发来的 LogQL。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#query-loki">GET /loki/api/v1/query&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#query-loki-over-a-range-of-time">GET /loki/api/v1/query_range&lt;/a>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#step-vs-interval">Step vs Interval&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-labels-within-a-range-of-time">GET /loki/api/v1/labels&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-label-values-within-a-range-of-time">GET /loki/api/v1/label/&amp;lt;name&amp;gt;/values&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-series">GET /loki/api/v1/series&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#index-stats">GET /loki/api/v1/index/stats&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#stream-log-messages">GET /loki/api/v1/tail&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="distributor-api">Distributor API&lt;a class="td-heading-self-link" href="#distributor-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#post-flush">POST /flush&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#post-ingesterflush_shutdown">POST /ingester/flush_shutdown&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="ingester-api">Ingester API&lt;a class="td-heading-self-link" href="#ingester-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#flush-in-memory-chunks-to-backing-store">POST /flush&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#flush-in-memory-chunks-and-shut-down">POST /ingester/shutdown&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="ruler-api">Ruler API&lt;a class="td-heading-self-link" href="#ruler-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>以 /loki/ 开头的 API 与 &lt;a href="https://prometheus.io/docs/prometheus/latest/querying/api/">Prometheus API&lt;/a> 兼容，结果格式可以互换使用&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#ruler-ring-status">GET /ruler/ring&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-rule-groups">GET /loki/api/v1/rules&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-rule-groups-by-namespace">GET /loki/api/v1/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-rule-group">GET /loki/api/v1/rules/{namespace}/{groupName}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#set-rule-group">POST /loki/api/v1/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#delete-rule-group">DELETE /loki/api/v1/rules/{namespace}/{groupName}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#delete-namespace">DELETE /loki/api/v1/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-rule-groups">GET /api/prom/rules&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-rule-groups-by-namespace">GET /api/prom/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-rule-group">GET /api/prom/rules/{namespace}/{groupName}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#set-rule-group">POST /api/prom/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#delete-rule-group">DELETE /api/prom/rules/{namespace}/{groupName}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#delete-namespace">DELETE /api/prom/rules/{namespace}&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-rules">GET /prometheus/api/v1/rules&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#list-alerts">GET /prometheus/api/v1/alerts&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="compactor-api">Compactor API&lt;a class="td-heading-self-link" href="#compactor-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-compactorring">GET /compactor/ring&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#post-lokiapiv1delete">POST /loki/api/v1/delete&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#get-lokiapiv1delete">GET /loki/api/v1/delete&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/api/#delete-lokiapiv1delete">DELETE /loki/api/v1/delete&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="series-api">Series API&lt;a class="td-heading-self-link" href="#series-api" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;ul>
&lt;li>GET /loki/api/v1/series&lt;/li>
&lt;li>POST /loki/api/v1/series&lt;/li>
&lt;li>GET /api/prom/series&lt;/li>
&lt;li>POST /api/prom/series&lt;/li>
&lt;/ul></description></item><item><title>Docs: Authentication(认证)</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Authentication%E8%AE%A4%E8%AF%81/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Authentication%E8%AE%A4%E8%AF%81/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/authentication/">官方文档,运行方式-认证&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 不附带任何包含的身份验证层。运营商应在您的服务之前运行身份验证反向代理，例如使用基本身份验证或 OAuth2 代理的 NGINX。&lt;/p>
&lt;p>请注意，在多租户模式下使用 Loki 时，Loki 要求将 HTTP 标头 &lt;code>X-Scope-OrgID&lt;/code>设置为标识租户的字符串。填充此值的责任应由身份验证反向代理处理。阅读&lt;a href="https://grafana.com/docs/loki/latest/operations/multi-tenancy/">多租户&lt;/a>文档以了解更多信息。&lt;/p>
&lt;p>有关身份验证 Promtail 的信息，请参阅文档以&lt;a href="https://grafana.com/docs/loki/latest/clients/promtail/configuration/">了解如何配置 Promtail&lt;/a>。&lt;/p></description></item><item><title>Docs: Loki 管理</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E7%AE%A1%E7%90%86/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E7%AE%A1%E7%90%86/</guid><description/></item><item><title>Docs: Loki 开发</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E5%BC%80%E5%8F%91/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E5%BC%80%E5%8F%91/</guid><description/></item><item><title>Docs: Loki 衍生品</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E8%A1%8D%E7%94%9F%E5%93%81/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Loki-%E8%A1%8D%E7%94%9F%E5%93%81/</guid><description/></item><item><title>Docs: Promtail</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Promtail/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Promtail/</guid><description/></item><item><title>Docs: Storage(存储)</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/</guid><description/></item><item><title>Docs: 组件详解</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/architecture/">官方文档，架构&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/v2.6.x/fundamentals/architecture/components/">官方文档，架构 - 组件&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/dnG4Yye0cP5XtxY0VWiEDg">公众号，Grafana Loki 架构(阳明翻译的官方文档)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Grafana Loki 是一套可以组合成一个功能齐全的日志堆栈组件，与其他日志记录系统不同，Loki 是基于仅索引有关日志元数据的想法而构建的：标签（就像 Prometheus 标签一样）。日志数据本身被压缩然后并存储在对象存储（例如 S3 或 GCS）的块中，甚至存储在本地文件系统上，轻量级的索引和高度压缩的块简化了操作，并显着降低了 Loki 的成本，Loki 更适合中小团队。&lt;/p>
&lt;p>Grafana Loki 主要由 3 部分组成:&lt;/p>
&lt;ul>
&lt;li>loki: 日志记录引擎，负责存储日志和处理查询&lt;/li>
&lt;li>promtail: 代理，负责收集日志并将其发送给 loki&lt;/li>
&lt;li>grafana: UI 界面&lt;/li>
&lt;/ul>
&lt;h1 id="distributor分配器">Distributor(分配器)&lt;a class="td-heading-self-link" href="#distributor%e5%88%86%e9%85%8d%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Distributor 服务负责处理客户端写入的日志，它本质上是日志数据写入路径中的&lt;strong>第一站&lt;/strong>，一旦 Distributor 收到日志数据，会将其拆分为多个批次，然后并行发送给多个 Ingester。&lt;/p>
&lt;p>Distributor 通过 gRPC 与 Ingester 通信，它们都是无状态的，可以根据需要扩大或缩小规模。&lt;/p>
&lt;h3 id="validation验证">Validation(验证)&lt;a class="td-heading-self-link" href="#validation%e9%aa%8c%e8%af%81" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="preprocessing预处理">Preprocessing(预处理)&lt;a class="td-heading-self-link" href="#preprocessing%e9%a2%84%e5%a4%84%e7%90%86" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="rate-limiting速率限制">Rate limiting(速率限制)&lt;a class="td-heading-self-link" href="#rate-limiting%e9%80%9f%e7%8e%87%e9%99%90%e5%88%b6" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="forwarding转发">Forwarding(转发)&lt;a class="td-heading-self-link" href="#forwarding%e8%bd%ac%e5%8f%91" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="hashing哈希">Hashing(哈希)&lt;a class="td-heading-self-link" href="#hashing%e5%93%88%e5%b8%8c" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;code>Distributors&lt;/code> 将一致性哈希和可配置的复制因子结合使用，以确定 &lt;code>Ingester&lt;/code> 服务的哪些实例应该接收指定的流。&lt;/p>
&lt;p>流是一组与租户和唯一标签集关联的日志，使用租户 ID 和标签集对流进行 hash 处理，然后使用哈希查询要发送流的 &lt;code>Ingesters&lt;/code>。&lt;/p>
&lt;p>存储在 Consul 中的哈希环被用来实现一致性哈希。。。所有的 &lt;code>ingester&lt;/code> 都会使用自己拥有的一组 Token 注册到哈希环中，每个 Token 是一个随机的无符号 32 位数字，与一组 Token 一起，&lt;code>ingester&lt;/code> 将其状态注册到哈希环中，状态 &lt;code>JOINING&lt;/code> 和 &lt;code>ACTIVE&lt;/code> 都可以接收写请求，而 &lt;code>ACTIVE&lt;/code> 和 &lt;code>LEAVING&lt;/code> 的 &lt;code>ingesters&lt;/code> 可以接收读请求。在进行哈希查询时，&lt;code>distributors&lt;/code> 只使用处于请求的适当状态的 ingester 的 Token。&lt;/p>
&lt;p>为了进行哈希查找，&lt;code>distributors&lt;/code> 找到最小合适的 Token，其值大于日志流的哈希值，当复制因子大于 1 时，属于不同 &lt;code>ingesters&lt;/code> 的下一个后续 Token（在环中顺时针方向）也将被包括在结果中。&lt;/p>
&lt;p>这种哈希配置的效果是，一个 &lt;code>ingester&lt;/code> 拥有的每个 Token 都负责一个范围的哈希值，如果有三个值为 0、25 和 50 的 Token，那么 3 的哈希值将被给予拥有 25 这个 Token 的 &lt;code>ingester&lt;/code>，拥有 25 这个 Token 的 &lt;code>ingester&lt;/code>负责&lt;code>1-25&lt;/code>的哈希值范围。&lt;/p>
&lt;h3 id="quorum-consistency仲裁一致性">Quorum consistency(仲裁一致性)&lt;a class="td-heading-self-link" href="#quorum-consistency%e4%bb%b2%e8%a3%81%e4%b8%80%e8%87%b4%e6%80%a7" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>由于所有的 &lt;code>Distributors&lt;/code> 共享对同一哈希环的访问权，所以写请求可以被发送到任何 &lt;code>Distributor&lt;/code>。&lt;/p>
&lt;p>为了确保查询结果的一致性，Loki 在读和写上使用 Dynamo 式的仲裁一致性方式，这意味着 &lt;code>Distributor&lt;/code> 将等待至少一半加一个 &lt;code>Ingesters&lt;/code> 的响应，然后再对发送的客户端进行响应。&lt;/p>
&lt;h1 id="ingester摄取器">Ingester(摄取器)&lt;a class="td-heading-self-link" href="#ingester%e6%91%84%e5%8f%96%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Ingester 服务负责将日志数据写入长期存储后端（DynamoDB、S3、Cassandra 等）。并且还会响应查询器的查询请求以返回自身内存中的数据。&lt;/p>
&lt;p>来自每个唯一标签集的日志在内存中被建立成 &lt;code>chunks(块)&lt;/code>，然后可以根据配置的时间间隔刷新到支持的后端存储。在下列情况下，块被压缩并标记为只读：&lt;/p>
&lt;ul>
&lt;li>当前块容量已满（该值可配置）&lt;/li>
&lt;li>过了太长时间没有更新当前块的内容&lt;/li>
&lt;li>刷新了&lt;/li>
&lt;/ul>
&lt;p>每当一个数据块被压缩并标记为只读时，一个可写的数据块就会取代它。如果一个 &lt;code>ingester&lt;/code> 进程崩溃或突然退出，所有尚未刷新的数据都会丢失。Loki 通常配置为多个副本（通常是 3 个）来&lt;strong>降低&lt;/strong>这种风险。&lt;/p>
&lt;p>当向持久存储刷新时，该块将根据其租户、标签和内容进行哈希处理，这意味着具有相同数据副本的多个 &lt;code>ingesters&lt;/code> 实例不会将相同的数据两次写入备份存储中，但如果对其中一个副本的写入失败，则会在备份存储中创建多个不同的块对象。有关如何对数据进行重复数据删除，请参阅 Querier。&lt;/p>
&lt;p>此外 Ingester 会验证摄取的日志行是按照时间戳递增的顺序接收的（即每条日志的时间戳都比前面的日志晚一些），当 Ingester 收到不符合这个顺序的日志时，该日志行会被拒绝并返回一个错误。&lt;/p>
&lt;ul>
&lt;li>如果传入的行与之前收到的行完全匹配（与之前的时间戳和日志文本都匹配），传入的行将被视为完全重复并被忽略。&lt;/li>
&lt;li>如果传入的行与前一行的时间戳相同，但内容不同，则接受该日志行。这意味着同一时间戳有两个不同的日志行是可能的。&lt;/li>
&lt;/ul>
&lt;p>但是，从 XX 版本开始，Ingester 添加了排序功能，通过配置接收乱序写入。&lt;/p>
&lt;h3 id="wal">WAL&lt;a class="td-heading-self-link" href="#wal" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>上面我们也提到了 &lt;code>Ingesters&lt;/code> 将数据临时存储在内存中，如果发生了崩溃，可能会导致数据丢失，而 &lt;a href="https://desistdaydream.github.io/docs/5.%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/WAL.md">WAL&lt;/a> 就可以帮助我们来提高这方面的可靠性。&lt;/p>
&lt;p>Loki 中的 WAL 记录了传入的数据，并将其存储在本地文件系统中，以保证在进程崩溃的情况下持久保存已确认的数据。重新启动后，Loki 将&lt;strong>重放&lt;/strong>日志中的所有数据，然后将自身注册，准备进行后续写操作。这使得 Loki 能够保持在内存中缓冲数据的性能和成本优势，以及持久性优势（一旦写被确认，它就不会丢失数据）。&lt;/p>
&lt;h1 id="query-frontend查询前端">Query Frontend(查询前端)&lt;a class="td-heading-self-link" href="#query-frontend%e6%9f%a5%e8%af%a2%e5%89%8d%e7%ab%af" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>查询前端是一个可选的服务，提供 &lt;code>Querier&lt;/code> 的 API 端点，可以用来加速读取路径。当查询前端就位时，应将传入的查询请求定向到查询前端，而不是 &lt;code>querier&lt;/code>, 为了执行实际的查询，群集中仍需要 &lt;code>querier&lt;/code> 服务。
查询前端在内部执行一些查询调整，并在内部队列中保存查询。&lt;code>querier&lt;/code> 作为 workers 从队列中提取作业，执行它们，并将它们返回到查询前端进行汇总。&lt;code>querier&lt;/code> 需要配置查询前端地址（通过&lt;code>-querier.frontend-address&lt;/code> CLI 标志），以便允许它们连接到查询前端。
查询前端是无状态的，然而，由于内部队列的工作方式，建议运行几个查询前台的副本，以获得公平调度的好处，在大多数情况下，两个副本应该足够了。&lt;/p>
&lt;h3 id="queueing队列">Queueing(队列)&lt;a class="td-heading-self-link" href="#queueing%e9%98%9f%e5%88%97" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>查询前端的排队机制用于：&lt;/p>
&lt;ul>
&lt;li>确保可能导致 &lt;code>querier&lt;/code> 出现内存不足（OOM）错误的查询在失败时被重试。这允许管理员可以为查询提供不足的内存，或者并行运行更多的小型查询，这有助于降低总成本。&lt;/li>
&lt;li>通过使用先进先出队列（FIFO）将多个大型请求分配到所有 &lt;code>querier&lt;/code> 上，以防止在单个 &lt;code>querier&lt;/code> 中传送多个大型请求。&lt;/li>
&lt;li>通过在租户之间公平调度查询。&lt;/li>
&lt;/ul>
&lt;h3 id="splitting分割">Splitting(分割)&lt;a class="td-heading-self-link" href="#splitting%e5%88%86%e5%89%b2" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>查询前端将较大的查询分割成多个较小的查询，在下游 &lt;code>querier&lt;/code> 上并行执行这些查询，并将结果再次拼接起来。这可以防止大型查询在单个查询器中造成内存不足的问题，并有助于更快地执行这些查询。&lt;/p>
&lt;h3 id="caching缓存">Caching(缓存)&lt;a class="td-heading-self-link" href="#caching%e7%bc%93%e5%ad%98" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>查询前端支持缓存指标查询结果，并在后续查询中重复使用。如果缓存的结果不完整，查询前端会计算所需的子查询，并在下游 &lt;code>querier&lt;/code> 上并行执行这些子查询。查询前端可以选择将查询与其 step 参数对齐，以提高查询结果的可缓存性。结果缓存与任何 loki 缓存后端（当前为 memcached、redis 和内存缓存）兼容。&lt;/p>
&lt;h1 id="querier查询器">Querier(查询器)&lt;a class="td-heading-self-link" href="#querier%e6%9f%a5%e8%af%a2%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Querier 查询器服务使用 LogQL 查询语言处理查询，从 Ingesters 和长期存储中获取日志。&lt;/p>
&lt;p>查询器查询所有 &lt;code>ingesters&lt;/code> 的内存数据，然后再到后端存储运行相同的查询。由于复制因子，查询器有可能会收到重复的数据。为了解决这个问题，查询器在内部对具有相同纳秒时间戳、标签集和日志信息的数据进行重复数据删除。&lt;/p>
&lt;h1 id="ruler规则管理器">Ruler(规则管理器)&lt;a class="td-heading-self-link" href="#ruler%e8%a7%84%e5%88%99%e7%ae%a1%e7%90%86%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h1 id="compactor压实器">Compactor(压实器)&lt;a class="td-heading-self-link" href="#compactor%e5%8e%8b%e5%ae%9e%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1></description></item></channel></rss>