<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – Storage(存储)</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/</link><description>Recent content in Storage(存储) on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Storage(存储)</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/Storage%E5%AD%98%E5%82%A8/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/Storage%E5%AD%98%E5%82%A8/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/storage/">官方文档，存储&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/">官方文档，运维-存储&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/boltdb-shipper/">官方文档，运维-存储-BoltDB-Shipper&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>与其他日志记录系统不同，Loki 是基于仅索引日志的元数据的想法而构建的。从 [Loki 的数据模型](/docs/6.可观测性/日志系统/Loki/Storage(存储)/Data%20Model(数据模型).md Model(数据模型).md)可知，日志是根据标签进行定位的。 日志数据本身会被压缩成 Chunks，并存储在本地的文件系统中；并且 Loki 还提供了一个 Index 数据，用来根据索引定位日志数据。小索引和高度压缩的 Chunks 简化了操作，并显着降低了 Loki 的成本。&lt;/p>
&lt;p>所以 Loki 需要存储两种不同类型的数据，当 Loki 收到 Log Stream 时，会存储两类数据：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Chunks(块)&lt;/strong> # &lt;strong>日志流本身的信息&lt;/strong>。每一个 Chunks 都是将一段时间的日志流压缩后形成的一个文件。
&lt;ul>
&lt;li>一个 Chunks 就是一个对象，如果是使用本地文件系统存储 Chunks，则可以抽象得将一个 Chunks 文件当做一个对象。在一个 Chunks 文件中一般包含里一段时间的日志流数据。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Indexes(索引)&lt;/strong> # &lt;strong>日志流索引的信息&lt;/strong>。每一个 Index 都是 键/值 格式的数据库文件，文件中的内容用来关联 日志流的标签 与 Chunks。
&lt;ul>
&lt;li>Index 中的 Key 就是日志流的标签，Value 就是 Chunks 文件所在的绝对路径。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Chunks 与 Index 的存储方式&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Chunks&lt;/strong> # 直接以压缩格式的文件形式存储。&lt;/li>
&lt;li>&lt;strong>Index&lt;/strong> # Loki 自身实现了一个本地的 &lt;strong>Key/Value Database(键值数据库)&lt;/strong>，这个数据库是基于 BoltDB 开发的，称为 &lt;strong>BoltDB-Shipper&lt;/strong>。BoltDB-Shipper 用来存储 Index 数据。&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>小记：Loki 在 2.0 版本之前，这两类数据是分开存放的，只有 Chunks 数据可以存在对象存储中。直到 2.0 发布，Loki 开发了基于 BoltDB 的 BoltDB-Shipper 数据库用来存储 Index，并且已经可以将 Index 数据也存到对象存储中。&lt;/p>
&lt;/blockquote>
&lt;p>同时，Loki 还可以将这些数据，同时存储到 远程存储 中去(比如对象存储)。这些功能都是通过 Ingester 组件实现的。&lt;/p>
&lt;p>Loki 在不同的 Log Stream(日志流) 中接收日志，其中每个 Stream 的 tenantID(租户 ID) 和 一组标签 是该 Stream 的唯一标识。如果 Loki 以单租户模式运行，则所有块都放在名为 &lt;strong>&lt;code>fake&lt;/code>&lt;/strong> 的文件夹中，这是用于单个租户模式的合成租户名称。&lt;/p>
&lt;h2 id="local-storage本地存储">Local Storage(本地存储)&lt;a class="td-heading-self-link" href="#local-storage%e6%9c%ac%e5%9c%b0%e5%ad%98%e5%82%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="on-disk-layout磁盘上的布局">On-disk Layout(磁盘上的布局)&lt;a class="td-heading-self-link" href="#on-disk-layout%e7%a3%81%e7%9b%98%e4%b8%8a%e7%9a%84%e5%b8%83%e5%b1%80" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>与 &lt;a href="https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Metrics/Prometheus/Storage(%E5%AD%98%E5%82%A8)/Storage(%E5%AD%98%E5%82%A8).md">Prometheus 的存储概念&lt;/a>类似，Loki 也是将日志流数据抽象为一个一个的 Block(块)，只不过，在 Loki 这里，称之为 &lt;a href="#Table(%E8%A1%A8)%20%E6%A6%82%E5%BF%B5">Table(表)&lt;/a>。由于 Loki 需要存储 Index 与 Chunks 两种数据，所以，数据在磁盘上的布局，与 Prometheus 也就不太一样了。&lt;/p>
&lt;h3 id="index">Index&lt;a class="td-heading-self-link" href="#index" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>目录组织结构如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@nfs-1 loki&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tree boltdb-shipper-active/index_18766/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>boltdb-shipper-active/index_18766/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#0000cf;font-weight:bold">1621413900&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── 1621413900.snapshot
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#0000cf;font-weight:bold">1621414800&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── 1621414800.snapshot
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> directories, &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> files
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@nfs-1 loki&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tree boltdb-shipper-active/index_18766/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>boltdb-shipper-active/index_18766/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#0000cf;font-weight:bold">1621414800&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── 1621414800.snapshot
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> directories, &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> files
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@nfs-1 loki&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tree boltdb-shipper-active/index_18766/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>boltdb-shipper-active/index_18766/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#0000cf;font-weight:bold">1621414800&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── 1621414800.snapshot
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#0000cf;font-weight:bold">1621415700&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── 1621415700.snapshot
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> directories, &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Loki 将 Index 数据根据 &lt;code>schema_config.configs.index.period&lt;/code> 这个配置，按照时间时间期间进行分组，莫认为 168h，也就是 7 天。&lt;/p>
&lt;p>如果将 &lt;code>schema_config.configs.index.period&lt;/code> 设置为 24h，那么对于 BoltDB-Shipper，一个表就是一个目录，表由许多较小的 BoltDB 文件组成(也就是说目录中有很多 BoltDB 文件)，每个文件仅存储 15 分钟的索引值。每天创建的表名称由 &lt;strong>prefix + period-number-since-epoch&lt;/strong> 组成。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>prefix&lt;/strong> # 是 &lt;code>schema_config.configs.index.period&lt;/code> 配置的值。&lt;/li>
&lt;li>&lt;strong>period-number-since-epoch&lt;/strong># 是从 &lt;a href="https://en.wikipedia.org/wiki/Unix_time">Epoch 时间&lt;/a>以来，到开始存储数据时刻的天数。&lt;/li>
&lt;/ul>
&lt;p>假如 &lt;code>schema_config.configs.index.period&lt;/code> 的值为 &lt;code>loki_index_&lt;/code>，当前时间是 2021 年 5 月 19 日，此时 Loki 收到了日志数据，则 Ingester 会创建一个 名为 &lt;strong>loki_index_18766&lt;/strong> 的目录，并且当收到日志流时，会在这个目录中创建以时间戳为名字的文件，这个文件中就是 Index 数据。&lt;/p>
&lt;blockquote>
&lt;p>自 Epoch 时间(1970 年 1 月 1 日) 至今为止，已经过了 18765 天，而我此时处于第 18766 天。那么这个目录名字中的数字就是 18766&lt;/p>
&lt;/blockquote>
&lt;p>上述 Index 数据将会根据 &lt;code>storage_config.boltdb_shipper&lt;/code> 中的 &lt;code>active_index_directory&lt;/code> 配置的存储路径存储在本地文件系统的目录内，如果还配置了 &lt;code>shared_store&lt;/code> 的值为非 filesystem，那么还会将这些数据上传到指定的对象存储中。&lt;/p>
&lt;p>在这里，我们为什么不会看到每隔 15 分钟就产生一个文件呢，那是因为 Compactor 这个组件的作用。Compactor 会将每个表中的 Index 数据进行合并，并删除其中的重复数据。你想啊~每隔 15 分钟产生一个文件，那一天 24 小时就有 96 个文件，积累起来是非常多的，在使用查询时也不够方便。&lt;/p>
&lt;p>所以，每隔 15 分钟，Compactor 会将旧的 Index 数据压缩到新的 Index 文件中，就像上面的目录结构中展现的，在 1621413900 和 1621414800 存在两个 Index，Compactor 会将 1621413900 中的数据合并到 1621414800 中，并去重，然后留下了唯一一个文件，当下个 15 分钟，又会生成名为 1621415700 的文件，Compactor 又会重复之前的动作，将数据合并到 1621415700 中，最终，在一天结束时，只会留下唯一一个文件。然后，今天的文件，又会被合并到明天的 Index 文件中，最终的最终，只会留下唯一一个 Index 文件。&lt;/p>
&lt;p>特别说明：Loki 与 Etcd 都是使用的 BoltDB 实现的，Index 到最后也会只有一个文件，这个文件就跟 etcd 的 db 文件一样，这个文件中是被压缩的很多很多的键/值对信息&lt;/p>
&lt;p>每天的结束，会将这个文件压缩为 .gz 的格式，并发送到 Chunks 数据存储目录中的 index 目录下。&lt;/p>
&lt;h3 id="chunks">Chunks&lt;a class="td-heading-self-link" href="#chunks" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>Chunks 数据的目录结构就很简单了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@nfs-1 chunks&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tree |more&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── index
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ ├── index_18738
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │ └── compactor-1619056534.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ ├── index_18739
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │ └── compactor-1619142934.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>......省略
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   └── index_18766
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   ├── compactor-1621432533.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   └── loki-bj-net-0-1615528533442739252-1621431900.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── ZmFrZS80MDgzM2JkNDYxNWM0MWIzOjE3OGZmOTgxM2NmOjE3OGZmOTgxM2QwOjUyN2VlY2Yy
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── ZmFrZS80MDgzM2JkNDYxNWM0MWIzOjE3OTdhM2JlOTUxOjE3OTdhM2JlOTUyOjI3NDZlMDdj
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── &lt;span style="color:#000">ZmFrZS80MDIwYTRmN2I2MzVmZGIyOjE3OGY3MDYwZTIwOjE3OGY3MDYxZTE3OmFhMzZhNzg&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── ZmFrZS80MDIwYTRmN2I2MzVmZGIyOjE3OGY5NzU4MzI3OjE3OGY5NzVkZTNiOmIxOTIzNWY4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── ZmFrZS80MDIwYTRmN2I2MzVmZGIyOjE3OGZjYWZkZTA1OjE3OGZjYWZkZjE1OjIzNWIzMjVi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>.......省略
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>那些一长串的字符文件，就是一个 Chunks。并且，Index 的数据压缩后，也会在 Chunks 目录中生成对应的文件。&lt;/p>
&lt;h2 id="remote-storage远程存储">Remote Storage(远程存储)&lt;a class="td-heading-self-link" href="#remote-storage%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>远程存储非常简单，从本地存储的模式可以看出来，Index 和 Chunks 本质上就是一个个的文件，并且互相具有关联关系，所以，Ingester 组件还可以将这些数据，发送到远程存储中。&lt;/p>
&lt;p>现阶段：&lt;/p>
&lt;ul>
&lt;li>Chunks 支持以下远程存储
&lt;ul>
&lt;li>&lt;strong>Cassandra&lt;/strong>&lt;/li>
&lt;li>&lt;strong>S3&lt;/strong> # 任何实现 S3 接口的服务都可以用来存储 Chunks 数据，比如开源的 [MinIO](/docs/5.数据存储/1.存储/存储的基础设施架构/Distributed%20Storage(分布式存储)/MinIO.md Storage(分布式存储)/MinIO.md)。&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;等等，详见官方文档&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Index 支持以下远程存储
&lt;ul>
&lt;li>&lt;strong>Cassandra&lt;/strong>&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;等等，详见官方文档&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Loki 的远程存储与 Prometheus 还有一点区别，Loki 自己的 Ingester 本身就实现了，而 Prometheus 的远程存储则需要其他程序对接。&lt;/p>
&lt;/blockquote>
&lt;p>现在用 MinIO 中存储的 Index 与 Chunks 查看一下目录结构
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1621436054664-ec14823d-2330-40c2-a6a1-155e6fc2b3b9.png" alt="image.png">
fake 目录中就是 Chunks 数据
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1621436066582-d381149e-921e-47a1-9155-b716614528f7.png" alt="image.png">
index 目录总就是 Index 数据
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1621436085579-707d7396-de4d-4761-b753-0bdd940de96b.png" alt="image.png">&lt;/p>
&lt;h3 id="index-1">Index&lt;a class="td-heading-self-link" href="#index-1" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>数据以 WAL 方式存在本地后，逐步上传到远程存储中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>├── data
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   ├── loki
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   ├── boltdb-shipper-active
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   │   └── uploader
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   │   └── name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   ├── boltdb-shipper-cache
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   ├── compactor
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   └── wal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│   │   └── &lt;span style="color:#0000cf;font-weight:bold">00000000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="chunks-1">Chunks&lt;a class="td-heading-self-link" href="#chunks-1" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h2 id="chunk-格式">Chunk 格式&lt;a class="td-heading-self-link" href="#chunk-%e6%a0%bc%e5%bc%8f" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;pre>&lt;code> -------------------------------------------------------------------
| | |
| MagicNumber(4b) | version(1b) |
| | |
-------------------------------------------------------------------
| block-1 bytes | checksum (4b) |
-------------------------------------------------------------------
| block-2 bytes | checksum (4b) |
-------------------------------------------------------------------
| block-n bytes | checksum (4b) |
-------------------------------------------------------------------
| # blocks (uvarint) |
-------------------------------------------------------------------
| #entries(uvarint) | mint, maxt (varint) | offset, len (uvarint) |
-------------------------------------------------------------------
| #entries(uvarint) | mint, maxt (varint) | offset, len (uvarint) |
-------------------------------------------------------------------
| #entries(uvarint) | mint, maxt (varint) | offset, len (uvarint) |
-------------------------------------------------------------------
| #entries(uvarint) | mint, maxt (varint) | offset, len (uvarint) |
-------------------------------------------------------------------
| checksum(from # blocks) |
-------------------------------------------------------------------
| metasOffset - offset to the point with # blocks |
-------------------------------------------------------------------
&lt;/code>&lt;/pre>
&lt;p>&lt;code>mint&lt;/code> 和 &lt;code>maxt&lt;/code>分别描述了最小和最大的 Unix 纳秒时间戳。&lt;/p>
&lt;h3 id="block-格式">Block 格式&lt;a class="td-heading-self-link" href="#block-%e6%a0%bc%e5%bc%8f" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>一个 block 由一系列日志 entries 组成，每个 entry 都是一个单独的日志行。
请注意，一个 block 的字节是用 Gzip 压缩存储的。以下是它们未压缩时的形式。&lt;/p>
&lt;pre>&lt;code>-------------------------------------------------------------------
| ts (varint) | len (uvarint) | log-1 bytes |
-------------------------------------------------------------------
| ts (varint) | len (uvarint) | log-2 bytes |
-------------------------------------------------------------------
| ts (varint) | len (uvarint) | log-3 bytes |
-------------------------------------------------------------------
| ts (varint) | len (uvarint) | log-n bytes |
-------------------------------------------------------------------
&lt;/code>&lt;/pre>
&lt;p>&lt;code>ts&lt;/code> 是日志的 Unix 纳秒时间戳，而 len 是日志条目的字节长度。&lt;/p>
&lt;h1 id="schema模式-概念">Schema(模式) 概念&lt;a class="td-heading-self-link" href="#schema%e6%a8%a1%e5%bc%8f-%e6%a6%82%e5%bf%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/schema/">官方文档，运维-存储-存储模式&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 旨在向后兼容，当 Loki 内部存储发生变化时，通过 &lt;strong>Schema(模式)&lt;/strong> 功能，可以让 Loki 的数据迁移更加平滑。在 Schema 概念中，通过一种 &lt;strong>Period(期间)&lt;/strong> 的概念，来区分多个 Schema 的配置。本质上，一个 Schema 是一个数组，数组中的每个元素都是一个 Period，表示在这个 Period(期间) 内所使用的存储模式是 XX。&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1660102594593-ad7383b9-e99d-414b-b4e4-8547ef28758f.png" alt="image.png">&lt;/p>
&lt;p>同时，&lt;strong>Schema 中的配置，也可以定义 Loki 储存数据所用的存储类型，Loki 想要正常运行，必须要指定具体的 Schema&lt;/strong>。&lt;/p>
&lt;p>假如现在配置文件中有如下配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2019-07-01&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">filesystem&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v10&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">168h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2020-07-01&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb-shipper&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">s3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">168h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个配置表示 Loki 现在可以通过两种 Schema 存储数据，在第一个 Period(期间)(2019 年 7 月 1 日 ~ 2020 年 7 月 1 号)，使用 v10 模式；在第二个 Period(期间)(2020 年 7 月 1 日 ~ 至今)，则使用 v11 模式。这种运行方式，显著简化了升级，让用户不再担心升级时如果存储模式发生变化而产生的影响。就算不是升级 Loki，当用户想要切换所使用的存储时，同样可以通过这种方式来平滑过度。&lt;/p>
&lt;p>基于此，Loki 可以根据不同的 Schema 配置，将不同时间段的数据存放在不同类型的存储中。&lt;/p>
&lt;ul>
&lt;li>比如现在有这么一种场景，公司本来将数据存放在本地，但是随着业务规模扩大，钱赚多了，数据存储方式想改变了，这时候如何丝滑的迁移数据呢？&lt;/li>
&lt;li>通过 schema_config 字段的配置，2019-10-16 到 2020-11-16，使用本地存放数据；然后我买了公有云的存储产品，从 2020-11-16 到 2021-11-16，使用公有云存放数据。Loki 根据这种配置直到，当 2020-11-16 日开始，就会将数据存放在公有云数据库中了，而老的数据还可以不受影响。然后根据下文提到的 Retention 功能，逐步将老数据删除，这种升级过度是非常丝滑的。&lt;/li>
&lt;/ul>
&lt;h2 id="在-schema-中配置储存数据所使用的存储类型">在 Schema 中配置储存数据所使用的存储类型&lt;a class="td-heading-self-link" href="#%e5%9c%a8-schema-%e4%b8%ad%e9%85%8d%e7%bd%ae%e5%82%a8%e5%ad%98%e6%95%b0%e6%8d%ae%e6%89%80%e4%bd%bf%e7%94%a8%e7%9a%84%e5%ad%98%e5%82%a8%e7%b1%bb%e5%9e%8b" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>并且，在 Schema 配置中，还可以通过 &lt;code>schema_config.configs.store&lt;/code> 与 &lt;code>schema_config.configs.object_store&lt;/code> 两个字段指定 Loki 储存 Index 和 Chunk 数据所使用的存储类型，比如上面这个例子中，对于 2020 年 7 月 1 日之前的数据，使用 boltdb-shipper 存储 Index 数据、filesystem 存储 Chunk 数据；2020 年 7 月 1 日之后的存储方式与之前一样。然后再通过 &lt;code>storage_config&lt;/code> 字段来配置 boltdb-shipper 和 filesystem 这两类存储的具体使用方式，比如指定认证信息、指定存储路径等等。&lt;/p>
&lt;p>同时，还可以通过&lt;code>schema_config.configs.store&lt;/code> 与 &lt;code>schema_config.configs.object_store&lt;/code> 两个字段来配置存储数据时 &lt;strong>Table(表)&lt;/strong> 的行为，比如 存储时间、文件名前缀 等等。&lt;/p>
&lt;p>比如上面这个示例中，配置了储存 Index 类型数据的一些简单行为：&lt;code>prefix&lt;/code> 字段指定了当前期间表的前缀为 index_，也就是存储 Index 数据的文件名开头都会是 index_；&lt;code>period&lt;/code> 字段则指定了在这个模式期间，表的周期为 168h，也就是每隔 168 小时，创建一张表。&lt;/p>
&lt;h2 id="依赖于-schema-的配置">依赖于 Schema 的配置&lt;a class="td-heading-self-link" href="#%e4%be%9d%e8%b5%96%e4%ba%8e-schema-%e7%9a%84%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>由于 Schema 中配置了 Loki 储存 Index 与 Chunks 两种数据所使用的存储类型。所以，很多配置，都会基于这个信息，来进行个性化配置。比如在 Schema 中设定了 S3 类型的存储，那么就需要设定连接 S3 存储时所需的认证信息。&lt;/p>
&lt;blockquote>
&lt;p>注意：这一段内容会基于对 Loki 的存储概念已经有了详细了解后，才能看懂。&lt;/p>
&lt;/blockquote>
&lt;h1 id="boltdb-shipper-运行细节">BoltDB-Shipper 运行细节&lt;a class="td-heading-self-link" href="#boltdb-shipper-%e8%bf%90%e8%a1%8c%e7%bb%86%e8%8a%82" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Ingester 组件用于将 Index 与 Chunks 数据写入存储；Querier 组件用于从存储中读取 Index 和 Chunks 以处理 LogQL 查询请求。&lt;/p>
&lt;h2 id="写入数据">写入数据&lt;a class="td-heading-self-link" href="#%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>在深入了解细节之前，需要知道 Ingester 如何管理存储中的 Index 数据。&lt;/p>
&lt;h2 id="读取数据">读取数据&lt;a class="td-heading-self-link" href="#%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Queriers lazily loads BoltDB files from shared object store to configured &lt;code>cache_location&lt;/code>. When a querier receives a read request, the query range from the request is resolved to period numbers and all the files for those period numbers are downloaded to &lt;code>cache_location&lt;/code>, if not already. Once we have downloaded files for a period we keep looking for updates in shared object store and download them every 5 Minutes by default. Frequency for checking updates can be configured with &lt;code>resync_interval&lt;/code> config.查询者将 BoltDB 文件从共享对象存储延迟加载到已配置的 cache_location。 当查询器接收到读取请求时，该请求的查询范围将解析为期间号，并将那些期间号的所有文件下载到 cache_location（如果尚未下载）。 下载文件一段时间后，我们会继续在共享库中查找更新，默认情况下每 5 分钟下载一次。 可以使用 resync_interval config 来配置检查更新的频率。&lt;/p>
&lt;p>To avoid keeping downloaded index files forever there is a ttl for them which defaults to 24 hours, which means if index files for a period are not used for 24 hours they would be removed from cache location. ttl can be configured using &lt;code>cache_ttl&lt;/code> config.为了避免永久保存下载的索引文件，有一个 ttl，默认值为 24 小时，这意味着如果一段时间内未使用索引文件 24 小时，它们将从缓存位置中删除。 可以使用 cache_ttl config 来配置 ttl。&lt;/p>
&lt;p>&lt;strong>Note:&lt;/strong> For better read performance and to avoid using node disk it is recommended to run Queriers as statefulset(when using k8s) with persistent storage for downloading and querying index files
.注意：为了获得更好的读取性能并避免使用节点磁盘，建议将 Queriers 作为 statefulset 运行（使用 k8s 时），并带有持久性存储，以下载和查询索引文件。&lt;/p>
&lt;h1 id="chunk-存储">Chunk 存储&lt;a class="td-heading-self-link" href="#chunk-%e5%ad%98%e5%82%a8" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Chunk 存储是 Loki 的长期数据存储，旨在支持交互式查询和持续写入，不需要后台维护任务。它由以下部分组成:&lt;/p>
&lt;ul>
&lt;li>一个 chunks 索引，这个索引可以通过以下方式支持：Amazon DynamoDB、Google Bigtable、Apache Cassandra。&lt;/li>
&lt;li>一个用于 chunk 数据本身的键值（KV）存储，可以是：Amazon DynamoDB、Google Bigtable、Apache Cassandra、Amazon S3、Google Cloud Storage。&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>与 Loki 的其他核心组件不同，块存储不是一个单独的服务、任务或进程，而是嵌入到需要访问 Loki 数据的 &lt;code>ingester&lt;/code> 和 &lt;code>querier&lt;/code> 服务中的一个库。&lt;/p>
&lt;/blockquote>
&lt;p>块存储依赖于一个统一的接口，用于支持块存储索引的 &lt;code>NoSQL&lt;/code> 存储（DynamoDB、Bigtable 和 Cassandra）。这个接口假定索引是由以下项构成的键的条目集合。&lt;/p>
&lt;ul>
&lt;li>一个哈希 key，对所有的读和写都是必需的。&lt;/li>
&lt;li>一个范围 key，写入时需要，读取时可以省略，可以通过前缀或范围进行查询。&lt;/li>
&lt;/ul>
&lt;p>该接口在支持的数据库中的工作方式有些不同：&lt;/p>
&lt;ul>
&lt;li>&lt;code>DynamoDB&lt;/code> 原生支持范围和哈希键，因此，索引条目被直接建模为 DynamoDB 条目，哈希键作为分布键，范围作为 DynamoDB 范围键。&lt;/li>
&lt;li>对于 &lt;code>Bigtable&lt;/code> 和 &lt;code>Cassandra&lt;/code>，索引条目被建模为单个列值。哈希键成为行键，范围键成为列键。&lt;/li>
&lt;/ul>
&lt;p>一组模式集合被用来将读取和写入块存储时使用的匹配器和标签集映射到索引上的操作。随着 Loki 的发展，Schemas 模式也被添加进来，主要是为了更好地平衡写操作和提高查询性能。&lt;/p>
&lt;h1 id="table表-概念">Table(表) 概念&lt;a class="td-heading-self-link" href="#table%e8%a1%a8-%e6%a6%82%e5%bf%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/table-manager/">官方文档，运维-存储-表管理器&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://my.oschina.net/u/1787735/blog/4429161">开源中国博客，Loki|数据过期启动删除策略设计&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Loki 可以将 Index 和 Chunks 数据以 &lt;strong>Table(表)&lt;/strong> 的形式储存起来，凡是支持表结构的存储产品，都可以用来存储 Loki 的数据。使用 Table 时，会在一段时间内创建多个 Table，每个 Table 包含特定时间范围内的数据，所以 Table 也称为 &lt;strong>Periodic Table(周期表)。&lt;/strong>&lt;/p>
&lt;p>&lt;strong>注意：表的概念不适用与存储在 S3 的 Index 与 Chunk 数据&lt;/strong>&lt;/p>
&lt;p>如图所示，数据在存储中就是这样一种结构：&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1621406186450-f1bdfeb2-3225-472f-ae51-feee150458e8.png" alt="image.png">&lt;/p>
&lt;p>Loki 接收到的 Log Stream，会根据时间被分配到一个 Periodic Table 中&lt;/p>
&lt;p>这是一种数据整合的方法，以便于更好的管理数。将数据基于表来进行分组有两个好处：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Schema(模式)&lt;/strong> # 不同周期的表具有不同的 schema(模式) 和 版本。模式用来指定这个周期表内的数据使用什么类型的存储来存放数据。&lt;/li>
&lt;li>&lt;strong>Retention(保留)&lt;/strong> # Retention 是通过删除整个表来实现的。
&lt;ul>
&lt;li>通过将数据放在不同的周期内，在删除时也可以按照周期来删除，大大提高了数据处理效率&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="table-manager表管理器">Table Manager(表管理器)&lt;a class="td-heading-self-link" href="#table-manager%e8%a1%a8%e7%ae%a1%e7%90%86%e5%99%a8" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;strong>Table Manager(表管理器)&lt;/strong> 是 Loki 的一个组件，用于创建和删除表。根据配置文件中 schema_config.configs 字段中的相关配置，在指定时间开始之前创建周期表，并在根据 table_manager 字段中的相关配置，将数据时间范围超过保留期的表内的数据删除&lt;/p>
&lt;p>Table Manager 并不是可以管理所有存储类型中的日志流数据的，现阶段仅支持以下类型的存储：&lt;/p>
&lt;ul>
&lt;li>Index 数据
&lt;ul>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/table-manager/boltdb-shipper/">BoltDB Shipper&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cassandra.apache.org/">Cassandra&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://aws.amazon.com/dynamodb">DynamoDB&lt;/a>&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;等等，详见官方文档&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Chunk 数据
&lt;ul>
&lt;li>&lt;a href="https://cassandra.apache.org/">Cassandra&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://aws.amazon.com/dynamodb">DynamoDB&lt;/a>&lt;/li>
&lt;li>Filesystem&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;等等，详见官方文档&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>注意：&lt;/p>
&lt;ul>
&lt;li>Table Manager 无法管理存放在对象存储(比如 S3)中的数据，如果要使用对象存储来储存 Index 与 Chunks 数据，则应该自行设置桶策略，以删除旧数据。&lt;/li>
&lt;/ul>
&lt;p>周期表存储相对于特定时间段的索引或块数据。在 schema_config 配置环境中配置储存在单个表中的数据的时间范围的持续时间及其存储类型。&lt;/p>
&lt;p>schema_config 配置环境可以包含一个或多个配置。每个配置都定义了 .configs.from 字段指定的日期和下一个 .configs.from 配置之间这一段时间使用的存储模式，对于最后一个模式配置条目，则视为 .configs.from 指定的时间到当前时间这一段时间。这允许在一段时间内具有多个不重叠的架构配置，以便执行架构版本升级或更改存储设置（包括更改存储类型）。效果如下图：
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1616129694870-76a7338c-4755-41d8-8702-e6c9b37a5bc8.jpeg" alt="">
写入路径将命中日志条目时间戳记所在的表（通常是最后一个表，除了靠近表末尾和下一个表的开头的短时间段外），而读取路径将命中包含查询数据的表时间范围。&lt;/p>
&lt;p>表管理器会在配置中设定的开始时间之前创建新表，以确保一旦到达当前表的结束时间，新表就准备就绪。&lt;/p>
&lt;h2 id="loki-storage-retention数据保留">Loki Storage Retention(数据保留)&lt;a class="td-heading-self-link" href="#loki-storage-retention%e6%95%b0%e6%8d%ae%e4%bf%9d%e7%95%99" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>官方文档：&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/retention/">https://grafana.com/docs/loki/latest/operations/storage/retention/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Table Manager 可以实现 Loki 的 Retention(数据保留) 行为。如果想要启动 Retention，在 table_manager 配置环境中，需要开启删除数据保留的行为，以及确定数据可以保留的 period(期限，也就是时间范围)，详见 《Loki 配置详解》 table_manager 配置环境说明。&lt;/p>
&lt;p>这个 Retention Period(保留期限) 是这么理解的：比如设置保留期限为 7d，表周期为 7d，那么当第三张表激活时，则第一张表被删除。
&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1616129694876-b393cced-7824-4974-9c32-207b52852e71.jpeg" alt="">
这种设计允许进行快速删除操作，但要以保留期限由表格周期控制为代价。所以 Retention 必须为 Period 的倍数，比如当表周期为 7 天时，那么要保留的就必须是 7 天、14 天、21 天&amp;hellip;..这种。否则无法正确删除一整张表。像 14 天，21 天这种，其实就意味着保留 2 张表、3 张表。&lt;/p>
&lt;p>这是一个保留 28 天 日志数据的配置示例：主要配置点在最后 6 行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">schema_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">from&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">2018-04-15&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">boltdb&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">object_store&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">filesystem&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">schema&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">index&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">prefix&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">index_&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">24h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">storage_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">boltdb&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki/index&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">filesystem&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">directory&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/loki/chunks&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">chunk_store_config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">max_look_back_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">672h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">table_manager&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">retention_deletes_enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">retention_period&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">672h&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个示例效果如下，当第六张新表创建之后，最早的表就会删除，至少保留 28 天，4 张表。&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/gzp72g/1616129694882-bf6a427c-5f6a-4ba5-93a0-a28c0ecd729e.jpeg" alt="">
注意：官方示例写的 30 天，是错误的，详见：&lt;a href="https://github.com/grafana/loki/pull/2772">https://github.com/grafana/loki/pull/2772&lt;/a>&lt;/p></description></item><item><title>Docs: Data Model(数据模型)</title><link>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/Data-Model%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/6.%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/Logs/Loki/Storage%E5%AD%98%E5%82%A8/Data-Model%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>官方文档没有专门讲 Log Stream 的章节，Stream 的概念都是在其他章节提到的&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/getting-started/labels/">官方文档，入门-标签&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://grafana.com/docs/loki/latest/operations/storage/">官方文档，运维-存储&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h1 id="log-stream日志流-概念">Log Stream(日志流) 概念&lt;a class="td-heading-self-link" href="#log-stream%e6%97%a5%e5%bf%97%e6%b5%81-%e6%a6%82%e5%bf%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>Loki 通过一种称为 &lt;strong>Log Stream(日志流)&lt;/strong> 的概念组织所有日志数据。&lt;strong>Log Stream(日志流) 之于 Loki 类似于 Time series(时间序列) 之于 Prometheus&lt;/strong>&lt;/p>
&lt;p>Loki 使用 &lt;strong>Stream(流)&lt;/strong> 这个词来描述保存的日志数据，并根据 &lt;strong>Label(标签)&lt;/strong> 来定位日志流，Label 是日志流的元数据。Label 的概念和用法与 Prometheus 中的 Label 一致。如果 Loki 与 Prometheus 同时使用，那么他们之间得标签是一致的，通过 Label，很容易得就可以将应用程序指标和日志数据关联起来。&lt;/p>
&lt;p>Stream 与 Label 是强关联的，在 Loki 中，Label 是唯一可以定义 Log Stream 的东西。每个标签键和值的组合定义了一条 log stream。如果一个标签值发生了变化，则这会生成一个新的 Log stream。在 Prometheus 中，类似 Log Stream 概念的是 time series(stream 对应 series)。但是不同的是，在 Prometheus 中还有一个维度，是 metrics name(指标名称)。但是在 Loki 中则谁 Path，一个 采集日志的 Path 实际上是会采集很多很多日志的。也正是由于此，所以 Loki 将这种概念称为 Stream，而不是 Series。&lt;/p>
&lt;p>用白话说，所谓的 Log Stream 可以是下面事物的一种：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>File&lt;/strong> # 一个文件就是一个 Log Stream。一般情况，客户端(比如 Promtail)从文件中 tail 内容以获取日志信息，所以，一个日志就相当于一个 日志流。&lt;/li>
&lt;li>&lt;strong>STDOUT&lt;/strong> # 标准输出。&lt;/li>
&lt;li>&amp;hellip;.等等&lt;/li>
&lt;/ul>
&lt;p>所以 Log Stream 就是上述事物的一种通用抽象。&lt;/p>
&lt;h2 id="log-line日志行-概念">Log Line(日志行) 概念&lt;a class="td-heading-self-link" href="#log-line%e6%97%a5%e5%bf%97%e8%a1%8c-%e6%a6%82%e5%bf%b5" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>Log Line 就是指日志流中的每一行日志，称为 &lt;strong>Log Line(日志行)&lt;/strong>。Log Line 之于 Loki 类似于 Series 之于 Prometheus。&lt;/p>
&lt;h2 id="标签示例">标签示例&lt;a class="td-heading-self-link" href="#%e6%a0%87%e7%ad%be%e7%a4%ba%e4%be%8b" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>下面的示例将说明 Loki 中 Label 标签的基本使用和概念。&lt;/p>
&lt;p>首先看下下面的示例，这是一个 promtail 的抓取配置示例：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">scrape_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">job_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">system&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">pipeline_stages&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">static_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">targets&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">localhost&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">job&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">syslog&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">__path__&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/log/syslog&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个配置将获取日志文件数据并添加一个 job=syslog 的标签，我们可以这样来查询：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#a40000">job=&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;#34;syslog&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这将在 Loki 中创建一个流。现在我们再新增一些任务配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">scrape_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">job_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">system&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">pipeline_stages&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">static_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">targets&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">localhost&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">job&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">syslog&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">__path__&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/log/syslog&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">job_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">system&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">pipeline_stages&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">static_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">targets&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">localhost&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">job&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">apache&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">__path__&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/log/apache.log&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在我们采集两个日志文件，每个文件有一个标签与一个值，所以 Loki 会存储为两个流。我们可以通过下面几种方式来查询这些流：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#a40000">job=&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;#34;apache&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#a40000">&amp;lt;-&lt;/span> &lt;span style="color:#a40000">显示&lt;/span> &lt;span style="color:#a40000">job&lt;/span> &lt;span style="color:#a40000">标签为&lt;/span> &lt;span style="color:#a40000">apache&lt;/span> &lt;span style="color:#a40000">的日志&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#a40000">job=&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;#34;syslog&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#a40000">&amp;lt;-&lt;/span> &lt;span style="color:#a40000">显示&lt;/span> &lt;span style="color:#a40000">job&lt;/span> &lt;span style="color:#a40000">标签为&lt;/span> &lt;span style="color:#a40000">syslog&lt;/span> &lt;span style="color:#a40000">的日志&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#a40000">job=~&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;#34;apache|syslog&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#a40000">&amp;lt;-&lt;/span> &lt;span style="color:#a40000">显示&lt;/span> &lt;span style="color:#a40000">job&lt;/span> &lt;span style="color:#a40000">标签为&lt;/span> &lt;span style="color:#a40000">apache&lt;/span> &lt;span style="color:#a40000">或者&lt;/span> &lt;span style="color:#a40000">syslog&lt;/span> &lt;span style="color:#a40000">的日志&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后一种方式我们使用的是一个 regex 标签匹配器来获取 job 标签值为 apache 或者 syslog 的日志。接下来我们看看如何使用额外的标签：&lt;/p>
&lt;p>要获取这两个任务的日志可以用下面的方式来代替 regex 的方式：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#a40000">env=&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;#34;dev&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#a40000">&amp;lt;-&lt;/span> &lt;span style="color:#a40000">将返回所有带有&lt;/span> &lt;span style="color:#a40000">env=dev&lt;/span> &lt;span style="color:#a40000">标签的日志&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过使用一个标签就可以查询很多日志流了，通过组合多个不同的标签，可以创建非常灵活的日志查询。Label 标签是 Loki 日志数据的索引，它们用于查找压缩后的日志内容，这些内容被单独存储为块。标签和值的每一个唯一组合都定义了一个流 ，一个流的日志被分批，压缩，并作为块进行存储。&lt;/p>
&lt;h1 id="cardinality基数-概念">Cardinality(基数) 概念&lt;a class="td-heading-self-link" href="#cardinality%e5%9f%ba%e6%95%b0-%e6%a6%82%e5%bf%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>前面的示例使用的是静态定义的 Label 标签，只有一个值；但是有一些方法可以动态定义标签。比如我们有下面这样的日志数据：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>11.11.11.11 - frank [25/Jan/2000:14:00:01 -0500] &amp;#34;GET /1986.js HTTP/1.1&amp;#34; 200 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们可以使用下面的方式来解析这条日志数据：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#204a87;font-weight:bold">job_name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">system&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">pipeline_stages&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">regex&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">expression&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;^(?P&amp;lt;ip&amp;gt;\\S+) (?P&amp;lt;identd&amp;gt;\\S+) (?P&amp;lt;user&amp;gt;\\S+) \\[(?P&amp;lt;timestamp&amp;gt;[\\w:/]+\\s[+\\-]\\d{4})\\] \&amp;#34;(?P&amp;lt;action&amp;gt;\\S+)\\s?(?P&amp;lt;path&amp;gt;\\S+)?\\s?(?P&amp;lt;protocol&amp;gt;\\S+)?\&amp;#34; (?P&amp;lt;status_code&amp;gt;\\d{3}|-) (?P&amp;lt;size&amp;gt;\\d+|-)\\s?\&amp;#34;?(?P&amp;lt;referer&amp;gt;[^\&amp;#34;]*)\&amp;#34;?\\s?\&amp;#34;?(?P&amp;lt;useragent&amp;gt;[^\&amp;#34;]*)?\&amp;#34;?$&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">action&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">status_code&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">static_configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">targets&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">localhost&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">labels&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">job&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">apache&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">env&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">dev&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">__path__&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">/var/log/apache.log&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个 regex 匹配日志行的每个组件，并将每个组件的值提取到一个 capture 组里面。在 pipeline 代码内部，这些数据被放置到一个临时的数据结构中，允许在处理该日志行时将其用于其他处理（此时，临时数据将被丢弃）。&lt;/p>
&lt;p>从该 regex 中，我们就使用其中的两个 capture 组，根据日志行本身的内容动态地设置两个标签：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>action (例如 action=&amp;#34;GET&amp;#34;, action=&amp;#34;POST&amp;#34;) status_code (例如 status_code=&amp;#34;200&amp;#34;, status_code=&amp;#34;400&amp;#34;)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>假设我们有下面几行日志数据：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>11.11.11.11 - frank [25/Jan/2000:14:00:01 -0500] &amp;#34;GET /1986.js HTTP/1.1&amp;#34; 200 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>11.11.11.12 - frank [25/Jan/2000:14:00:02 -0500] &amp;#34;POST /1986.js HTTP/1.1&amp;#34; 200 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>11.11.11.13 - frank [25/Jan/2000:14:00:03 -0500] &amp;#34;GET /1986.js HTTP/1.1&amp;#34; 400 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>11.11.11.14 - frank [25/Jan/2000:14:00:04 -0500] &amp;#34;POST /1986.js HTTP/1.1&amp;#34; 400 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>则在 Loki 中收集日志后，会创建为如下所示的流：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>{job=&amp;#34;apache&amp;#34;,env=&amp;#34;dev&amp;#34;,action=&amp;#34;GET&amp;#34;,status_code=&amp;#34;200&amp;#34;} 11.11.11.11 - frank [25/Jan/2000:14:00:01 -0500] &amp;#34;GET /1986.js HTTP/1.1&amp;#34; 200 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{job=&amp;#34;apache&amp;#34;,env=&amp;#34;dev&amp;#34;,action=&amp;#34;POST&amp;#34;,status_code=&amp;#34;200&amp;#34;} 11.11.11.12 - frank [25/Jan/2000:14:00:02 -0500] &amp;#34;POST /1986.js HTTP/1.1&amp;#34; 200 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{job=&amp;#34;apache&amp;#34;,env=&amp;#34;dev&amp;#34;,action=&amp;#34;GET&amp;#34;,status_code=&amp;#34;400&amp;#34;} 11.11.11.13 - frank [25/Jan/2000:14:00:03 -0500] &amp;#34;GET /1986.js HTTP/1.1&amp;#34; 400 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{job=&amp;#34;apache&amp;#34;,env=&amp;#34;dev&amp;#34;,action=&amp;#34;POST&amp;#34;,status_code=&amp;#34;400&amp;#34;} 11.11.11.14 - frank [25/Jan/2000:14:00:04 -0500] &amp;#34;POST /1986.js HTTP/1.1&amp;#34; 400 932 &amp;#34;-&amp;#34; &amp;#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这 4 行日志将成为 4 个独立的流，并开始填充 4 个独立的块。任何与这些 标签/值 组合相匹配的额外日志行将被添加到现有的流中。如果有另一个独特的标签组合进来（比如 status_code=“500”）就会创建另一个新的流。&lt;/p>
&lt;p>比如我们为 IP 设置一个 Label 标签，不仅用户的每一个请求都会变成一个唯一的流，每一个来自同一用户的不同 action 或 status_code 的请求都会得到自己的流。&lt;/p>
&lt;p>如果有 4 个共同的操作（GET、PUT、POST、DELETE）和 4 个共同的状态码（可能不止 4 个！），这将会是 16 个流和 16 个独立的块。然后现在乘以每个用户，如果我们使用 IP 的标签，你将很快就会有数千或数万个流了。&lt;/p>
&lt;p>这个 Cardinality 太高了，这足以让 Loki 挂掉。&lt;/p>
&lt;p>当我们谈论 Cardinality 的时候，我们指的是标签和值的组合，以及他们创建的流的数量，高 Cardinality 是指使用具有较大范围的可能值的标签，如 IP，或结合需要其他标签，即使它们有一个小而有限的集合，比如 status_code 和 action。&lt;/p>
&lt;p>高 Cardinality 会导致 Loki 建立一个巨大的索引（💰💰💰💰），并将成千上万的微小块存入对象存储中（慢），Loki 目前在这种配置下的性能非常差，运行和使用起来非常不划算的。&lt;/p></description></item></channel></rss>