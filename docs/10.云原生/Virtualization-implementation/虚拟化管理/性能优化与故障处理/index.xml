<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – 性能优化与故障处理</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/</link><description>Recent content in 性能优化与故障处理 on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 常见问题</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="unable-to-complete-install-vm-xxxx-didnt-show-up-after-expected-time">Unable to complete install: &amp;lsquo;VM &amp;lsquo;XXXX&amp;rsquo; didn&amp;rsquo;t show up after expected time.&amp;rsquo;&lt;a class="td-heading-self-link" href="#unable-to-complete-install-vm-xxxx-didnt-show-up-after-expected-time" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>使用 virt-manager 安装 VM 时，惦记 Bejin Install 后报错。&lt;/p>
&lt;p>TODO: 咋解决？？&lt;/p>
&lt;h2 id="guest-has-not-initialized-the-display">guest has not initialized the display&lt;a class="td-heading-self-link" href="#guest-has-not-initialized-the-display" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>无法连接虚拟机显示器&lt;/p>
&lt;p>video 设备选为 Node 后，连接虚拟机提示 This VM has no graphic display device&lt;/p>
&lt;p>使用 qemu-system 运行不会有这个问题，使用 virt-install 运行时会出现这个问题&lt;/p>
&lt;p>TODO: 咋解决？？&lt;/p>
&lt;h2 id="requested-operation-is-not-valid-cannot-undefine-domain-with-nvram">Requested operation is not valid: cannot undefine domain with nvram&lt;a class="td-heading-self-link" href="#requested-operation-is-not-valid-cannot-undefine-domain-with-nvram" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>用 virsh 删除虚拟机时报错&lt;/p>
&lt;p>解决方案：添加 &amp;ndash;nvram 或者删除配置文件中的这行 &lt;code>&amp;lt;nvram&amp;gt;/var/lib/libvirt/qemu/nvram/debian6.0_VARS.fd&amp;lt;/nvram&amp;gt;&lt;/code>&lt;/p>
&lt;p>TODO: 咋解决？？&lt;/p></description></item><item><title>Docs: 虚拟化调试和优化指南</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/%E8%99%9A%E6%8B%9F%E5%8C%96%E8%B0%83%E8%AF%95%E5%92%8C%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Virtualization-implementation/%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/%E8%99%9A%E6%8B%9F%E5%8C%96%E8%B0%83%E8%AF%95%E5%92%8C%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">红帽官方文档，7 - 虚拟化调整和优化指南&lt;/a>
&lt;ul>
&lt;li>新链接: &lt;a href="https://docs.redhat.com/zh_hans/documentation/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">https://docs.redhat.com/zh_hans/documentation/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="网卡软中断过高问题">网卡软中断过高问题&lt;a class="td-heading-self-link" href="#%e7%bd%91%e5%8d%a1%e8%bd%af%e4%b8%ad%e6%96%ad%e8%bf%87%e9%ab%98%e9%97%ae%e9%a2%98" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>原文连接: &lt;a href="https://mp.weixin.qq.com/s/X3wsJ13V-ou7j8qccd30AA">https://mp.weixin.qq.com/s/X3wsJ13V-ou7j8qccd30AA&lt;/a>&lt;/p>
&lt;p>游戏网关高峰期时出网络丢包,CPU0 软中断%sys 高达 90%。&lt;/p>
&lt;p>这意思就是说多个 CPU 中，只有 1 个来处理软中断信号&lt;/p>
&lt;p>使用 &lt;code>ethtool -l eth0&lt;/code> 查看网卡队列数，若网卡不支持多多列，将会报错: &lt;code>netlink error: Operation not supported&lt;/code>&lt;/p>
&lt;h3 id="配置网卡多队列">配置网卡多队列&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e7%bd%91%e5%8d%a1%e5%a4%9a%e9%98%9f%e5%88%97" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;blockquote>
&lt;p>参考:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-Networking-Multi-queue_virtio-net">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-Networking-Multi-queue_virtio-net&lt;/a>
&lt;ul>
&lt;li>&lt;a href="https://docs.redhat.com/zh_hans/documentation/red_hat_enterprise_linux/7/html/virtualization_tuning_and_optimization_guide/sect-virtualization_tuning_optimization_guide-networking-multi-queue_virtio-net">https://docs.redhat.com/zh_hans/documentation/red_hat_enterprise_linux/7/html/virtualization_tuning_and_optimization_guide/sect-virtualization_tuning_optimization_guide-networking-multi-queue_virtio-net&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>要使用多队列 virtio-net，请在 VM 的 XML 配置中添加以下内容（主要是添加 &lt;code>queues='N'&lt;/code>，其中 &lt;em>N&lt;/em> 的值从 1 到 256，因为内核支持多队列 tap 设备）支持 256 个队列：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">&amp;lt;interface&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;network&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;source&lt;/span> &lt;span style="color:#c4a000">network=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;default&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;model&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;virtio&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;driver&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;vhost&amp;#39;&lt;/span> &lt;span style="color:#c4a000">queues=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;N&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/interface&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>当在 VM 中运行带有 &lt;em>N&lt;/em> virtio-net 队列的虚拟机时，使用以下命令（ &lt;em>M&lt;/em> 的值从 1 到 &lt;em>N&lt;/em>）启用多队列支持 ：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># ethtool -L eth0 combined M&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>比如在一个桥设备上，添加 8 个队列&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;interface&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;bridge&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;mac&lt;/span> &lt;span style="color:#c4a000">address=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;52:54:00:29:39:61&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;source&lt;/span> &lt;span style="color:#c4a000">bridge=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;br0&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;model&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;virtio&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;driver&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;vhost&amp;#39;&lt;/span> &lt;span style="color:#c4a000">queues=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;8&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span> # 添加该行
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;address&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;pci&amp;#39;&lt;/span> &lt;span style="color:#c4a000">domain=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x0000&amp;#39;&lt;/span> &lt;span style="color:#c4a000">bus=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x01&amp;#39;&lt;/span> &lt;span style="color:#c4a000">slot=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x00&amp;#39;&lt;/span> &lt;span style="color:#c4a000">function=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x0&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;/interface&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置磁盘缓存">配置磁盘缓存&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%bc%93%e5%ad%98" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>参考：https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index#sect-Virtualization_Tuning_Optimization_Guide-BlockIO-Caching&lt;/p>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/un2vm8/1616123000746-e6a1ffde-9736-4cd9-a115-0449b16ef631.jpeg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;disk&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;file&amp;#39;&lt;/span> &lt;span style="color:#c4a000">device=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;disk&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;driver&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;qemu&amp;#39;&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;qcow2&amp;#39;&lt;/span> &lt;span style="color:#c4a000">cache=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;none&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span> # 添加cache=&amp;#39;none&amp;#39;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;source&lt;/span> &lt;span style="color:#c4a000">file=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;/var/lib/libvirt/images/iptv-unc-haproxy-1.qcow2&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;target&lt;/span> &lt;span style="color:#c4a000">dev=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;vda&amp;#39;&lt;/span> &lt;span style="color:#c4a000">bus=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;virtio&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;address&lt;/span> &lt;span style="color:#c4a000">type=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;pci&amp;#39;&lt;/span> &lt;span style="color:#c4a000">domain=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x0000&amp;#39;&lt;/span> &lt;span style="color:#c4a000">bus=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x00&amp;#39;&lt;/span> &lt;span style="color:#c4a000">slot=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x07&amp;#39;&lt;/span> &lt;span style="color:#c4a000">function=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;0x0&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">&amp;lt;/disk&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>经测试&lt;/p>
&lt;p>node 类型 dd 命令速度为 不到 500MB/s&lt;/p>
&lt;p>writeback 类型 de 命令速度为 不到 300MB/s&lt;/p></description></item></channel></rss>