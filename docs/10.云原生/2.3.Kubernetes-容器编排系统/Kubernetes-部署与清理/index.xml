<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦 – Kubernetes 部署与清理</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/</link><description>Recent content in Kubernetes 部署与清理 on 断念梦</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Kind：一个容器创建K8S开发集群</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/Kind%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BAK8S%E5%BC%80%E5%8F%91%E9%9B%86%E7%BE%A4/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/Kind%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BAK8S%E5%BC%80%E5%8F%91%E9%9B%86%E7%BE%A4/</guid><description>
&lt;h2 id="什么是-kind">&lt;strong>什么是 Kind&lt;/strong>&lt;/h2>
&lt;p>&lt;code>kind&lt;/code>：是一种使用 Docker 容器&lt;code>节点&lt;/code>运行本地 Kubernetes 集群的工具。该类型主要用于测试 Kubernetes，但可用于本地开发或 CI。&lt;/p>
&lt;blockquote>
&lt;p>注意：kind 仍在开发中### &lt;strong>Mac &amp;amp; Linux&lt;/strong> $ curl -Lo ./kind &amp;ldquo;&lt;a href="https://kind.sigs.k8s.io/dl/v0.9.0/kind-$(uname)-amd64%22">https://kind.sigs.k8s.io/dl/v0.9.0/kind-$(uname)-amd64&amp;quot;&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;pre>&lt;code>chmod +x ./kind
mv ./kind /some-dir-in-your-PATH/kind1
&lt;/code>&lt;/pre>
&lt;p>2
3
4
Plain Text&lt;/p>
&lt;h3 id="mac-上使用-brew-安装--brew-install-kind1">&lt;strong>Mac 上使用 brew 安装&lt;/strong> $ brew install kind1&lt;/h3>
&lt;p>2
Plain Text&lt;/p>
&lt;h3 id="windows--curlexe--lo-kind-windows-amd64exe-httpskindsigsk8siodlv090kind-windows-amd64">&lt;strong>Windows&lt;/strong> $ curl.exe -Lo kind-windows-amd64.exe &lt;a href="https://kind.sigs.k8s.io/dl/v0.9.0/kind-windows-amd64">https://kind.sigs.k8s.io/dl/v0.9.0/kind-windows-amd64&lt;/a>&lt;/h3>
&lt;p>Move-Item .\kind-windows-amd64.exe c:\some-dir-in-your-PATH\kind.exe # OR via Chocolatey (&lt;a href="https://chocolatey.org/packages/kind">https://chocolatey.org/packages/kind&lt;/a>)
$ choco install kind1
2
3
4
5
6
Plain Text&lt;/p>
&lt;h2 id="k8s-集群创建与删除--创建集群默认集群名称为-kind">&lt;strong>K8S 集群创建与删除&lt;/strong> # 创建集群，默认集群名称为 kind&lt;/h2>
&lt;p>$ kind create cluster1
2
3
Plain Text&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/sog8v3/1616120539030-1a544e75-7263-4229-8daa-01fc2037dd7c.png" alt=""> # 定义集群名称
$ kind create cluster &amp;ndash;name kind-2 # 查询集群
$ kind get clusters # 删除集群
$ kind delete cluster1
2
3
4
5
6
7
8
9
Plain Text&lt;/p>
&lt;h2 id="其它操作--列出集群镜像">&lt;strong>其它操作&lt;/strong> # 列出集群镜像&lt;/h2>
&lt;p>$ docker exec -it my-node-name crictl images1
2
3
Plain Text&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/sog8v3/1616120538989-43863854-bbb8-4205-b2ac-8f73b48d3aac.jpeg" alt="">&lt;/p>
&lt;h2 id="参考链接-httpsgithubcomkubernetes-sigskind">&lt;strong>参考链接&lt;/strong>&amp;gt; &lt;a href="https://github.com/kubernetes-sigs/kind">https://github.com/kubernetes-sigs/kind&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>&lt;a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">https://kind.sigs.k8s.io/docs/user/quick-start/#installation&lt;/a>&lt;/p>
&lt;/blockquote></description></item><item><title>Docs: Kubernetes 部署与清理</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/</guid><description>
&lt;h1 id="概述">概述&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/">官方文档，快速开始&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/easzlab/kubeasz">GitHub 项目，easzlab/kubeasz&lt;/a>(ansible 部署项目)&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/dual-stack-support/">官方文档，入门-生产环境-使用部署工具安装 Kubernetes-使用 kubeadm 引导集群-使用 kubeadm 支持 IPv4 与 IPv6 双栈&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>注意事项：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://v1-19.docs.kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#%E7%A1%AE%E4%BF%9D-iptables-%E5%B7%A5%E5%85%B7%E4%B8%8D%E4%BD%BF%E7%94%A8-nftables-%E5%90%8E%E7%AB%AF">不要使用 nftables&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/qzanwh/1643338198264-a05be403-da81-4455-88f7-b7e613c7db20.png" alt="image.png">&lt;/p>
&lt;h2 id="kubernetes-关联文件">Kubernetes 关联文件&lt;/h2>
&lt;p>下面这些是逐步总结的，应该是准确的，但是没有官方说明
&lt;strong>/etc/kubernetes/*&lt;/strong> # 系统组件运行时配置
&lt;strong>/var/lib/etcd/*&lt;/strong> # Etcd 数据目录
&lt;strong>/var/lib/kubelet/*&lt;/strong> # Kubelet 运行时配置及数据持久化目录
CNI 目录&lt;/p>
&lt;ul>
&lt;li>&lt;strong>/etc/cni/net.d/*&lt;/strong># 默认配置文件保存目录&lt;/li>
&lt;li>&lt;strong>/opt/cni/bin/*&lt;/strong> # 默认 CNI 插件保存目录&lt;/li>
&lt;li>&lt;strong>/var/lib/cni/*&lt;/strong> # 默认 CNI 运行时产生的数据目录&lt;/li>
&lt;/ul>
&lt;h1 id="部署-kubernetes-集群">部署 Kubernetes 集群&lt;/h1>
&lt;h2 id="配置安装环境">配置安装环境&lt;/h2>
&lt;ul>
&lt;li>(可选)更新内核以解决 ipvs 的(在 k8s-1.11.0 版本)BUG
&lt;ul>
&lt;li>[参考内核部署文档](1.Linux%20Kernel.md Kernel.md)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>关闭 iptables 和 firewalld 服务
&lt;ul>
&lt;li>由于 kubernetes 的 kube-proxy 会接管防火墙生成相关规则，所以最好关闭系统自带的&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>systemctl stop firewalld.service &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> systemctl disable firewalld.service
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl stop iptables.service &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> systemctl disable iptables.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>关闭并禁用 SELinux&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sed -i &lt;span style="color:#e6db74">&amp;#39;s@^\(SELINUX=\).*@\1disabled@&amp;#39;&lt;/span> /etc/selinux/config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>setenforce &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>禁用 swap 设备，不禁用 swap，kubelet 会报错。关闭 swap 原因参考官方 issue。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>swapoff -a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sed -i &lt;span style="color:#e6db74">&amp;#39;s@^[^#]\(.*swap.*\)@#\1@g&amp;#39;&lt;/span> /etc/fstab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>(可选)启用 ipvs 内核模块，若要使用 ipvs 模型的 proxy，各个节点需要载入 ipvs 相关的各模块&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum install ipvsadm -y
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/modules-load.d/ip_vs.conf &lt;span style="color:#e6db74">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_lblc
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_lblcr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_lc
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_nq
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_pe_sip
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_rr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_sed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_wlc
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ip_vs_wrr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#e6db74">`&lt;/span>cat /etc/modules-load.d/ip_vs.conf&lt;span style="color:#e6db74">`&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span> modprobe &lt;span style="color:#e6db74">${&lt;/span>i&lt;span style="color:#e6db74">}&lt;/span>; &lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lsmod | grep ip_vs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>正常部署完集群后如果没启用 ipvs 功能，则还需要修改 proxy 配置
&lt;ul>
&lt;li>kubectl edit configmap kube-proxy -n kube-system
&lt;ul>
&lt;li>在 mode:字段后面加上“ipvs”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="安装-runtime">安装 Runtime&lt;/h2>
&lt;h3 id="安装-docker不要用最新版">安装 Docker，不要用最新版&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://developer.aliyun.com/article/110806">安装 docker-ce&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum install -y yum-utils device-mapper-persistent-data lvm2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>yum makecache fast
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>yum install -y docker-ce-19.03.11
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>配置 Docker
&lt;ul>
&lt;li>docker 自 1.13 版起会自动设置 iptables 的 FORWARD 默认策略为 DROP，这可能会影响 Kubernetes 集群依赖的报文转发功能，因此，需要在 docker 服务启动后，重新将 FORWARD 链的默认策略设备为 ACCEPT&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sed -i &lt;span style="color:#e6db74">&amp;#34;14i ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT&amp;#34;&lt;/span> /usr/lib/systemd/system/docker.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>配置 docker 参数的第三行标绿的为加速器的地址，可以自行定义，非官方推荐&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>mkdir /etc/docker
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/docker/daemon.json &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">{
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;registry-mirrors&amp;#34;: [&amp;#34;https://ac1rmo5p.mirror.aliyuncs.com&amp;#34;],
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;exec-opts&amp;#34;: [&amp;#34;native.cgroupdriver=systemd&amp;#34;],
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;live-restore&amp;#34;: true,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;log-driver&amp;#34;: &amp;#34;json-file&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;log-opts&amp;#34;: {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;max-size&amp;#34;: &amp;#34;5m&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;max-file&amp;#34;: &amp;#34;5&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> },
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;storage-driver&amp;#34;: &amp;#34;overlay2&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;storage-opts&amp;#34;: [
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;overlay2.override_kernel_check=true&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> ]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mkdir -p /etc/systemd/system/docker.service.d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl restart docker &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> systemctl enable docker
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>修改内核参数，确保 docker 之上所定义的桥接网络可以正常对外通信&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/sysctl.d/docker.conf &lt;span style="color:#e6db74">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">net.ipv4.ip_forward = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sysctl -p /etc/sysctl.d/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装-containerd">安装 Containerd&lt;/h3>
&lt;p>注意：&lt;/p>
&lt;ul>
&lt;li>如果想要让 Containerd 作为 Kubernetes 的 CRI，需要删除 Containerd 的配置文件(/etc/containerd/config.toml)，否则集群无法初始化，并报错:&lt;code>getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&amp;quot; , error: exit status 1&lt;/code>&lt;/li>
&lt;li>或者让 config.toml 的配置完全符合 k8s 环境运行标准&lt;/li>
&lt;li>查看 &lt;a href="https://github.com/containerd/containerd/blob/main/RELEASES.md">Containerd 的 Versioning 与 Release&lt;/a> 页面以获取与 Kubernetes 版本匹配的 Containerd 版本&lt;/li>
&lt;/ul>
&lt;h2 id="安装-kubeadmkubectlkubelet">安装 kubeadm、kubectl、kubelet&lt;/h2>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">官方文档，入门-生产环境-使用部署工具安装 Kubernetes-使用 kubeadm 引导集群-安装 kubeadm&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>安装 k8s 基本组件 kubelet，kubeadm，kubectl(&lt;a href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11aiKpn2">软件源以及安装方法详见阿里源的 kubernetes 帮助&lt;/a>)&lt;/p>
&lt;h3 id="centos">CentOS&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/yum.repos.d/kubernetes.repo &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[kubernetes]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">name=Kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">enabled=1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">gpgcheck=1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">repo_gpgcheck=1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>yum install -y kubelet kubeadm kubectl --disableexcludes&lt;span style="color:#f92672">=&lt;/span>kubernetes
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl enable kubelet
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ubuntu">Ubuntu&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo apt-get update &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> sudo apt-get install -y apt-transport-https gnupg2 curl
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/apt/sources.list.d/kubernetes.list &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo apt-get update
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo apt-get install -y kubectl
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apt-mark hold kubelet kubeadm kubectl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>apt-mark 用以保证 Ubuntu 自动更新时不更新 kubelet、kubeadm、kubectl&lt;/p>
&lt;h3 id="二进制文件">二进制文件&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 安装 CNI&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export CNI_VERSION&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;v0.8.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ARCH&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo mkdir -p /opt/cni/bin
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -L &lt;span style="color:#e6db74">&amp;#34;https://github.com/containernetworking/plugins/releases/download/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>CNI_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/cni-plugins-linux-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>ARCH&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>CNI_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">.tgz&amp;#34;&lt;/span> | sudo tar -C /opt/cni/bin -xz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 安装 crictl&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export CRICTL_VERSION&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;v1.24.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ARCH&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -L --remote-name-all &lt;span style="color:#e6db74">&amp;#34;https://github.com/kubernetes-sigs/cri-tools/releases/download/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>CRICTL_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/crictl-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>CRICTL_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">-linux-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>ARCH&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">.tar.gz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tar -zxvf crictl-&lt;span style="color:#e6db74">${&lt;/span>CRICTL_VERSION&lt;span style="color:#e6db74">}&lt;/span>-linux-&lt;span style="color:#e6db74">${&lt;/span>ARCH&lt;span style="color:#e6db74">}&lt;/span>.tar.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 安装 kubeadm、kubelet、kubectl&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export DOWNLOAD_DIR&lt;span style="color:#f92672">=&lt;/span>/usr/local/bin
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo mkdir -p $DOWNLOAD_DIR
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export RELEASE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>curl -sSL https://dl.k8s.io/release/stable.txt&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ARCH&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cd $DOWNLOAD_DIR
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/&lt;span style="color:#e6db74">${&lt;/span>RELEASE&lt;span style="color:#e6db74">}&lt;/span>/bin/linux/&lt;span style="color:#e6db74">${&lt;/span>ARCH&lt;span style="color:#e6db74">}&lt;/span>/&lt;span style="color:#f92672">{&lt;/span>kubeadm,kubelet,kubectl&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 注意，这里面的 .sevice 文件不够准确，最好从已有机器拷贝过来&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RELEASE_VERSION&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;v0.4.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -sSL &lt;span style="color:#e6db74">&amp;#34;https://raw.githubusercontent.com/kubernetes/release/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>RELEASE_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&amp;#34;&lt;/span> | sed &lt;span style="color:#e6db74">&amp;#34;s:/usr/bin:&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>DOWNLOAD_DIR&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">:g&amp;#34;&lt;/span> | sudo tee /etc/systemd/system/kubelet.service
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo mkdir -p /etc/systemd/system/kubelet.service.d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>curl -sSL &lt;span style="color:#e6db74">&amp;#34;https://raw.githubusercontent.com/kubernetes/release/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>RELEASE_VERSION&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&amp;#34;&lt;/span> | sed &lt;span style="color:#e6db74">&amp;#34;s:/usr/bin:&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>DOWNLOAD_DIR&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">:g&amp;#34;&lt;/span> | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置-kubelet-的-cgroup-驱动">配置 kubelet 的 cgroup 驱动&lt;/h2>
&lt;blockquote>
&lt;p>Note：参考&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#configure-cgroup-driver-used-by-kubelet-on-control-plane-node">此处&lt;/a>，注意要与 docker 的 Cgroup Driver 一致。不同版本，设置方式不一样&lt;/p>
&lt;/blockquote>
&lt;p>1.18.0 之前的版本使用如下配置&lt;/p>
&lt;pre>&lt;code>echo &amp;quot;KUBELET_EXTRA_ARGS=--cgroup-driver=systemd&amp;quot; &amp;gt; /etc/sysconfig/kubelet
&lt;/code>&lt;/pre>
&lt;h2 id="使用-kubeadm-初始化-k8s-的-master-节点">使用 kubeadm 初始化 k8s 的 master 节点&lt;/h2>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">官方文档&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>准备初始化所需镜像&lt;/p>
&lt;ul>
&lt;li>由于国内没法访问国际，镜像又都在谷歌上，所以需要翻墙或者提前以某些方式下载下来。如果不知道要用哪些镜像，可以直接使用 &lt;strong>kubeadm config images list&lt;/strong> 命令查看初始化时所需镜像，然后从其他镜像仓库下载下来，并使用 docker tag 命令更改镜像。可以使用阿里云的镜像仓库，地址如下：
&lt;ul>
&lt;li>registry.aliyuncs.com/k8sxio # XXX 为镜像名与版本号，zhangguanzhang 在阿里云创建的仓库&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>初始化集群的 master 节点&lt;/p>
&lt;ul>
&lt;li>
&lt;p>使用该命令进行初始化并对初始化的内容进行一些设定，如果可以没法翻墙，那么就会卡在 pull 的位置，从 google 拉不到 images(注意 IP 位置需要自己改成自己所需的 IP)&lt;/p>
&lt;p>kubeadm init &amp;ndash;kubernetes-version=v1.18.8 &amp;ndash;pod-network-cidr=10.244.0.0/16 &amp;ndash;image-repository=&amp;ldquo;registry.aliyuncs.com/k8sxio&amp;rdquo;&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>kubeadm 也可通过配置文件加载配置，以定制更丰富的部署选项，kubeadm-config.yaml 文件配置详见 《[kubeadm 命令行工具](/docs/10.云原生/2.3.Kubernetes%20 容器编排系统/Kubernetes%20 管理/kubeadm%20 命令行工具.md 管理/kubeadm 命令行工具.md)》&lt;/p>
&lt;p>kubeadm init &amp;ndash;config kubeadm-config.yaml&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装完成后如下所示，并获取到后续 node 加入集群的启动命令(注意保存该命令以便 node 节点加入 cluster 集群)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>Your Kubernetes control-plane has initialized successfully!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>To start using your cluster, you need to run the following as a regular user:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mkdir -p $HOME/.kube
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo chown &lt;span style="color:#66d9ef">$(&lt;/span>id -u&lt;span style="color:#66d9ef">)&lt;/span>:&lt;span style="color:#66d9ef">$(&lt;/span>id -g&lt;span style="color:#66d9ef">)&lt;/span> $HOME/.kube/config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>You should now deploy a pod network to the cluster.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Run &lt;span style="color:#e6db74">&amp;#34;kubectl apply -f [podnetwork].yaml&amp;#34;&lt;/span> with one of the options listed at:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> https://kubernetes.io/docs/concepts/cluster-administration/addons/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>You can now join any number of the control-plane node running the following command on each as root:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> kubeadm join 10.10.100.104:6443 --token 5b5a14.11sdexxuycp4rocs &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --discovery-token-ca-cert-hash sha256:52431bdd96837cf25621123e90d3f97619715f08fec18f1f658ec4bacf8cd7ef &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --control-plane --certificate-key 193f369208b46e494840395e04cd9fc779d46ba8288a64d621693251b81a3ae4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;kubeadm init phase upload-certs --upload-certs&amp;#34;&lt;/span> to reload certs afterward.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Then you can join any number of worker nodes by running the following on each as root:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubeadm join 10.10.100.104:6443 --token 5b5a14.11sdexxuycp4rocs &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --discovery-token-ca-cert-hash sha256:52431bdd96837cf25621123e90d3f97619715f08fec18f1f658ec4bacf8cd7ef
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>(测试环境功能)删除 master 节点的污点
&lt;ul>
&lt;li>kubectl taint nodes &amp;ndash;all node-role.kubernetes.io/master-&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="配置-kubectl-命令">配置 kubectl 命令&lt;/h2>
&lt;p>不配置 kubectl 的话，在 master 节点执行 kubectl get nodes 命令，会反馈 localhost:8080 connection refused 错误,配置方法如下：&lt;/p>
&lt;ul>
&lt;li>配置 kubectl 配置信息，并让 kubectl 支持 tab 补全命令功能
&lt;ul>
&lt;li>mkdir -p $HOME/.kube&lt;/li>
&lt;li>cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&lt;/li>
&lt;li>echo &amp;lsquo;source &amp;lt;(kubectl completion bash)&amp;rsquo; &amp;raquo; ~/.bashrc&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="部署附加组件">部署附加组件&lt;/h2>
&lt;p>安装网络组件 flannel&lt;/p>
&lt;ul>
&lt;li>kubectl apply -f &lt;a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="添加节点-node">添加节点 node&lt;/h2>
&lt;ul>
&lt;li>执行前面的 1,2,3 步配置环境，安装 docker 以及 k8s 相关组件。
&lt;ul>
&lt;li>kubeadm join 10.10.100.104:6443 &amp;ndash;token 5b5a14.11sdexxuycp4rocs \&lt;/li>
&lt;li>&amp;ndash;discovery-token-ca-cert-hash sha256:52431bdd96837cf25621123e90d3f97619715f08fec18f1f658ec4bacf8cd7ef&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>Note：
若是手动安装 node，则需要在 master 上查看 csr kubectl get csr
然后再接受该请求，即可将 node 加入集群 kubectl certificate approve node-csr-An1VRgJ7FEMMF_uyy6iPjyF5ahuLx6tJMbk2SMthwLs&lt;/p>
&lt;h1 id="清理-kubernetes-集群">清理 Kubernetes 集群&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>kubeadm reset -f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>modprobe -r ipip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lsmod
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf ~/.kube/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /etc/kubernetes/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /etc/cni
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /var/lib/etcd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /var/etcd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#最好不要清理cni的二进制文件，再次安装可能无法生成&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /opt/cni
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="升级-kubernetes-集群">升级 Kubernetes 集群&lt;/h1>
&lt;p>官方文档：&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/&lt;/a>&lt;/p>
&lt;h2 id="升级所有节点-kubeadm">升级所有节点 kubeadm&lt;/h2>
&lt;ul>
&lt;li>yum install -y kubeadm-1.19.x-0 &amp;ndash;disableexcludes=kubernetes&lt;/li>
&lt;/ul>
&lt;h2 id="升级-master">升级 master&lt;/h2>
&lt;p>升级第一个 master 节点&lt;/p>
&lt;ol>
&lt;li>确认版本信息是否为升级目标版本
&lt;ol>
&lt;li>kubeadm version&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>排空当前节点
&lt;ol>
&lt;li>kubectl drain &amp;ndash;ignore-daemonsets &lt;!-- raw HTML omitted -->&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>开始升级
&lt;ol>
&lt;li>kubeadm upgrade apply v1.19.x
&lt;ol>
&lt;li>若想更新 kubedm-config 配置，指定 &amp;ndash;config 参数
&lt;ol>
&lt;li>kubeadm upgrade apply 1.19.2 &amp;ndash;config=kubeadm-config.yaml&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>取消不可调度转台
&lt;ol>
&lt;li>kubectl uncordon &lt;!-- raw HTML omitted -->&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>升级其他 master 节点&lt;/p>
&lt;ol>
&lt;li>kubeadm upgrade node&lt;/li>
&lt;/ol>
&lt;p>升级所有 master 的 kubectl 与 kubelet 组件&lt;/p>
&lt;ol>
&lt;li>yum install -y kubelet-1.19.x-0 kubectl-1.19.x-0 &amp;ndash;disableexcludes=kubernetes&lt;/li>
&lt;li>逐一重启 kubelet&lt;/li>
&lt;li>systemctl daemon-reload &amp;amp;&amp;amp; systemctl restart kubelet&lt;/li>
&lt;/ol>
&lt;h2 id="升级-node">升级 node&lt;/h2>
&lt;p>排空节点&lt;/p>
&lt;ol>
&lt;li>kubectl drain &lt;!-- raw HTML omitted --> &amp;ndash;ignore-daemonsets&lt;/li>
&lt;/ol>
&lt;p>升级 kubelet 配置&lt;/p>
&lt;ol>
&lt;li>kubeadm upgrade node&lt;/li>
&lt;/ol>
&lt;p>升级 kubelet 和 kubectl&lt;/p>
&lt;ol>
&lt;li>yum install -y kubelet-1.19.x-0 kubectl-1.19.x-0 &amp;ndash;disableexcludes=kubernetes&lt;/li>
&lt;li>逐一重启 kubelet&lt;/li>
&lt;li>systemctl daemon-reload &amp;amp;&amp;amp; systemctl restart kubelet&lt;/li>
&lt;/ol>
&lt;p>取消不可调度转台&lt;/p>
&lt;ol>
&lt;li>kubectl uncordon &lt;!-- raw HTML omitted -->&lt;/li>
&lt;/ol>
&lt;h1 id="dual-stack双栈">Dual-stack(双栈)&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/dual-stack-support/">官方文档，快速开始-生产环境-使用部署工具安装 Kubernetes-使用 kubeadm 引导集群-使用 kubeadm 支持双栈&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/network/validate-dual-stack">官方文档，任务-网络-验证 IPv4/IPv6 双栈&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>想要创建一个双栈集群，需要注意如下几点：&lt;/p>
&lt;ul>
&lt;li>pod-network-cidr&lt;/li>
&lt;li>service-cidr&lt;/li>
&lt;li>node-ip&lt;/li>
&lt;li>在各个 Kubernetes 系统组件配置中的上述三个参数需要填写 IPv4 与 IPv6，以逗号分割&lt;/li>
&lt;li>certSANs 中添加 IPv6&lt;/li>
&lt;/ul>
&lt;p>一个初始化的 kubeadm-config.yaml 效果如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">InitConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">nodeRegistration&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">criSocket&lt;/span>: &lt;span style="color:#ae81ff">unix:///run/containerd/containerd.sock&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">kubeletExtraArgs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">node-ip&lt;/span>: &lt;span style="color:#ae81ff">172.19.42.231&lt;/span>,&lt;span style="color:#ae81ff">2001&lt;/span>:&lt;span style="color:#ae81ff">db8:0:1::231&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">ClusterConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">networking&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">podSubnet&lt;/span>: &lt;span style="color:#ae81ff">10.244.0.0&lt;/span>&lt;span style="color:#ae81ff">/16,2001:db8:42:0::/56&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">serviceSubnet&lt;/span>: &lt;span style="color:#ae81ff">10.96.0.0&lt;/span>&lt;span style="color:#ae81ff">/12,2001:db8:42:1::/112&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiServer&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">certSANs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">localhost&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">127.0.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">k8s-api.bj-test.datalake.cn&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">172.19.42.230&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">2001&lt;/span>:&lt;span style="color:#ae81ff">db8:0:1::230&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">KubeProxyConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">KubeletConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>一个 Master 节点加入集群的 kubeadm-config.yaml 效果如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">JoinConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">controlPlane&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">certificateKey&lt;/span>: &lt;span style="color:#ae81ff">248c2dea22ef4598498c265311209823884e6767ef59d5b266344b0cdd03e304&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">localAPIEndpoint&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">advertiseAddress&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;172.19.42.232&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">bindPort&lt;/span>: &lt;span style="color:#ae81ff">6443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">discovery&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">bootstrapToken&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">apiServerEndpoint&lt;/span>: &lt;span style="color:#ae81ff">k8s-api.bj-test.datalake.cn:6443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">token&lt;/span>: &lt;span style="color:#ae81ff">27wls7.3spnpsp660kekn65&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">caCertHashes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">sha256:2ae962435b870771435e5afc8f3ede6728710db49ce1ca5598d861879868a3c7&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">nodeRegistration&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">criSocket&lt;/span>: &lt;span style="color:#ae81ff">unix:///run/containerd/containerd.sock&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">kubeletExtraArgs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">node-ip&lt;/span>: &lt;span style="color:#ae81ff">172.19.42.232&lt;/span>,&lt;span style="color:#ae81ff">2001&lt;/span>:&lt;span style="color:#ae81ff">db8:0:1::232&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Node 节点加入集群的 kubeadm-config.yaml 文件效果如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">JoinConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">discovery&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">bootstrapToken&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">apiServerEndpoint&lt;/span>: &lt;span style="color:#ae81ff">k8s-api.bj-test.datalake.cn:6443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">token&lt;/span>: &lt;span style="color:#ae81ff">27wls7.3spnpsp660kekn65&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">caCertHashes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">sha256:2ae962435b870771435e5afc8f3ede6728710db49ce1ca5598d861879868a3c7&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">nodeRegistration&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">criSocket&lt;/span>: &lt;span style="color:#ae81ff">unix:///run/containerd/containerd.sock&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">kubeletExtraArgs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">node-ip&lt;/span>: &lt;span style="color:#ae81ff">172.19.42.234&lt;/span>,&lt;span style="color:#ae81ff">2001&lt;/span>:&lt;span style="color:#ae81ff">db8:0:1::234&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="验证集群双栈">验证集群双栈&lt;/h2>
&lt;p>验证是否配置了 Pod 的双栈地址范围&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#f92672">]&lt;/span>&lt;span style="color:#75715e"># for i in $(kubectl get node -oname); do kubectl get $i -o go-template --template=&amp;#39;{{range .spec.podCIDRs}}{{printf &amp;#34;%s\n&amp;#34; .}}{{end}}&amp;#39;; done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.0.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42::/64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.2.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42:3::/64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.1.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42:2::/64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.3.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42:4::/64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.4.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42:5::/64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.244.5.0/24
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2001:db8:42:6::/64
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>验证是否检测到双栈接口&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#f92672">]&lt;/span>&lt;span style="color:#75715e"># for i in $(kubectl get node -oname); do kubectl get $i -o go-template --template=&amp;#39;{{range .status.addresses}}{{printf &amp;#34;%s: %s\n&amp;#34; .type .address}}{{end}}&amp;#39;; done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.231
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::231
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.232
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::232
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.233
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::233
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.234
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::234
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.235
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::235
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 172.19.42.236
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>InternalIP: 2001:db8:0:1::236
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hostname: test-node-6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>验证 Pod 寻址&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>~&lt;span style="color:#f92672">]&lt;/span>&lt;span style="color:#75715e"># kubectl get pods pod01 -o go-template --template=&amp;#39;{{range .status.podIPs}}{{printf &amp;#34;%s\n&amp;#34; .ip}}{{end}}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: kubernetes 二进制方式安装说明</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/kubernetes-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/kubernetes-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/</guid><description>
&lt;p>首先需要明确几个概念，kubelet负责本节点容器的生命周期管理，那么在master节点上，如果只通过二进制文件运行 apiserver、controller-manager、scheduler，则无需部署 kubelet&lt;/p>
&lt;p>所以，按照大体可以划分这么几块：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>etcd节点：etcd(可部署在master节点上)。高可用至少需要3台设备&lt;/p>
&lt;/li>
&lt;li>
&lt;p>master节点：apiserver、controller-manager、scheduler。高可用至少需要2台设备。apiserver 需要与 etcd 进行交互&lt;/p>
&lt;/li>
&lt;li>
&lt;p>node节点：kubelet、CNI插件、kube-proxy&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Docs: 创建高可用 Kubernetes 集群</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8-Kubernetes-%E9%9B%86%E7%BE%A4/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/2.3.Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E7%B3%BB%E7%BB%9F/Kubernetes-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8-Kubernetes-%E9%9B%86%E7%BE%A4/</guid><description>
&lt;h1 id="概述">概述&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">官方文档，入门-生产环境-使用部署工具安装 Kubernetes-使用 kubeadm 引导集群-使用 kubeadm 创建高可用集群&lt;/a>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/setup/independent/high-availability/">https://kubernetes.io/docs/setup/independent/high-availability/&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md">Kubeadm GitHub 项目,高科用性注意事项&lt;/a>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#keepalived-and-haproxy">keepalived 和 haproxy&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#kube-vip">kube-vip&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://kube-vip.io/">kube-vip 官网&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/kc2p8h/1616120692032-ff2748b8-3aa5-4f51-a71c-3c00aa017184.png" alt="">
想要让 Kubernets 的 Master 可以高可用，本质上就是让 API Server 高可用，也就是为 API Server 创建负载均衡，通过 VIP 来访问 API Server。&lt;/p>
&lt;p>有多种方式可以实现 Kubernetes Master 节点的高可用&lt;/p>
&lt;ul>
&lt;li>在各个 Master 上负载均衡各个 Master
&lt;ul>
&lt;li>Keepalived&lt;/li>
&lt;li>kube-vip&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>在每个 Node 上负载均衡各个 Master
&lt;ul>
&lt;li>sealos&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="创建负载均衡">创建负载均衡&lt;/h2>
&lt;h3 id="keepalived-方式">Keepalived 方式&lt;/h3>
&lt;p>官方推荐版本的 keepalived 的配置&lt;/p>
&lt;pre>&lt;code>/etc/keepalived/keepalived.conf在所有主节点上创建以下配置文件：
! Configuration File for keepalived
global_defs {
router_id k8s-master-dr
script_user root
enable_script_security
}
vrrp_script check_apiserver {
script &amp;quot;/etc/keepalived/check_apiserver.sh&amp;quot;
interval 3
weight -2
fall 10
rise 2
}
vrrp_instance VI_1 {
state ${STATE}
interface ${INTERFACE}
virtual_router_id ${ROUTER_ID}
priority ${PRIORITY}
authentication {
auth_type PASS
auth_pass 4be37dc3b4c90194d1600c483e10ad1d
}
virtual_ipaddress {
${VIP}
}
track_script {
check_apiserver
}
}
&lt;/code>&lt;/pre>
&lt;ul>
&lt;li>在该部分中 vrrp_instance VI_1，根据自身情况更改：
&lt;ul>
&lt;li>STATE # 改为是 MASTER（第一主节点上）或 BACKUP（另一主节点）。&lt;/li>
&lt;li>INTERFACE # 改为将虚拟 IP 绑定到的现有公共接口的名称（通常是主接口）。&lt;/li>
&lt;li>PRIORITY # 对于第一主节点应该更高，例如 101，对于其他主节点应该更低，例如 100、99。&lt;/li>
&lt;li>PASS # 改为任何随机字符串&lt;/li>
&lt;li>VIRTUAL-IP # 改为虚拟 IP。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>下面是配套的健康检查脚本的配置&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/keepalived/check_apiserver.sh &lt;span style="color:#e6db74">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">errorExit() {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> echo &amp;#34;*** $*&amp;#34; 1&amp;gt;&amp;amp;2
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> exit 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">curl --silent --max-time 2 --insecure https://localhost:6443/healthz -o /dev/null || errorExit &amp;#34;Error GET https://localhost:6443/healthz&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">if ip addr | grep -q ${VIP}; then
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> curl --silent --max-time 2 --insecure https://${VIP}:6443/healthz -o /dev/null || errorExit &amp;#34;Error GET https://${VIP}:6443/healthz&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">fi
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chmod +x check_apiserver.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>替换其中的内容
&lt;ul>
&lt;li>${VIP} # 您选择的虚拟 IP。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>安装 keepalived(e.g.下面配置文件中 10.15 为 VIP)，并指定 RS 为 3 台 master 的 IP:PORT
&lt;ul>
&lt;li>这样，在 Node 节点上报的自身状态给 api-server 时，可以直接使用 3 台 master 的 VIP 作为通信 IP&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="kube-vip-方式">kube-vip 方式&lt;/h3>
&lt;p>配置环境变量&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>export INTERFACE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;eth0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export VIP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;172.19.42.230&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>$INTERFACE # 要生成 VIP 的网络设备&lt;/li>
&lt;li>$VIP # 要生成的 VIP&lt;/li>
&lt;/ul>
&lt;p>在每个 Master 节点生成静态 Pod 的 Manifest 文件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>nerdctl run --rm --net host docker.io/plndr/kube-vip:v0.4.1 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>manifest pod &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--interface $INTERFACE &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--address $VIP &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--controlplane &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--services &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--arp &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--leaderElection | tee /etc/kubernetes/manifests/kube-vip.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="在所有-node-创建负载均衡">在所有 Node 创建负载均衡&lt;/h2>
&lt;h3 id="sealos">Sealos&lt;/h3>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/fanux/sealos">GitHub 项目，fanux/sealos&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;img src="https://notes-learning.oss-cn-beijing.aliyuncs.com/kc2p8h/1659603459394-80959a05-8f38-490d-818e-8e3f6d4070cf.png" alt="image.png">
与方法一不同，在 node 与 api-server 通信时，不再依靠 master 上的 VIP，而是在各个 Node 本地创建一个 lvs 规则，该规则使用一个 VIP，RS 为 3 个 master 的 IP，这样，每个 Node 在上报信息时，可以使用本地的 ipvs 规则，通过 VIP 来选择与哪个 mater 通信进行信息上报&lt;/p>
&lt;p>后续步骤与方法一一样&lt;/p>
&lt;p>详见：&lt;a href="https://github.com/fanux/sealos/blob/master/README_zh.md">https://github.com/fanux/sealos/blob/master/README_zh.md&lt;/a>&lt;/p>
&lt;h1 id="使用-kubeadm-初始化-k8s-的-master-节点-ha-模式">使用 kubeadm 初始化 k8s 的 master 节点 HA 模式&lt;/h1>
&lt;p>当负载均衡创建完成呢后，即可使用 kubeadm 开始初始化 Kubernetes 集群&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">cat &amp;gt; kubeadm-config.yaml &amp;lt;&amp;lt;EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">InitConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">bootstrapTokens&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#f92672">groups&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">system:bootstrappers:kubeadm:default-node-token&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ttl&lt;/span>: &lt;span style="color:#ae81ff">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">usages&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">signing&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">authentication&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeadm.k8s.io/v1beta2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">ClusterConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kubernetesVersion&lt;/span>: &lt;span style="color:#ae81ff">1.18.8&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">controlPlaneEndpoint&lt;/span>: &lt;span style="color:#ae81ff">172.38.40.215&lt;/span>:&lt;span style="color:#ae81ff">6443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">imageRepository&lt;/span>: &lt;span style="color:#ae81ff">registry.aliyuncs.com/k8sxio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">networking&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">podSubnet&lt;/span>: &lt;span style="color:#ae81ff">10.244.0.0&lt;/span>&lt;span style="color:#ae81ff">/16&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">KubeProxyConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ipvs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">KubeletConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">cgroupDriver&lt;/span>: &lt;span style="color:#ae81ff">systemd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#初始化第一个K8s的master设备，并使用flag中的--upload-certs功能来上传证书，以便后续新加入的master节点可以直接使用这些证书，而不用手动拷贝了&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">kubeadm init --config=kubeadm-config.yaml --upload-certs&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">注意：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#kubernetesVersion应该设置为Kubernetes版本使用。这个例子使用1.16.2。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#controlPlaneEndpoint 应匹配负载均衡器的地址或DNS和端口。即VIP&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#在添加后续HA的master节点时，注意使用几个关键的flag&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">kubeadm join 172.38.40.215:6443 --token XXXX --discovery-token-ca-cert-hash sha256:XXXX --experimental-control-plane --certificate-key XXXX&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>应用适用于 HA 模式的网络插件&lt;/li>
&lt;li>复制本机的相关证书至其余节点&lt;/li>
&lt;li>在其余 master 节点上执行之前节点 init 后生成的 kubeadm join 命令，注意：命令末尾加上&amp;ndash;experimental-control-plane 这个 flag&lt;/li>
&lt;li>注意事项：
&lt;ul>
&lt;li>如果无法 init，则开启 ipvsadm 服务，如果无法加入其余 master，则关闭 ipvsadm 服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item></channel></rss>