<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – CSI</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/</link><description>Recent content in CSI on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: CSI</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/CSI/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/CSI/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/A9xWKMmrxPyOEiCs_sicYQ">公众号-阿里云云原生，一文读懂容器存储接口 CSI&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;strong>导读：&lt;/strong> 在&lt;a href="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;amp;mid=2247490043&amp;amp;idx=1&amp;amp;sn=c09ad4a9bc790f4b742abd8ca1301ffb&amp;amp;scene=21#wechat_redirect">《一文读懂 K8s 持久化存储流程》&lt;/a>一文我们重点介绍了 K8s 内部的存储流程，以及 PV、PVC、StorageClass、Kubelet 等之间的调用关系。接下来本文将将重点放在 CSI（Container Storage Interface）容器存储接口上，探究什么是 CSI 及其内部工作原理。&lt;/p>
&lt;h1 id="背景">背景&lt;a class="td-heading-self-link" href="#%e8%83%8c%e6%99%af" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>K8s 原生支持一些存储类型的 PV，如 iSCSI、NFS、CephFS 等等（详见链接），这些 in-tree 类型的存储代码放在 Kubernetes 代码仓库中。这里带来的问题是 K8s 代码与三方存储厂商的代码&lt;strong>强耦合&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>更改 in-tree 类型的存储代码，用户必须更新 K8s 组件，成本较高&lt;/li>
&lt;li>in-tree 存储代码中的 bug 会引发 K8s 组件不稳定&lt;/li>
&lt;li>K8s 社区需要负责维护及测试 in-tree 类型的存储功能&lt;/li>
&lt;li>in-tree 存储插件享有与 K8s 核心组件同等的特权，存在安全隐患&lt;/li>
&lt;li>三方存储开发者必须遵循 K8s 社区的规则开发 in-tree 类型存储代码&lt;/li>
&lt;/ul>
&lt;p>CSI 容器存储接口标准的出现解决了上述问题，将三方存储代码与 K8s 代码解耦，使得三方存储厂商研发人员只需实现 CSI 接口（无需关注容器平台是 K8s 还是 Swarm 等）。&lt;/p>
&lt;h1 id="csi-核心流程介绍">CSI 核心流程介绍&lt;a class="td-heading-self-link" href="#csi-%e6%a0%b8%e5%bf%83%e6%b5%81%e7%a8%8b%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>在详细介绍 CSI 组件及其接口之前，我们先对 K8s 中 CSI 存储流程进行一个介绍。&lt;a href="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;amp;mid=2247490043&amp;amp;idx=1&amp;amp;sn=c09ad4a9bc790f4b742abd8ca1301ffb&amp;amp;scene=21#wechat_redirect">《一文读懂 K8s 持久化存储流程》&lt;/a>一文介绍了 K8s 中的 Pod 在挂载存储卷时需经历三个的阶段：Provision/Delete（创盘/删盘）、Attach/Detach（挂接/摘除）和 Mount/Unmount（挂载/卸载），下面以图文的方式讲解 K8s 在这三个阶段使用 CSI 的流程。&lt;/p>
&lt;h3 id="1-provisioning-volumes">1. Provisioning Volumes&lt;a class="td-heading-self-link" href="#1-provisioning-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrBeY2LVjZxMVenKvU5ZKicmSw8VHGuc0Oz4e5pf4p3Obx6I0IEpTRyPg/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>&lt;strong>集群管理员&lt;/strong>创建 StorageClass 资源，该 StorageClass 中包含 CSI 插件名称（provisioner:pangu.csi.alibabacloud.com）以及存储类必须的参数（parameters: type=cloud_ssd）。sc.yaml 文件如下：&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrANJr4ZpicWLs1OCnFLhicFAU62B2k6A0ziarheficmo68kCzlCWQM9HHicQ/640?wx_fmt=png" alt="">&lt;/p>
&lt;ol start="2">
&lt;li>&lt;strong>用户&lt;/strong>创建 PersistentVolumeClaim 资源，PVC 指定存储大小及 StorageClass（如上）。pvc.yaml 文件如下：&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrutp4BzfXLmBicwlbZKic2icwyfdrONeCXriaL69aHV1dRGsV45xs8FwrAA/640?wx_fmt=png" alt="">&lt;/p>
&lt;ol start="3">
&lt;li>
&lt;p>**卷控制器（PersistentVolumeController）**观察到集群中新创建的 PVC 没有与之匹配的 PV，且其使用的存储类型为 out-of-tree，于是为 PVC 打 annotation：volume.beta.kubernetes.io/storage-provisioner=[out-of-tree CSI 插件名称]（本例中即为 provisioner:pangu.csi.alibabacloud.com）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>External Provisioner 组件&lt;/strong>观察到 PVC 的 annotation 中包含 &amp;ldquo;volume.beta.kubernetes.io/storage-provisioner&amp;rdquo; 且其 value 是自己，于是开始创盘流程。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>获取相关 StorageClass 资源并从中获取参数（本例中 parameters 为  type=cloud_ssd），用于后面 CSI 函数调用。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>通过 unix domain socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>CreateVolume 函数&lt;/strong>。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ol start="5">
&lt;li>
&lt;p>&lt;strong>外部 CSI 插件&lt;/strong>返回成功后表示盘创建完成，此时 &lt;strong>External Provisioner 组件&lt;/strong>会在集群创建一个 PersistentVolume 资源。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>卷控制器&lt;/strong>会将 PV 与 PVC 进行绑定。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrJDTQYxaVvDX4VPpF2qCeXNPAuG4lYLYsO91gG51s5mrrQtoAkFK0gQ/640?wx_fmt=png" alt="">&lt;/p>
&lt;h3 id="2-attaching-volumes">&lt;strong>2. Attaching Volumes&lt;/strong>&lt;a class="td-heading-self-link" href="#2-attaching-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrDnVdvz0ibIzE0rqPvICXvWdHGosbgU2UCDGtImAVbCYNSQ6gEgoXfow/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>**AD 控制器（AttachDetachController）&lt;strong>观察到使用 CSI 类型 PV 的 Pod 被调度到某一节点，此时 &lt;strong>AD 控制器&lt;/strong>会调用&lt;/strong>内部 in-tree CSI 插件（csiAttacher）**的 Attach 函数。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>**内部 in-tree CSI 插件（csiAttacher）**会创建一个 VolumeAttachment 对象到集群中。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>External Attacher&lt;/strong>观察到该 VolumeAttachment 对象，并调用&lt;strong>外部 CSI&lt;/strong> &lt;strong>插件&lt;/strong>的 &lt;strong>ControllerPublish 函数&lt;/strong>以将卷挂接到对应节点上。&lt;strong>外部 CSI 插件&lt;/strong>挂载成功后，&lt;strong>External Attacher&lt;/strong> 会更新相关 VolumeAttachment 对象的 .Status.Attached 为 true。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPr3VQrSYwJScqw9NmzQWEb2EiavN62qibOtY8UqsHf7pJOgd0dGfH51J7A/640?wx_fmt=png" alt="">&lt;/p>
&lt;ol start="4">
&lt;li>**AD 控制器内部 in-tree CSI 插件（csiAttacher）**观察到 VolumeAttachment 对象的 .Status.Attached 设置为 true，于是更新 &lt;strong>AD 控制器&lt;/strong>内部状态（ActualStateOfWorld），该状态会显示在 Node 资源的 .Status.VolumesAttached 上。&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrCEstrgCCXic5WRlHKcqo9tsay8vlFtC16iaw7ibNgztibNUBF7T0Wa5GjA/640?wx_fmt=png" alt="">&lt;/p>
&lt;h3 id="3-mounting-volumes">&lt;strong>3. Mounting Volumes&lt;/strong>&lt;a class="td-heading-self-link" href="#3-mounting-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrLCMro57TU3k6Y4n5rJshOXjyuUDSxm07DFrkwFc0PrJnQWCIuNjJMQ/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>**Volume Manager（Kubelet 组件）&lt;strong>观察到有新的使用 CSI 类型 PV 的 Pod 调度到本节点上，于是调用&lt;/strong>内部 in-tree CSI 插件（csiAttacher）**的 WaitForAttach 函数。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>**内部 in-tree CSI 插件（csiAttacher）**等待集群中 VolumeAttachment 对象状态 .Status.Attached 变为 true。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>in-tree CSI 插件（csiAttacher）&lt;strong>调用 MountDevice 函数，该函数内部通过 unix domain socket 调用&lt;/strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodeStageVolume 函数&lt;/strong>；之后&lt;strong>插件（csiAttacher）&lt;strong>调用&lt;/strong>内部 in-tree CSI 插件（csiMountMgr）&lt;strong>的 SetUp 函数，该函数内部会通过 unix domain socket 调用&lt;/strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodePublishVolume 函数&lt;/strong>。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="4-unmounting-volumes">&lt;strong>4. Unmounting Volumes&lt;/strong>&lt;a class="td-heading-self-link" href="#4-unmounting-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrQe0rqRuybVvWT35SIHKS5SicLNrkyy0NeEWssojJpqyKw2cScnET8cg/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>用户&lt;/strong>删除相关 Pod。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Volume Manager（Kubelet 组件）&lt;strong>观察到包含 CSI 存储卷的 Pod 被删除，于是调用&lt;/strong>内部 in-tree CSI 插件（csiMountMgr）&lt;strong>的 TearDown 函数，该函数内部会通过 unix domain socket 调用&lt;/strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodeUnpublishVolume 函数&lt;/strong>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Volume Manager（Kubelet 组件）&lt;strong>调用&lt;/strong>内部 in-tree CSI 插件（csiAttacher）&lt;strong>的 UnmountDevice 函数，该函数内部会通过 unix domain socket 调用&lt;/strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodeUnpublishVolume 函数&lt;/strong>。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="5-detaching-volumes">&lt;strong>5. Detaching Volumes&lt;/strong>&lt;a class="td-heading-self-link" href="#5-detaching-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrXZxdCa6icByCacuAZetQqxVfVRNFx3EIt4g8DvFrNPmvyIjSHGSKRzg/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>AD 控制器&lt;/strong>观察到包含 CSI 存储卷的 Pod 被删除，此时该控制器会调用**内部 in-tree CSI 插件（csiAttacher）**的 Detach 函数。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>csiAttache****r&lt;/strong> 会删除集群中相关 VolumeAttachment 对象（但由于存在 finalizer，va 对象不会立即删除）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>External Attacher&lt;/strong> 观察到集群中 VolumeAttachment 对象的 DeletionTimestamp 非空，于是调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>ControllerUnpublish 函数&lt;/strong>以将卷从对应节点上摘除。&lt;strong>外部 CSI 插件&lt;/strong>摘除成功后，&lt;strong>External Attacher&lt;/strong> 会移除相关 VolumeAttachment 对象的 finalizer 字段，此时 VolumeAttachment 对象被彻底删除。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>AD 控制器&lt;/strong>中**内部 in-tree CSI 插件（csiAttacher）**观察到 VolumeAttachment 对象已删除，于是更新 &lt;strong>AD 控制器&lt;/strong>中的内部状态；同时 &lt;strong>AD 控制器&lt;/strong>更新 Node 资源，此时 Node 资源的 .Status.VolumesAttached 上已没有相关挂接信息。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="6-deleting-volumes">&lt;strong>6. Deleting Volumes&lt;/strong>&lt;a class="td-heading-self-link" href="#6-deleting-volumes" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_jpg/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrUnvXdic5KwU7cRfGTUkOG17ol0Dnicj177dzzzRLiam3XLKZUvPQwcicjQ/640?wx_fmt=jpeg" alt="">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>用户&lt;/strong>删除相关 PVC。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>External Provisioner 组件&lt;/strong>观察到 PVC 删除事件，根据 PVC 的回收策略（Reclaim）执行不同操作：&lt;/p>
&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>Delete：调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>DeleteVolume 函数&lt;/strong>以删除卷；一旦卷成功删除，&lt;strong>Provisioner&lt;/strong> 会删除集群中对应 PV 对象。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Retain：&lt;strong>Provisione&lt;/strong> 不执行卷删除操作。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="csi-sidecar-组件介绍">CSI Sidecar 组件介绍&lt;a class="td-heading-self-link" href="#csi-sidecar-%e7%bb%84%e4%bb%b6%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>为使 K8s 适配 CSI 标准，社区将与 K8s 相关的存储流程逻辑放在了 CSI Sidecar 组件中。&lt;/p>
&lt;h2 id="1-node-driver-registrar">1. Node Driver Registrar&lt;a class="td-heading-self-link" href="#1-node-driver-registrar" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="1功能">&lt;strong>1）功能&lt;/strong>&lt;a class="td-heading-self-link" href="#1%e5%8a%9f%e8%83%bd" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>Node-Driver-Registrar 组件&lt;/strong>会将&lt;strong>外部 CSI 插件&lt;/strong>注册到 &lt;strong>Kubelet&lt;/strong>，从而使 &lt;strong>Kubelet&lt;/strong> 通过特定的 Unix Domain Socket 来调用&lt;strong>外部 CSI 插件函数&lt;/strong>（Kubelet 会调用外部 CSI 插件的 NodeGetInfo、NodeStageVolume、NodePublishVolume、NodeGetVolumeStats 等函数）。&lt;/p>
&lt;h3 id="2原理">&lt;strong>2）原理&lt;/strong>&lt;a class="td-heading-self-link" href="#2%e5%8e%9f%e7%90%86" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>Node-Driver-Registrar 组件&lt;/strong>通过Kubelet 外部插件注册机制实现注册，注册成功后：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Kubelet&lt;/strong> 为本节点 Node 资源打 annotation：&lt;strong>Kubelet&lt;/strong> 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodeGetInfo 函数&lt;/strong>，其返回值 [nodeID]、[driverName] 将作为值用于 &amp;ldquo;csi.volume.kubernetes.io/nodeid&amp;rdquo; 键。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Kubelet&lt;/strong> 更新 Node Label：将 &lt;strong>NodeGetInfo 函数&lt;/strong>返回的 [AccessibleTopology] 值用于节点的 Label。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Kubelet&lt;/strong> 更新 Node Status：将 &lt;strong>NodeGetInfo 函数&lt;/strong>返回的 maxAttachLimit（节点最大可挂载卷数量）更新到 Node 资源的 Status.Allocatable：attachable-volumes-csi-[driverName]=[maxAttachLimit]。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://mmbiz.qpic.cn/mmbiz_png/yvBJb5IiafvnZrRu67Cf0RQ5ToaxdqVPrBmrHGPKfvIpb11zVlVHicPqfFjRCCbUNSgNsufaCca3U0mgWVp3qQGg/640?wx_fmt=png" alt="">&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Kubelet&lt;/strong> 更新 CSINode 资源（没有则创建）：将 [driverName]、[nodeID]、[maxAttachLimit]、[AccessibleTopology] 更新到 Spec 中（拓扑仅保留 Key 值）。&lt;/li>
&lt;/ul>
&lt;h2 id="2-external-provisioner">2. External Provisioner&lt;a class="td-heading-self-link" href="#2-external-provisioner" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="1功能-1">&lt;strong>1）功能&lt;/strong>&lt;a class="td-heading-self-link" href="#1%e5%8a%9f%e8%83%bd-1" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>创建/删除实际的存储卷，以及代表存储卷的 PV 资源。&lt;/p>
&lt;h3 id="2原理-1">&lt;strong>2）原理&lt;/strong>&lt;a class="td-heading-self-link" href="#2%e5%8e%9f%e7%90%86-1" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>External-Provisioner&lt;/strong> 在启动时需指定参数 -- provisioner，该参数指定 Provisioner 名称，与 StorageClass 中的 provisioner 字段对应。&lt;/p>
&lt;p>&lt;strong>External-Provisioner&lt;/strong> 启动后会 watch 集群中的 PVC 和 PV 资源。&lt;/p>
&lt;p>对于集群中的 PVC 资源：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>判断 PVC 是否需要动态创建存储卷，标准如下：&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PVC 的 annotation 中是否包含 &amp;ldquo;volume.beta.kubernetes.io/storage-provisioner&amp;rdquo; 键（由卷控制器创建），并且其值是否与 Provisioner 名称相等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PVC 对应 StorageClass 的 VolumeBindingMode 字段若为 WaitForFirstConsumer，则 PVC 的 annotation 中必须包含 &amp;ldquo;volume.kubernetes.io/selected-node&amp;rdquo; 键（详见调度器如何处理 WaitForFirstConsumer），且其值不为空；若为 Immediate 则表示需要 Provisioner 立即提供动态存储卷。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>CreateVolume 函数&lt;/strong>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>创建 PV 资源，PV 名称为 [Provisioner 指定的 PV 前缀] - [PVC uuid]。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>对于集群中的 PV 资源：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>判断 PV 是否需要删除，标准如下：&lt;/p>
&lt;/li>
&lt;li>
&lt;p>判断其 .Status.Phase 是否为 Release。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>判断其 .Spec.PersistentVolumeReclaimPolicy 是否为 Delete。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>判断其是否包含 annotation（pv.kubernetes.io/provisioned-by），且其值是否为自己。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>DeleteVolume 接口&lt;/strong>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>删除集群中的 PV 资源。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="3-external-attacher">3. External Attacher&lt;a class="td-heading-self-link" href="#3-external-attacher" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="1功能-2">&lt;strong>1）功能&lt;/strong>&lt;a class="td-heading-self-link" href="#1%e5%8a%9f%e8%83%bd-2" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>挂接/摘除存储卷。&lt;/p>
&lt;h3 id="2原理-2">&lt;strong>2）原理&lt;/strong>&lt;a class="td-heading-self-link" href="#2%e5%8e%9f%e7%90%86-2" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>External-Attacher&lt;/strong>内部会时刻 watch 集群中的 VolumeAttachment 资源和 PersistentVolume 资源。&lt;/p>
&lt;p>对于 VolumeAttachment 资源：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>从 VolumeAttachment 资源中获得 PV 的所有信息，如 volume ID、node ID、挂载 Secret 等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>判断 VolumeAttachment 的 DeletionTimestamp 字段是否为空来判断其为卷挂接或卷摘除：若为卷挂接则通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>ControllerPublishVolume 接口&lt;/strong>；若为卷摘除则通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>ControllerUnpublishVolume 接口&lt;/strong>。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>对于 PersistentVolume 资源：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在挂接时为相关 PV 打上 Finalizer：external-attacher/[driver 名称]。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当 PV 处于删除状态时（DeletionTimestamp 非空），删除 Finalizer：external-attacher/[driver 名称]。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="4-external-resizer">4. External Resizer&lt;a class="td-heading-self-link" href="#4-external-resizer" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="1功能-3">&lt;strong>1）功能&lt;/strong>&lt;a class="td-heading-self-link" href="#1%e5%8a%9f%e8%83%bd-3" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>扩容存储卷。&lt;/p>
&lt;h3 id="2原理-3">&lt;strong>2）原理&lt;/strong>&lt;a class="td-heading-self-link" href="#2%e5%8e%9f%e7%90%86-3" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>External-Resizer&lt;/strong> 内部会 watch 集群中的 PersistentVolumeClaim 资源。&lt;/p>
&lt;p>对于 PersistentVolumeClaim 资源：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>判断 PersistentVolumeClaim 资源是否需要扩容：PVC 状态需要是 Bound 且 .Status.Capacity 与 .Spec.Resources.Requests 不等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更新 PVC 的 .Status.Conditions，表明此时处于 Resizing 状态。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>ControllerExpandVolume 接口&lt;/strong>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更新 PV 的 .Spec.Capacity。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若 CSI 支持文件系统在线扩容，ControllerExpandVolume 接口返回值中 NodeExpansionRequired 字段为 true，&lt;strong>External-Resizer&lt;/strong> 更新 PVC 的 .Status.Conditions 为 FileSystemResizePending 状态；若不支持则扩容成功，&lt;strong>External-Resizer&lt;/strong> 更新 PVC 的 .Status.Conditions 为空，且更新 PVC 的 .Status.Capacity。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Volume Manager（Kubelet 组件）&lt;strong>观察到存储卷需在线扩容，于是通过特定的 Unix Domain Socket 调用&lt;/strong>外部 CSI 插件&lt;/strong>的 &lt;strong>NodeExpandVolume 接口&lt;/strong>实现文件系统扩容。&lt;/p>
&lt;h2 id="5-livenessprobe">5. livenessprobe&lt;a class="td-heading-self-link" href="#5-livenessprobe" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="1功能-4">&lt;strong>1）功能&lt;/strong>&lt;a class="td-heading-self-link" href="#1%e5%8a%9f%e8%83%bd-4" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>检查 CSI 插件是否正常。&lt;/p>
&lt;h3 id="2原理-4">&lt;strong>2）原理&lt;/strong>&lt;a class="td-heading-self-link" href="#2%e5%8e%9f%e7%90%86-4" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>通过对外暴露一个 / healthz HTTP 端口以服务 kubelet 的探针探测器，内部是通过特定的 Unix Domain Socket 调用&lt;strong>外部 CSI 插件&lt;/strong>的 &lt;strong>Probe 接口&lt;/strong>。&lt;/p>
&lt;h1 id="csi-接口介绍">CSI 接口介绍&lt;a class="td-heading-self-link" href="#csi-%e6%8e%a5%e5%8f%a3%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>三方存储厂商需实现 CSI 插件的三大接口：&lt;strong>IdentityServer、ControllerServer、NodeServer&lt;/strong>。&lt;/p>
&lt;h2 id="1-identityserver">1. IdentityServer&lt;a class="td-heading-self-link" href="#1-identityserver" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>IdentityServer 主要用于认证 CSI 插件的身份信息。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">IdentityServer&lt;/span> &lt;span style="color:#204a87;font-weight:bold">interface&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">GetPluginInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetPluginInfoRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetPluginInfoResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">GetPluginCapabilities&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetPluginCapabilitiesRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetPluginCapabilitiesResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Probe&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ProbeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ProbeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-controllerserver">2. ControllerServer&lt;a class="td-heading-self-link" href="#2-controllerserver" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>ControllerServer 主要负责存储卷及快照的创建/删除以及挂接/摘除操作。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">ControllerServer&lt;/span> &lt;span style="color:#204a87;font-weight:bold">interface&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">CreateVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">CreateVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">CreateVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">DeleteVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">DeleteVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">DeleteVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ControllerPublishVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerPublishVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerPublishVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ControllerUnpublishVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerUnpublishVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerUnpublishVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ValidateVolumeCapabilities&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ValidateVolumeCapabilitiesRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ValidateVolumeCapabilitiesResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ListVolumes&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ListVolumesRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ListVolumesResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">GetCapacity&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetCapacityRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">GetCapacityResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ControllerGetCapabilities&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerGetCapabilitiesRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerGetCapabilitiesResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">CreateSnapshot&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">CreateSnapshotRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">CreateSnapshotResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">DeleteSnapshot&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">DeleteSnapshotRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">DeleteSnapshotResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ListSnapshots&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ListSnapshotsRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ListSnapshotsResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">ControllerExpandVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerExpandVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ControllerExpandVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="3-nodeserver">3. NodeServer&lt;a class="td-heading-self-link" href="#3-nodeserver" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>NodeServer 主要负责存储卷挂载/卸载操作。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-typescript" data-lang="typescript">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">NodeServer&lt;/span> &lt;span style="color:#204a87;font-weight:bold">interface&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeStageVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeStageVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeStageVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeUnstageVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeUnstageVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeUnstageVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodePublishVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodePublishVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodePublishVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeUnpublishVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeUnpublishVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeUnpublishVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeGetVolumeStats&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetVolumeStatsRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetVolumeStatsResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeExpandVolume&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeExpandVolumeRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeExpandVolumeResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeGetCapabilities&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetCapabilitiesRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetCapabilitiesResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">NodeGetInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetInfoRequest&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">NodeGetInfoResponse&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="k8s-csi-api-对象">K8s CSI API 对象&lt;a class="td-heading-self-link" href="#k8s-csi-api-%e5%af%b9%e8%b1%a1" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>K8s 为支持 CSI 标准，包含如下 API 对象：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>CSINode&lt;/p>
&lt;/li>
&lt;li>
&lt;p>CSIDriver&lt;/p>
&lt;/li>
&lt;li>
&lt;p>VolumeAttachment&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="1-csinode">1. CSINode&lt;a class="td-heading-self-link" href="#1-csinode" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">apiVersion&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">storage.k8s.io/v1beta1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">kind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">CSINode&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">node-10.212.101.210&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">drivers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">name: yodaplugin.csi.alibabacloud.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">nodeID&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">node-10.212.101.210&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">topologyKeys&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">kubernetes.io/hostname&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">name: pangu.csi.alibabacloud.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">nodeID&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">a5441fd9013042ee8104a674e4a9666a&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">topologyKeys&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">topology.pangu.csi.alibabacloud.com/zone&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>作用：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>判断&lt;strong>外部 CSI 插件&lt;/strong>是否注册成功。在 Node Driver Registrar 组件向 Kubelet 注册完毕后，Kubelet 会创建该资源，故不需要显式创建 CSINode 资源。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>将 Kubernetes 中 Node 资源名称与三方存储系统中节点名称（nodeID）一一对应。此处 &lt;strong>Kubelet&lt;/strong> 会调用&lt;strong>外部 CSI 插件&lt;/strong> NodeServer 的 &lt;strong>GetNodeInfo 函数&lt;/strong>获取 nodeID。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>显示卷拓扑信息。CSINode 中 topologyKeys 用来表示存储节点的拓扑信息，卷拓扑信息会使得 &lt;strong>Scheduler&lt;/strong> 在 Pod 调度时选择合适的存储节点。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="2-csidriver">2. CSIDriver&lt;a class="td-heading-self-link" href="#2-csidriver" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">apiVersion&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">storage.k8s.io/v1beta1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">kind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">CSIDriver&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">pangu.csi.alibabacloud.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">attachRequired&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">podInfoOnMount&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">volumeLifecycleModes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">Persistent&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>作用：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>简化&lt;strong>外部 CSI 插件&lt;/strong>的发现。由集群管理员创建，通过 kubectl get csidriver 即可得知环境上有哪些 CSI 插件。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>自定 义Kubernetes 行为，如一些外部 CSI 插件不需要执行卷挂接（VolumeAttach）操作，则可以设置 .spec.attachRequired 为 false。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="3-volumeattachment">3. VolumeAttachment&lt;a class="td-heading-self-link" href="#3-volumeattachment" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">apiVersion&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">storage.k8s.io/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">kind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">VolumeAttachment&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">annotations&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">csi.alpha.kubernetes.io/node-id&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">21481ae252a2457f9abcb86a3d02ba05&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">finalizers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">external-attacher/pangu-csi-alibabacloud-com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">csi-0996e5e9459e1ccc1b3a7aba07df4ef7301c8e283d99eabc1b69626b119ce750&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">attacher&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">pangu.csi.alibabacloud.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">nodeName&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">node-10.212.101.241&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">source&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">persistentVolumeName&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">pangu-39aa24e7-8877-11eb-b02f-021234350de1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">status&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">attached&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>作用：VolumeAttachment 记录了存储卷的挂接/摘除信息以及节点信息。&lt;/p>
&lt;h1 id="支持特性">支持特性&lt;a class="td-heading-self-link" href="#%e6%94%af%e6%8c%81%e7%89%b9%e6%80%a7" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="1-拓扑支持">1. 拓扑支持&lt;a class="td-heading-self-link" href="#1-%e6%8b%93%e6%89%91%e6%94%af%e6%8c%81" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>在 StorageClass 中有 AllowedTopologies 字段：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">apiVersion&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">storage.k8s.io/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">kind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">StorageClass&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">csi-pangu&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">provisioner&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">pangu.csi.alibabacloud.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">parameters&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">type&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">cloud_ssd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">volumeBindingMode&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">Immediate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">allowedTopologies&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">matchLabelExpressions:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">key: topology.pangu.csi.alibabacloud.com/zone&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">values&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">zone-1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">zone-2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>外部 CSI 插件&lt;/strong>部署后会为每个节点打标，打标内容 &lt;strong>NodeGetInfo 函数&lt;/strong>返回的 [AccessibleTopology] 值（详见 Node Driver Registrar 部分）。&lt;/p>
&lt;p>&lt;strong>External Provisioner&lt;/strong> 在调用 CSI 插件的 CreateVolume 接口之前，会在请求参数设置 AccessibilityRequirements：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>对于 WaitForFirstConsumer&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当 PVC 的 anno 中包含 &amp;ldquo;volume.kubernetes.io/selected-node&amp;rdquo; 且不为空，则先获取对应节点 CSINode 的 TopologyKeys，然后根据该 TopologyKeys 键从 Node 资源的 Label 获取 Values 值，最后拿该 Values 值与 StorageClass 的 AllowedTopologies 比对，判断其是否包含于其中；若不包含则报错。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>对于 Immediately&lt;/p>
&lt;/li>
&lt;li>
&lt;p>将 StorageClass 的 AllowedTopologies 的值填进来，若 StorageClass 没有设置 AllowedTopologies 则将所有包含 TopologyKeys 键的节点 Value 添进来。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="scheduler-如何处理使用存储卷调度">Scheduler 如何处理使用存储卷调度&lt;a class="td-heading-self-link" href="#scheduler-%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e4%bd%bf%e7%94%a8%e5%ad%98%e5%82%a8%e5%8d%b7%e8%b0%83%e5%ba%a6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>基于社区 1.18 版本调度器&lt;/p>
&lt;/blockquote>
&lt;p>调度器的调度过程主要有如下三步：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>预选（Filter）&lt;/strong>：筛选满足Pod调度要求的节点列表。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>优选（Score）&lt;/strong>：通过内部的优选算法为节点打分，获得最高分数的节点即为选中的节点。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>绑定（Bind）&lt;/strong>：调度器将调度结果通知给 kube-apiserver，更新 Pod 的 .spec.nodeName 字段。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>调度器预选阶段：处理 Pod 的 PVC/PV 绑定关系以及动态供应 PV（Dynamic Provisioning），同时使调度器调度时考虑 Pod 所使用 PV 的节点亲和性。详细调度过程如下：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Pod 不包含 PVC 直接跳过。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>FindPodVolumes&lt;/p>
&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>获取 Pod 的 boundClaims、claimsToBind 以及 unboundClaimsImmediate。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>boundClaims：已 Bound 的 PVC&lt;/p>
&lt;/li>
&lt;li>
&lt;p>claimsToBind：PVC 对应 StorageClass 的 VolumeBindingMode 为 VolumeBindingWaitForFirstConsumer&lt;/p>
&lt;/li>
&lt;li>
&lt;p>unboundClaimsImmediate：PVC 对应 StorageClass 的 VolumeBindingMode 为 VolumeBindingImmediate&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若 len(unboundClaimsImmediate) 不为空，表示这种 PVC 需要立即绑定 PV（即存 PVC 创建后，立刻动态创建 PV 并将其绑定到 PVC，该过程不走调度），若 PVC 处于 unbound 阶段则报错。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若 len(boundClaims) 不为空，则检查 PVC 对应 PV 的节点亲和性与当前节点的 Label 是否冲突，若冲突则报错（可检查 Immediate 类型的 PV 拓扑）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若 len(claimsToBind) 不为空&lt;/p>
&lt;/li>
&lt;li>
&lt;p>先检查环境中已有的 PV 能否与该 PVC 匹配（findMatchingVolumes），将能够匹配 PVC 的 PV 记录在调度器的 cache 中。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>未匹配到 PV 的 PVC 走动态调度流程，动态调度主要通过 StorageClass 的 AllowedTopologies 字段判断当前调度节点是否满足拓扑要求（针对 WaitForFirstConsumer 类型的 PVC）。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>调度器优选阶段不讨论。&lt;/p>
&lt;p>调度器 Assume 阶段&lt;/p>
&lt;blockquote>
&lt;p>调度器会先 Assume PV/PVC，再 Assume Pod。&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>
&lt;p>将当前待调度的 Pod 进行深拷贝。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>AssumePodVolumes（针对 WaitForFirstConsumer 类型的 PVC）&lt;/p>
&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>更改调度器 cache 中已经 Match 的 PV 信息：设置 annotation：pv.kubernetes.io/bound-by-controller=&amp;ldquo;yes&amp;rdquo;。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更改调度器 cache 中未匹配到 PV 的 PVC，设置 annotation：volume.kubernetes.io/selected-node=【所选节点】。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ol start="3">
&lt;li>Assume Pod 完毕&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>更改调度器 cache 中 Pod 的 .Spec.NodeName 为【所选节点】。&lt;/li>
&lt;/ul>
&lt;p>调度器 Bind 阶段&lt;/p>
&lt;p>BindPodVolumes：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>调用 Kubernetes 的 API 更新集群中 PV/PVC 资源，使其与调度器 Cache 中的 PV/PVC 一致。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>检查 PV/PVC 状态：&lt;/p>
&lt;/li>
&lt;li>
&lt;p>检查所有 PVC 是否已处于 Bound 状态。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>检查所有 PV 的 NodeAffinity 是否与节点 Label 冲突。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>调度器执行 Bind 操作：调用 Kubernetes 的 API 更新 Pod 的 .Spec.NodeName 字段。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="2-存储卷扩容">&lt;strong>2. 存储卷扩容&lt;/strong>&lt;a class="td-heading-self-link" href="#2-%e5%ad%98%e5%82%a8%e5%8d%b7%e6%89%a9%e5%ae%b9" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>存储卷扩容部分在 External Resizer 部分已提到，故不再赘述。用户只需要编辑 PVC 的 .Spec.Resources.Requests.Storage 字段即可，注意只可扩容不可缩容。&lt;/p>
&lt;p>若 PV 扩容失败，此时 PVC 无法重新编辑 spec 字段的 storage 为原来的值（只可扩容不可缩容）。参考 K8s 官网提供的 PVC 还原方法：&lt;/p>
&lt;p>&lt;em>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#recovering-from-failure-when-expanding-volumes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#recovering-from-failure-when-expanding-volumes&lt;/a>&lt;/em>&lt;/p>
&lt;h2 id="3-单节点卷数量限制">3. 单节点卷数量限制&lt;a class="td-heading-self-link" href="#3-%e5%8d%95%e8%8a%82%e7%82%b9%e5%8d%b7%e6%95%b0%e9%87%8f%e9%99%90%e5%88%b6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>卷数量限制在 Node Driver Registrar 部分已提到，故不再赘述。&lt;/p>
&lt;h2 id="4-存储卷监控">4. 存储卷监控&lt;a class="td-heading-self-link" href="#4-%e5%ad%98%e5%82%a8%e5%8d%b7%e7%9b%91%e6%8e%a7" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>存储商需实现 CSI 插件的 NodeGetVolumeStats 接口，Kubelet 会调用该函数，并反映在其 metrics上：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>kubelet_volume_stats_capacity_bytes：存储卷容量&lt;/p>
&lt;/li>
&lt;li>
&lt;p>kubelet_volume_stats_used_bytes：存储卷已使用容量&lt;/p>
&lt;/li>
&lt;li>
&lt;p>kubelet_volume_stats_available_bytes：存储卷可使用容量&lt;/p>
&lt;/li>
&lt;li>
&lt;p>kubelet_volume_stats_inodes：存储卷 inode 总量&lt;/p>
&lt;/li>
&lt;li>
&lt;p>kubelet_volume_stats_inodes_used：存储卷 inode 使用量&lt;/p>
&lt;/li>
&lt;li>
&lt;p>kubelet_volume_stats_inodes_free：存储卷 inode 剩余量&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="5-secret">5. Secret&lt;a class="td-heading-self-link" href="#5-secret" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>CSI 存储卷支持传入 Secret 来处理不同流程中所需要的私密数据，目前 StorageClass 支持如下 Parameter：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>csi.storage.k8s.io/provisioner-secret-name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/provisioner-secret-namespace&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/controller-publish-secret-name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/controller-publish-secret-namespace&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/node-stage-secret-name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/node-stage-secret-namespace&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/node-publish-secret-name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/node-publish-secret-namespace&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/controller-expand-secret-name&lt;/p>
&lt;/li>
&lt;li>
&lt;p>csi.storage.k8s.io/controller-expand-secret-namespace&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Secret 会包含在对应 CSI 接口的参数中，如对于 CreateVolume 接口而言则包含在 CreateVolumeRequest.Secrets 中。&lt;/p>
&lt;h2 id="6-块设备">6. 块设备&lt;a class="td-heading-self-link" href="#6-%e5%9d%97%e8%ae%be%e5%a4%87" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">apiVersion&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">apps/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">kind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">StatefulSet&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">nginx-example&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">selector&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">matchLabels&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">app&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">serviceName&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;nginx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">volumeClaimTemplates&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">metadata:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">html&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">accessModes&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">ReadWriteOnce&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">volumeMode&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">Block&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">storageClassName&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">csi-pangu&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">resources&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">requests&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">storage&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">40Gi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">template&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">metadata&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">labels&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">app&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">spec&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">containers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">name: nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">image&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">volumeDevices&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">-&lt;/span> &lt;span style="color:#4e9a06">devicePath: &amp;#34;/dev/vdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c4a000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">html&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>三方存储厂商需实现 NodePublishVolume 接口。Kubernetes 提供了针对块设备的工具包（&amp;ldquo;k8s.io/kubernetes/pkg/util/mount&amp;rdquo;），在 NodePublishVolume 阶段可调用该工具的 EnsureBlock 和 MountBlock 函数。&lt;/p>
&lt;h2 id="7-卷快照卷克隆能力">7. 卷快照/卷克隆能力&lt;a class="td-heading-self-link" href="#7-%e5%8d%b7%e5%bf%ab%e7%85%a7%e5%8d%b7%e5%85%8b%e9%9a%86%e8%83%bd%e5%8a%9b" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>鉴于本文篇幅，此处不做过多原理性介绍。读者感兴趣见官方介绍：卷快照、卷克隆。&lt;/p>
&lt;h1 id="总结">总结&lt;a class="td-heading-self-link" href="#%e6%80%bb%e7%bb%93" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>本文首先对 CSI 核心流程进行了大体介绍，并结合 CSI Sidecar 组件、CSI 接口、API 对象对 CSI 标准进行了深度解析。在 K8s 上，使用任何一种 CSI 存储卷都离不开上面的流程，环境上的容器存储问题也一定是其中某个环节出现了问题。&lt;/p></description></item><item><title>Docs: longhorn</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/longhorn/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/longhorn/</guid><description>
&lt;h1 id="heading">&lt;a class="td-heading-self-link" href="#heading" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h1 id="longhorn-介绍">Longhorn 介绍&lt;a class="td-heading-self-link" href="#longhorn-%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>官方文档：&lt;a href="https://longhorn.io/docs">https://longhorn.io/docs&lt;/a>&lt;/p>
&lt;p>Longhorn 是一个用于 Kubernetes 的轻量、可靠且功能强大的分布式 block storage(块存储) 系统&lt;/p></description></item><item><title>Docs: Rook</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/Rook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E5%AD%98%E5%82%A8/CSI/Rook/</guid><description/></item></channel></rss>