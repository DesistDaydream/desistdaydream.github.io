<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>断念梦的站点 – K3S</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/</link><description>Recent content in K3S on 断念梦的站点</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: K3S</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/k3s-io/k3s">GitHub 项目，k3s-io/k3s&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://rancher.com/docs/k3s/latest/en/">官方文档&lt;/a>
&lt;ul>
&lt;li>&lt;a href="https://docs.rancher.cn/k3s/">中文官方文档&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/ARhxWGypG0wepMqwTLH0mQ">公众号-云原生实验室，K3S 工具进阶完全指南&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>K3S 是一个轻量的 Kubernetes，具有基本的 kubernetes 功能，将 kubernetes 的主要组件都集成在一个二进制文件中(apiserver、kubelet 等)，这个二进制文件只有不到 100m。内嵌 Containerd，可以通过 Containerd 来启动 coredns 等 kubernetes 的 addone。直接使用 k3s 的二进制文件，即可启动一个 kubernetes 的节点。&lt;/p>
&lt;p>Note: K3S 的 kubelet 不支持 systemd 作为 cgroup-driver，原因详见 &lt;a href="https://github.com/rancher/k3s/issues/797">https://github.com/rancher/k3s/issues/797&lt;/a> ，说是 systemd 的类型无法放进二进制文件里。&lt;/p>
&lt;p>k3s 二进制文件包含 kubelet、api-server、kube-controller-manager、kube-scheduler，然后会通过 containerd 拉起 coredns 与 flannel。&lt;/p>
&lt;h2 id="k3s-封装的组件">K3S 封装的组件&lt;a class="td-heading-self-link" href="#k3s-%e5%b0%81%e8%a3%85%e7%9a%84%e7%bb%84%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;blockquote>
&lt;p>&lt;a href="https://docs.k3s.io/zh/installation/packaged-components">官方文档，安装 - 管理封装的组件&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>K3S 封装了部分非 K8S 核心组件，比如 &lt;code>coredns&lt;/code>、&lt;code>traefik&lt;/code>、&lt;code>local-storage&lt;/code>、&lt;code>metrics-server&lt;/code>、&lt;code>servicelb&lt;/code>。这些组件通常都会以 manifests 文件的方式保存在 &lt;code>/var/lib/rancher/k3s/server/manifests/&lt;/code> 目录中，当 K3S 启动时，自动拉起这些组件。&lt;/p>
&lt;blockquote>
&lt;p>嵌入式 &lt;code>servicelb&lt;/code> LoadBalancer controller 没有 manifests 文件，但由于历史原因，它可以像 &lt;code>AddOn&lt;/code> 一样被禁用&lt;/p>
&lt;/blockquote>
&lt;h1 id="k3s-关联文件与配置">k3s 关联文件与配置&lt;a class="td-heading-self-link" href="#k3s-%e5%85%b3%e8%81%94%e6%96%87%e4%bb%b6%e4%b8%8e%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>&lt;strong>/etc/rancher/k3s/&lt;/strong> # 各种配置存放目录&lt;/p>
&lt;ul>
&lt;li>&lt;strong>./k3s.yaml&lt;/strong> # kubeconfig 文件&lt;/li>
&lt;li>&lt;strong>./config.yaml&lt;/strong> # 运行时配置文件，与环境变量和命令行参数等效。&lt;/li>
&lt;li>&lt;strong>./registries.yaml&lt;/strong> # 镜像仓库配置，可以配置加速、私有仓库。配置方式详见&lt;a href="https://docs.k3s.io/zh/installation/private-registry">官方文档-安装-私有镜像仓库配置&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/run/k3s/&lt;/strong> # K3S 所使用的容器 Runtime 的数据保存路径。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>./containerd/&lt;/strong> # 与 [Containerd](/docs/10.云原生/Containerization%20implementation/Containerd/Containerd.md#Containerd%20关联文件与配置 关联文件与配置&amp;gt;) 中的 /run/containerd/ 目录功能一致。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/run/flannel/&lt;/strong> # 与 [Flannel](/docs/10.云原生/Kubernetes/8.Kubernetes%20网络/CNI/Flannel.md#Flannel%20关联文件与配置%20容器编排系统/8.Kubernetes%20网络/CNI/Flannel#Flannel%20关联文件与配置 容器编排系统/8.Kubernetes 网络/CNI/Flannel.md#Flannel 关联文件与配置 容器编排系统/8.Kubernetes 网络/CNI/Flannel#Flannel 关联文件与配置&amp;gt;) 中 /run/flannel/ 目录功能一致。&lt;/p>
&lt;p>&lt;strong>/var/lib/rancher/k3s/&lt;/strong> # k3s 运行时数据存储保存路径&lt;/p>
&lt;ul>
&lt;li>&lt;strong>./server/&lt;/strong> # 作为 k8s 的 master 节点所需要的信息保存路径
&lt;ul>
&lt;li>包括证书、kube-system 名称空间中的 manifests 文件、etcd 数据 等等都在此处&lt;/li>
&lt;li>&lt;strong>./db/&lt;/strong> # 内嵌 Etcd 数据保存路径&lt;/li>
&lt;li>&lt;strong>./manifests/&lt;/strong> # 功能与 &lt;a href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubelet/Kubelet.md">Kubelet&lt;/a> 管理的 &lt;code>/etc/kubernetes/manifets/&lt;/code> 目录功能一样。k3s 集群启动后，读取该目录下的 manifets 文件以运行 Pod。&lt;/li>
&lt;li>&lt;strong>./tls/&lt;/strong> # Kubernetes 主要组件运行所需证书保存路径&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>./agent/&lt;/strong> # 作为 k8s 的 node 节点所需要的信息保存路径。对于 K3S 来说，master 节点也属于 node 节点，所以 master 节点在该目录也会保存数据。
&lt;ul>
&lt;li>包括证书、containerd 数据目录、cni，containerd 的配置文件 等等都在此处&lt;/li>
&lt;li>&lt;strong>./etc/&lt;/strong> # 各种组件的配置文件保存路径。比如 CNI、Containerd、Flannel 等等，相当于各个组件自己所使用的 etc 目录。&lt;/li>
&lt;li>&lt;strong>./containerd/&lt;/strong> # 与 [Containerd](/docs/10.云原生/Containerization%20implementation/Containerd/Containerd.md#Containerd%20关联文件与配置 关联文件与配置&amp;gt;) 中的 /var/lib/containerd/ 目录功能一致。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>./data/&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>/var/lib/kubelet/&lt;/strong> #&lt;/p>
&lt;p>K3S 所有可能使用的目录可以参考 [清理 K3S](/docs/10.云原生/2.3.Kubernetes%20容器编排系统/Kubernetes%20衍生品/K3S/K3S%20部署与清理.md#清理 K3S)&lt;/p>
&lt;h1 id="进入容器的文件系统">进入容器的文件系统&lt;a class="td-heading-self-link" href="#%e8%bf%9b%e5%85%a5%e5%ae%b9%e5%99%a8%e7%9a%84%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>详见 &lt;a href="https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Containerization%20implementation/%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E7%AE%A1%E7%90%86/%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.md">进入容器文件系统&lt;/a>。在 k3s 中，如果是 containerd 的话，则是在 /run/k3s/containerd/ 目录代替 /run/containerd/ 目录&lt;/p>
&lt;p>`/run/k3s/containerd/io.containerd.runtime.v2.task/k8s.io/${ContainerID}/rootfs/``&lt;/p>
&lt;h1 id="k3s-与-k8s-的区别">K3S 与 K8S 的区别&lt;a class="td-heading-self-link" href="#k3s-%e4%b8%8e-k8s-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/575ZBryg4bv9k01To1QY7w">公众号-边缘计算k3s社区，K3s vs K8s：轻量级和全功能的对决&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote></description></item><item><title>Docs: K3S 部署与清理</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%B8%85%E7%90%86/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.k3s.io/quick-start">官方文档，快速开始指南&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/Qe3oImSUJ1xFCsfXsUMdmA">公众号-CNCF，利用 kube-vip 实现 K3s 高可用部署&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;code>curl -sfL https://get.k3s.io | sh -&lt;/code> 使用该脚本，可以自动创建用于运行 k3s 二进制文件的 service 文件，并通过 systemd 启动。&lt;/p>
&lt;p>注意：&lt;/p>
&lt;ul>
&lt;li>k3s 会自动部署 servicelb 服务，该服务与 kube-proxy 的 ipvs 模式冲突。&lt;/li>
&lt;/ul>
&lt;h1 id="快速部署体验">快速部署体验&lt;a class="td-heading-self-link" href="#%e5%bf%ab%e9%80%9f%e9%83%a8%e7%bd%b2%e4%bd%93%e9%aa%8c" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>获取安装脚本&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>curl -LO http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>第一个 master 执行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_MIRROR&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>cn &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_VERSION&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;v1.20.4+k3s1&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;server --cluster-init&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>bash k3s-install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其余 master 执行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_MIRROR&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>cn &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_VERSION&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;v1.20.4+k3s1&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;server --server https://172.19.42.207:6443&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>bash k3s-install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其余 node 执行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_MIRROR&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>cn &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_VERSION&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;v1.20.4+k3s1&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">K3S_URL&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;https://172.19.42.207:6443&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;agent&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>bash k3s-install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="离线部署高可用集群">离线部署高可用集群&lt;a class="td-heading-self-link" href="#%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%e9%ab%98%e5%8f%af%e7%94%a8%e9%9b%86%e7%be%a4" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>安装脚将会执行如下逻辑：&lt;/p>
&lt;ul>
&lt;li>生成用于 Systemd 的 Unit 文件&lt;/li>
&lt;li>TODO: 待完善&lt;/li>
&lt;/ul>
&lt;h2 id="下载-k3s-二进制文件">下载 k3s 二进制文件&lt;a class="td-heading-self-link" href="#%e4%b8%8b%e8%bd%bd-k3s-%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%96%87%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">K3S_VERSION&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;v1.26.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wget https://github.com/k3s-io/k3s/releases/download/&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">K3S_VERSION&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>%2Bk3s1/k3s -O /usr/local/bin/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chmod +x /usr/local/bin/k3s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="下载安装脚本">下载安装脚本&lt;a class="td-heading-self-link" href="#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e8%84%9a%e6%9c%ac" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>curl -Lo install.sh https://get.k3s.io/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chmod &lt;span style="color:#0000cf;font-weight:bold">755&lt;/span> install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="下载所需镜像">下载所需镜像&lt;a class="td-heading-self-link" href="#%e4%b8%8b%e8%bd%bd%e6%89%80%e9%9c%80%e9%95%9c%e5%83%8f" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">ARCH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wget https://github.com/k3s-io/k3s/releases/download/&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">K3S_VERSION&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>%2Bk3s1/k3s-airgap-images-&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">ARCH&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>.tar.gz
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mkdir -p /var/lib/rancher/k3s/agent/images/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp ./k3s-airgap-images-&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">ARCH&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>.tar /var/lib/rancher/k3s/agent/images/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="mater-节点">mater 节点&lt;a class="td-heading-self-link" href="#mater-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="可选使用-kube-vip-提供-vip">(可选)使用 kube-vip 提供 VIP&lt;a class="td-heading-self-link" href="#%e5%8f%af%e9%80%89%e4%bd%bf%e7%94%a8-kube-vip-%e6%8f%90%e4%be%9b-vip" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kube-vip.io/docs/usage/k3s/">kube-vip 官方文档，K3S&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h3 id="为所有-mater-节点生成配置文件">为所有 mater 节点生成配置文件&lt;a class="td-heading-self-link" href="#%e4%b8%ba%e6%89%80%e6%9c%89-mater-%e8%8a%82%e7%82%b9%e7%94%9f%e6%88%90%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>mkdir -p /etc/rancher/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tee /etc/rancher/k3s/config.yaml &amp;gt; /dev/null &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">service-node-port-range: &amp;#34;30000-40000&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">disable-cloud-controller: true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">disable:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - servicelb
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - traefik
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">kube-controller-manager-arg:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - bind-address=0.0.0.0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">kube-scheduler-arg:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - bind-address=0.0.0.0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">kube-proxy-arg:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - proxy-mode=ipvs
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - masquerade-all=true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"> - metrics-bind-address=0.0.0.0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">etcd-expose-metrics: true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="初始化第一个-master-节点">初始化第一个 master 节点&lt;a class="td-heading-self-link" href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%ac%ac%e4%b8%80%e4%b8%aa-master-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">INSTALL_K3S_SKIP_DOWNLOAD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;server --cluster-init&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./install-zh.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="加入其他-master-节点">加入其他 master 节点&lt;a class="td-heading-self-link" href="#%e5%8a%a0%e5%85%a5%e5%85%b6%e4%bb%96-master-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">INSTALL_K3S_SKIP_DOWNLOAD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;server --server https://172.38.180.216:6443&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./install-zh.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="work-节点">work 节点&lt;a class="td-heading-self-link" href="#work-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="为所有-work-节点生成配置文件">为所有 work 节点生成配置文件&lt;a class="td-heading-self-link" href="#%e4%b8%ba%e6%89%80%e6%9c%89-work-%e8%8a%82%e7%82%b9%e7%94%9f%e6%88%90%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;h3 id="加入-work-节点">加入 work 节点&lt;a class="td-heading-self-link" href="#%e5%8a%a0%e5%85%a5-work-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">INSTALL_K3S_SKIP_DOWNLOAD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">K3S_TOKEN&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>SECRET &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>&lt;span style="color:#000">INSTALL_K3S_EXEC&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;agent --server https://172.38.180.216:6443 &amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./install-zh.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="为所有节点配置通用信息">为所有节点配置通用信息&lt;a class="td-heading-self-link" href="#%e4%b8%ba%e6%89%80%e6%9c%89%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae%e9%80%9a%e7%94%a8%e4%bf%a1%e6%81%af" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> cmd in kubectl crictl ctr&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ln -sf k3s /usr/local/bin/&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">cmd&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置-nerdctl">配置 nerdctl&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae-nerdctl" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>重点是指定 containerd 信息&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>tee /etc/nerdctl/nerdctl.toml &amp;gt; /dev/null &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">address = &amp;#34;unix:///run/k3s/containerd/containerd.sock&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">namespace = &amp;#34;k8s.io&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="systemd-管理的-unit-文件">Systemd 管理的 Unit 文件&lt;a class="td-heading-self-link" href="#systemd-%e7%ae%a1%e7%90%86%e7%9a%84-unit-%e6%96%87%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/systemd/system/k3s.service &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">[Unit]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Description=Lightweight Kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Documentation=https://k3s.io
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Wants=network-online.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">After=network-online.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">[Install]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">WantedBy=multi-user.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">[Service]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Type=notify
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EnvironmentFile=/etc/systemd/system/k3s.service.env
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">KillMode=process
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Delegate=yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"># Having non-zero Limit*s causes performance problems due to accounting overhead
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"># in the kernel. We recommend using cgroups to do container-local accounting.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">LimitNOFILE=1048576
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">LimitNPROC=infinity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">LimitCORE=infinity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">TasksMax=infinity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">TimeoutStartSec=0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">Restart=always
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">RestartSec=5s
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">ExecStartPre=-/sbin/modprobe br_netfilter
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">ExecStartPre=-/sbin/modprobe overlay
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">ExecStart=/usr/local/bin/k3s \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06"># 根据实际情况修改命令行标志。更推荐使用 /etc/rancher/k3s/config.yaml 文件而避免使用 k3s 命令行参数。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>EnvironmentFile&lt;/code> 和 &lt;code>ExecStart&lt;/code> 这两个字段就是用来控制 k3s 运行行为的，其他字段值一般不用修改。&lt;/p>
&lt;ul>
&lt;li>&lt;code>EnvironmentFile&lt;/code> 是 k3s 运行时读取的环境变量信息&lt;/li>
&lt;li>&lt;code>ExecStart&lt;/code> 是 k3s 二进制文件位置，以及运行时标志&lt;/li>
&lt;/ul>
&lt;h1 id="清理-k3s">清理 K3S&lt;a class="td-heading-self-link" href="#%e6%b8%85%e7%90%86-k3s" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>K3S 的清理脚本来自于“安装脚本”中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87">set&lt;/span> -x
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>id -u&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> -eq &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">||&lt;/span> &lt;span style="color:#204a87">exec&lt;/span> sudo &lt;span style="color:#000">$0&lt;/span> &lt;span style="color:#000">$@&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/usr/local/bin/k3s-killall.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#204a87">command&lt;/span> -v systemctl&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> systemctl disable k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> systemctl reset-failed k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#204a87">command&lt;/span> -v rc-update&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rc-update delete k3s default
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -f /etc/systemd/system/k3s.service
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -f /etc/systemd/system/k3s.service.env
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>remove_uninstall&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rm -f /usr/local/bin/k3s-uninstall.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">trap&lt;/span> remove_uninstall EXIT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ls /etc/systemd/system/k3s*.service &lt;span style="color:#ce5c00;font-weight:bold">||&lt;/span> ls /etc/init.d/k3s*&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &amp;gt;/dev/null 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>1&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87">set&lt;/span> +x&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;Additional k3s services installed, skipping uninstall of k3s&amp;#39;&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87">set&lt;/span> -x
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> cmd in kubectl crictl ctr&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> -L /usr/local/bin/&lt;span style="color:#000">$cmd&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rm -f /usr/local/bin/&lt;span style="color:#000">$cmd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /etc/rancher/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /run/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /run/flannel
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /var/lib/rancher/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf /var/lib/kubelet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -f /usr/local/bin/k3s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -f /usr/local/bin/k3s-killall.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#204a87">type&lt;/span> yum &amp;gt;/dev/null 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>1&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> yum remove -y k3s-selinux
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rm -f /etc/yum.repos.d/rancher-k3s-common*.repo
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">elif&lt;/span> &lt;span style="color:#204a87">type&lt;/span> zypper &amp;gt;/dev/null 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>1&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">uninstall_cmd&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;zypper remove -y k3s-selinux&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">TRANSACTIONAL_UPDATE&lt;/span>&lt;span style="color:#000;font-weight:bold">=false&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span> !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> -x /usr/sbin/transactional-update &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">uninstall_cmd&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;transactional-update --no-selfupdate -d run &lt;/span>&lt;span style="color:#000">$uninstall_cmd&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">$uninstall_cmd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rm -f /etc/zypp/repos.d/rancher-k3s-common*.repo
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="ansible-部署-k3s">Ansible 部署 K3S&lt;a class="td-heading-self-link" href="#ansible-%e9%83%a8%e7%bd%b2-k3s" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/techno-tim/k3s-ansible">GitHub 项目，techno-tim/k3s-ansible&lt;/a>
&lt;ul>
&lt;li>起源于：
&lt;ul>
&lt;li>&lt;a href="https://github.com/k3s-io/k3s-ansible">https://github.com/k3s-io/k3s-ansible&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/geerlingguy/turing-pi-cluster">https://github.com/geerlingguy/turing-pi-cluster&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/212850a/k3s-ansible">https://github.com/212850a/k3s-ansible&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>ansible-playbook site.yml -i inventory/my-cluster/hosts.ini&lt;/p>
&lt;h1 id="常见问题">常见问题&lt;a class="td-heading-self-link" href="#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>1.25.7 和 1.26.2 版本的 K3S 使用的 v0.21.1 版本的 Flannel 与旧版 iptables（v1.4.21，比如 centos7~凸(艹皿艹 )） 不兼容 ，需要使用 v0.21.4 Flannel，可以升级到 1.26.3 版本解决。&lt;a href="https://github.com/k3s-io/k3s/issues/7096">issue#7096&lt;/a>&lt;/p></description></item><item><title>Docs: K3S 备份与恢复</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/qpfKuvLvQ8E_pJ2WLpJm7g">公众号-边缘计算k3s社区，容器化应用的救命稻草：深入探索 K3s 备份和恢复&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h1 id="使用嵌入式-etcd-数据存储进行备份和恢复">使用嵌入式 etcd 数据存储进行备份和恢复&lt;a class="td-heading-self-link" href="#%e4%bd%bf%e7%94%a8%e5%b5%8c%e5%85%a5%e5%bc%8f-etcd-%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8%e8%bf%9b%e8%a1%8c%e5%a4%87%e4%bb%bd%e5%92%8c%e6%81%a2%e5%a4%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="创建快照">创建快照&lt;a class="td-heading-self-link" href="#%e5%88%9b%e5%bb%ba%e5%bf%ab%e7%85%a7" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>默认情况下，K3s 会在 00:00 和 12:00 自动创建快照，并保留 5 个快照。当然，你也可以禁用自动快照或者通过 &lt;code>k3s etcd-snapshot save&lt;/code> 来手动创建快照。&lt;/p>
&lt;p>快照目录默认为 &lt;code>${data-dir}/server/db/snapshots&lt;/code>。&lt;code>data-dir&lt;/code> 的默认值为 &lt;code>/var/lib/rancher/k3s&lt;/code>，你可以通过设置 &lt;code>--data-dir&lt;/code> 标志来更改。&lt;/p>
&lt;h2 id="从快照恢复集群">从快照恢复集群&lt;a class="td-heading-self-link" href="#%e4%bb%8e%e5%bf%ab%e7%85%a7%e6%81%a2%e5%a4%8d%e9%9b%86%e7%be%a4" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>当 K3s 从备份中恢复时，旧的数据目录将被移动到 &lt;code>${data-dir}/server/db/etcd-old/&lt;/code>。然后 K3s 将尝试通过创建一个新的数据目录来恢复快照，最后使用具有一个 etcd 成员的新 K3s 集群启动 etcd。&lt;/p>
&lt;p>在此示例中有 3 个 K3s Server 节点，分别是 &lt;code>S1&lt;/code>、&lt;code>S2&lt;/code>和 &lt;code>S3&lt;/code>，快照位于 &lt;code>S1&lt;/code> 上:&lt;/p>
&lt;ol>
&lt;li>在 S1 上，使用 &lt;code>--cluster-reset&lt;/code> 选项运行 K3s，同时指定 &lt;code>--cluster-reset-restore-path&lt;/code>：&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>ls /var/lib/rancher/k3s/server/db/snapshots/
on-demand-ip-172-31-3-36-1688025329
systemctl stop k3s
k3s server \
  --cluster-reset \
  --cluster-reset-restore-path=/var/lib/rancher/k3s/server/db/snapshots/on-demand-ip-172-31-3-36-1688025329
&lt;/code>&lt;/pre>&lt;ol start="2">
&lt;li>在 &lt;code>S2&lt;/code> 和 &lt;code>S3&lt;/code> 上，停止 K3s。然后删除数据目录 &lt;code>/var/lib/rancher/k3s/server/db/&lt;/code>：&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>systemctl stop k3s
rm -rf /var/lib/rancher/k3s/server/db/
&lt;/code>&lt;/pre>&lt;ol start="3">
&lt;li>在 &lt;code>S1&lt;/code> 上，再次启动 K3s：&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>systemctl start k3s
&lt;/code>&lt;/pre>&lt;ol start="4">
&lt;li>&lt;code>S1&lt;/code> 启动成功后，在 &lt;code>S2&lt;/code> 和 &lt;code>S3&lt;/code> 上，再次启动 K3s 以加入恢复后的集群：&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>systemctl start k3s
&lt;/code>&lt;/pre>&lt;p>&lt;code>S2&lt;/code> 和 &lt;code>S3&lt;/code> 虽然使用空的数据目录来启动 K3s 服务，但启动时会自动到 &lt;code>S1&lt;/code> 去同步数据，从而完成 &lt;code>S2&lt;/code> 和 &lt;code>S3&lt;/code> 的恢复。&lt;/p>
&lt;p>另外，&lt;code>k3s etcd-snapshot&lt;/code> 子命令支持 S3 兼容的 API，这样我们可以将快照自动或手动的上传到 S3 中存储，并且用于 K3s 的数据恢复。&lt;/p>
&lt;h1 id="k3s-集群的灾难恢复">K3s 集群的灾难恢复&lt;a class="td-heading-self-link" href="#k3s-%e9%9b%86%e7%be%a4%e7%9a%84%e7%81%be%e9%9a%be%e6%81%a2%e5%a4%8d" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>TODO&lt;/p></description></item><item><title>Docs: K3S 管理</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E7%AE%A1%E7%90%86/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E7%AE%A1%E7%90%86/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.k3s.io/zh/advanced">官方文档，高级选项和配置&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h1 id="使用-etcdctl">使用 etcdctl&lt;a class="td-heading-self-link" href="#%e4%bd%bf%e7%94%a8-etcdctl" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo etcdctl &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --cacert&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --cert&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/var/lib/rancher/k3s/server/tls/etcd/client.crt &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --key&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/var/lib/rancher/k3s/server/tls/etcd/client.key &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --endpoint&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>A,B,C &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> member list
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="更换-master-节点">更换 Master 节点&lt;a class="td-heading-self-link" href="#%e6%9b%b4%e6%8d%a2-master-%e8%8a%82%e7%82%b9" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;p>K3S 可以快速更换所有 Master 节点的系统，只需要剔除一个新增一个，逐一替换即可。就算没有 &lt;code>k3s server --cluster-init&lt;/code> 这种命令的节点也是可以的。&lt;/p>
&lt;h1 id="其他推荐">其他推荐&lt;a class="td-heading-self-link" href="#%e5%85%b6%e4%bb%96%e6%8e%a8%e8%8d%90" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="关于旧版-iptables">关于旧版 iptables&lt;a class="td-heading-self-link" href="#%e5%85%b3%e4%ba%8e%e6%97%a7%e7%89%88-iptables" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h2 id="建议关闭-firewalld">建议关闭 firewalld&lt;a class="td-heading-self-link" href="#%e5%bb%ba%e8%ae%ae%e5%85%b3%e9%97%ad-firewalld" aria-label="Heading self-link">&lt;/a>&lt;/h2></description></item><item><title>Docs: K3S 配置详解</title><link>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://desistdaydream.github.io/docs/10.%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes-%E8%A1%8D%E7%94%9F%E5%93%81/K3S/K3S-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</guid><description>
&lt;h1 id="概述">概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;blockquote>
&lt;p>参考：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.k3s.io/zh/installation/configuration">官方文档，安装-配置选项&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.k3s.io/zh/cli/server">官方文档，CLI 工具-server&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.k3s.io/zh/cli/agent">官方文档，CLI 工具-agent&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>k3s 可以通过如下如下几种方式配置运行时行为&lt;/p>
&lt;ul>
&lt;li>命令行标志&lt;/li>
&lt;li>环境变量&lt;/li>
&lt;li>配置文件
&lt;ul>
&lt;li>k3s 运行时默认读取 &lt;code>/etc/rancher/k3s/config.yaml&lt;/code> 文件中的值。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="配置文件与命令行标志之间的对应关系">配置文件与命令行标志之间的对应关系&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%b8%8e%e5%91%bd%e4%bb%a4%e8%a1%8c%e6%a0%87%e5%bf%97%e4%b9%8b%e9%97%b4%e7%9a%84%e5%af%b9%e5%ba%94%e5%85%b3%e7%b3%bb" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>直接使用 &lt;code>k3s server&lt;/code> 命令并配置如下配置文件：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">write-kubeconfig-mode&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;0644&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">tls-san&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;foo.local&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">node-label&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;foo=bar&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;something=amazing&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">cluster-init&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>等效于：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>k3s server &lt;span style="color:#4e9a06">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--write-kubeconfig-mode &lt;span style="color:#4e9a06">&amp;#34;0644&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--tls-san &lt;span style="color:#4e9a06">&amp;#34;foo.local&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--node-label &lt;span style="color:#4e9a06">&amp;#34;foo=bar&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--node-label &lt;span style="color:#4e9a06">&amp;#34;something=amazing&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--cluster-init
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="其他配置文件说明">其他配置文件说明&lt;a class="td-heading-self-link" href="#%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;strong>一、/etc/rancher/k3s/registries.yaml 文件&lt;/strong>&lt;/p>
&lt;p>k3s 通过 containerd 来控制容器，在 pull 镜像时，会默认指定 docker.io 为 registry 且不可改。&lt;/p>
&lt;p>该配置用于将 docker.io 这个域名解析到指定的 私有镜像仓库地址，这样在使用 &lt;code>crictl pull IMAGE&lt;/code> 时，会去私有镜像仓库拉取镜像。这其中需要指定登录私有镜像仓库的用户名和密码。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">mirrors&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">docker.io&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;http://172.38.40.180:8080&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 这里可以直接使用 https://hub-mirror.c.163.com 等等域名以加速从 DockerHub 下载镜像的速度&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">configs&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;172.38.40.180:8080&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">auth&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">username&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">admin&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">password&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Harbor12345&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以将 docker.io 修改为自己设定的域名，只不过这样需要在 pull 的时候，选择镜像的时候加上这个域名。&lt;/p>
&lt;h1 id="k3s-server-命令行参数详解">k3s server 命令行参数详解&lt;a class="td-heading-self-link" href="#k3s-server-%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%8f%82%e6%95%b0%e8%af%a6%e8%a7%a3" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="常规选项">常规选项&lt;a class="td-heading-self-link" href="#%e5%b8%b8%e8%a7%84%e9%80%89%e9%a1%b9" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="数据库">数据库&lt;a class="td-heading-self-link" href="#%e6%95%b0%e6%8d%ae%e5%ba%93" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>&amp;ndash;datastore-endpoint value&lt;/strong> # 指定 etcd、Mysql、Postgres 或 Sqlite（默认）数据源名称&lt;/p>
&lt;ul>
&lt;li>$K3S_DATASTORE_ENDPOINT&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>&amp;ndash;datastore-cafile value&lt;/strong> # (db) TLS Certificate Authority file used to secure datastore backend communication [$K3S_DATASTORE_CAFILE]&lt;/p>
&lt;p>&lt;strong>&amp;ndash;datastore-certfile value&lt;/strong> # (db) TLS certification file used to secure datastore backend communication [$K3S_DATASTORE_CERTFILE]&lt;/p>
&lt;p>&lt;strong>&amp;ndash;datastore-keyfile value&lt;/strong> # (db) TLS key file used to secure datastore backend communication [$K3S_DATASTORE_KEYFILE]&lt;/p>
&lt;h2 id="高级选项">高级选项&lt;a class="td-heading-self-link" href="#%e9%ab%98%e7%ba%a7%e9%80%89%e9%a1%b9" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h3 id="网络">网络&lt;a class="td-heading-self-link" href="#%e7%bd%91%e7%bb%9c" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>&amp;ndash;cluster-cidr value&lt;/strong> # 用于 pod IP 的 IPv4/IPv6 网络 CIDR。&lt;code>默认值：10.42.0.0/16&lt;/code>&lt;/p>
&lt;p>&lt;strong>&amp;ndash;service-cidr value&lt;/strong> # 用于 service IP 的 IPv4/IPv6 网络 CIDR。&lt;code>默认值：10.43.0.0/16&lt;/code>&lt;/p>
&lt;p>&lt;strong>&amp;ndash;service-node-port-range VALUE&lt;/strong> # 为具有 NodePort 可见性的服务保留的端口范围&lt;/p>
&lt;p>&amp;ndash;cluster-dns value (networking) Cluster IP for coredns service. Should be in your service-cidr range (default: 10.43.0.10)&lt;/p>
&lt;p>&amp;ndash;cluster-domain value (networking) Cluster Domain (default: &amp;ldquo;cluster.local&amp;rdquo;)&lt;/p>
&lt;p>&amp;ndash;flannel-backend value (networking) One of &amp;rsquo;none&amp;rsquo;, &amp;lsquo;vxlan&amp;rsquo;, &amp;lsquo;ipsec&amp;rsquo;, or &amp;lsquo;flannel&amp;rsquo; (default: &amp;ldquo;vxlan&amp;rdquo;)&lt;/p>
&lt;h3 id="定制-kubernetes-的组件">定制 Kubernetes 的组件&lt;a class="td-heading-self-link" href="#%e5%ae%9a%e5%88%b6-kubernetes-%e7%9a%84%e7%bb%84%e4%bb%b6" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>&amp;ndash;disable&lt;/strong>([]STRING) # 禁用 &lt;a href="https://docs.k3s.io/zh/installation/packaged-components">K3S 封装的一些 K8S 之外的组件&lt;/a>。多个组件以 &lt;code>,&lt;/code> 分割。&lt;/p>
&lt;p>&lt;strong>&amp;ndash;disable-scheduler&lt;/strong> # 禁用 Kubernetes 默认调度程序&lt;/p>
&lt;p>&lt;strong>&amp;ndash;disable-cloud-controller&lt;/strong> # 禁用 k3s 默认云 Controller Manager&lt;/p>
&lt;p>&lt;strong>&amp;ndash;disable-kube-proxy&lt;/strong> # 禁用运行 kube-proxy&lt;/p>
&lt;p>&lt;strong>&amp;ndash;disable-network-policy&lt;/strong> # 禁用 K3s 默认网络策略控制器&lt;/p>
&lt;p>&lt;strong>&amp;ndash;disable-helm-controller&lt;/strong> # 禁用 Helm 控制器&lt;/p>
&lt;h3 id="定制-kubernetes-进程的标志">定制 Kubernetes 进程的标志&lt;a class="td-heading-self-link" href="#%e5%ae%9a%e5%88%b6-kubernetes-%e8%bf%9b%e7%a8%8b%e7%9a%84%e6%a0%87%e5%bf%97" aria-label="Heading self-link">&lt;/a>&lt;/h3>
&lt;p>&lt;strong>&amp;ndash;etcd-arg value&lt;/strong> # etcd 进程的运行时 Flags&lt;/p>
&lt;p>&lt;strong>&amp;ndash;kubelet-arg value&lt;/strong> # 指定 kubelet 的运行时 Flags。&lt;/p>
&lt;ul>
&lt;li>比如 k3s server &amp;ndash;docker &amp;ndash;kubelet-arg cgroup-driver=systemd&lt;/li>
&lt;li>Note：在指定 kubelet 参数时，不用加 &amp;ndash; ，k3s 会自动添加。如果加了&amp;ndash; ，那么就会变成 &amp;mdash;-cgroup-driver=systemd。这样 kubelet 是无法启动的。&lt;/li>
&lt;li>上面仅仅举个例子，k3s 内嵌的 kubelet 不支持 systemd 类型的 cgroup-driver&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>&amp;ndash;kube-apiserver-arg VALUE&lt;/strong> # 自定义 kube-apiserver 进程的命令行 Flags。&lt;/p>
&lt;p>&lt;strong>&amp;ndash;kube-controller-manager-arg value&lt;/strong> # 自定义 kube-controller-manager 进程的命令行 Flags。&lt;/p>
&lt;p>&lt;strong>&amp;ndash;kube-scheduler-arg value&lt;/strong> # (自定义 kube-scheduler 进程的命令行 Flags。&lt;/p>
&lt;p>&lt;strong>&amp;ndash;kube-proxy-arg value&lt;/strong> # kube-proxy 进程的运行时 Flags&lt;/p>
&lt;p>&amp;ndash;kube-cloud-controller-manager-arg value (flags) Customized flag for kube-cloud-controller-manager process&lt;/p>
&lt;h2 id="实验选项">实验选项&lt;a class="td-heading-self-link" href="#%e5%ae%9e%e9%aa%8c%e9%80%89%e9%a1%b9" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>&lt;strong>&amp;ndash;docker&lt;/strong> # 指定 k3s 的 CRI 为 docker。默认为 containerd。&lt;/p>
&lt;h2 id="其他">其他&lt;a class="td-heading-self-link" href="#%e5%85%b6%e4%bb%96" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;h1 id="最佳实践">最佳实践&lt;a class="td-heading-self-link" href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="Heading self-link">&lt;/a>&lt;/h1>
&lt;h2 id="为-prometheus-提供-k8s-组件的监控指标">为 Prometheus 提供 K8S 组件的监控指标&lt;a class="td-heading-self-link" href="#%e4%b8%ba-prometheus-%e6%8f%90%e4%be%9b-k8s-%e7%bb%84%e4%bb%b6%e7%9a%84%e7%9b%91%e6%8e%a7%e6%8c%87%e6%a0%87" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;p>参考：&lt;a href="https://github.com/k3s-io/k3s/issues/3619#issuecomment-973188304">https://github.com/k3s-io/k3s/issues/3619#issuecomment-973188304&lt;/a>&lt;/p>
&lt;p>以 kube-prometheus-stack 部署的 Prometheus 套件为例，修改 Helm 的 Value 文件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">kubeApiServer&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kubeControllerManager&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoints&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.10&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.12&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kubeScheduler&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoints&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.10&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.12&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kubeProxy&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoints&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.10&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.12&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kubeEtcd&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoints&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.10&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.11&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#0000cf;font-weight:bold">192.168.42.12&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">enabled&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">port&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2381&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">targetPort&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2381&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在 K3S 的配置文件中添加如下内容：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">kube-controller-manager-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;bind-address=0.0.0.0&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kube-scheduler-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;bind-address=0.0.0.0&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kube-proxy-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>- &lt;span style="color:#4e9a06">&amp;#34;metrics-bind-address=0.0.0.0&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">etcd-expose-metrics&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="个人推荐配置">个人推荐配置&lt;a class="td-heading-self-link" href="#%e4%b8%aa%e4%ba%ba%e6%8e%a8%e8%8d%90%e9%85%8d%e7%bd%ae" aria-label="Heading self-link">&lt;/a>&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">service-node-port-range&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;30000-40000&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">disable-cloud-controller&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">disable&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">servicelb&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">traefik&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kube-controller-manager-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">bind-address=0.0.0.0&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kube-scheduler-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">bind-address=0.0.0.0&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kube-proxy-arg&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">proxy-mode=ipvs&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">masquerade-all=true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#000">metrics-bind-address=0.0.0.0&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">etcd-expose-metrics&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>